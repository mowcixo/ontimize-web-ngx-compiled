import { OFormValue } from '../components/form/OFormValue';
import { Codes } from './codes';
import { SQLTypes } from './sqltypes';
import { Util } from './util';
var ServiceUtils = (function () {
    function ServiceUtils() {
    }
    ServiceUtils.getParentKeysFromForm = function (parentKeysObject, form) {
        var result = {};
        var ownKeys = Object.keys(parentKeysObject || {});
        var formComponents = form ? form.getComponents() : {};
        var existsComponents = Object.keys(formComponents).length > 0;
        var formDataProperties = form ? form.getDataValues() : {};
        var existsProperties = Object.keys(formDataProperties).length > 0;
        var urlData = form ? form.getFormNavigation().getFilterFromUrlParams() : {};
        var existsUrlData = Object.keys(urlData).length > 0;
        if (existsUrlData) {
            form.keysArray.forEach(function (key, i) {
                if (urlData.hasOwnProperty(key)) {
                    urlData[key] = SQLTypes.parseUsingSQLType(urlData[key], form.keysSqlTypesArray[i]);
                }
            });
        }
        if (existsComponents || existsProperties || existsUrlData) {
            ownKeys.forEach(function (ownKey) {
                var keyValue = parentKeysObject[ownKey];
                var isEquivObject = Util.isObject(keyValue);
                var formFieldAttr = isEquivObject ? Object.keys(keyValue)[0] : keyValue;
                var currentData;
                if (formComponents.hasOwnProperty(formFieldAttr)) {
                    var component = formComponents[formFieldAttr];
                    if ('getSelectedRecord' in component && isEquivObject) {
                        currentData = (component.getSelectedRecord() || {})[keyValue[formFieldAttr]];
                    }
                    else {
                        currentData = component.getValue();
                    }
                }
                else if (formDataProperties.hasOwnProperty(formFieldAttr)) {
                    var formPropValue = formDataProperties[formFieldAttr];
                    currentData = formPropValue instanceof OFormValue ? formPropValue.value : formPropValue;
                }
                else if (urlData.hasOwnProperty(formFieldAttr)) {
                    currentData = urlData[formFieldAttr];
                }
                if (Util.isDefined(currentData)) {
                    switch (typeof (currentData)) {
                        case 'string':
                            if (currentData.trim().length > 0) {
                                result[ownKey] = currentData.trim();
                            }
                            break;
                        case 'number':
                            if (!isNaN(currentData)) {
                                result[ownKey] = currentData;
                            }
                            break;
                    }
                }
            });
        }
        return result;
    };
    ServiceUtils.filterContainsAllParentKeys = function (parentKeysFilter, parentKeys) {
        var pkKeys = Object.keys(parentKeys);
        if ((pkKeys.length > 0) && Util.isDefined(parentKeysFilter)) {
            var parentKeysFilterKeys_1 = Object.keys(parentKeysFilter);
            return pkKeys.every(function (a) { return parentKeysFilterKeys_1.indexOf(a) !== -1; });
        }
        return true;
    };
    ServiceUtils.getFilterUsingParentKeys = function (parentItem, parentKeysObject) {
        var filter = {};
        var ownKeys = Object.keys(parentKeysObject);
        if (ownKeys.length > 0 && Util.isDefined(parentItem)) {
            ownKeys.forEach(function (ownKey) {
                var parentKey = parentKeysObject[ownKey];
                if (parentItem.hasOwnProperty(parentKey)) {
                    var currentData = parentItem[parentKey];
                    if (currentData instanceof OFormValue) {
                        currentData = currentData.value;
                    }
                    filter[ownKey] = currentData;
                }
            });
        }
        return filter;
    };
    ServiceUtils.getArrayProperties = function (array, properties) {
        var result = array.map(function (item) {
            return ServiceUtils.getObjectProperties(item, properties);
        });
        return result;
    };
    ServiceUtils.getObjectProperties = function (object, properties) {
        var objectProperties = {};
        properties.forEach(function (key) {
            objectProperties[key] = object[key];
        });
        return objectProperties;
    };
    ServiceUtils.parseSortColumns = function (sortColumns) {
        var sortColArray = [];
        if (sortColumns) {
            var cols = Util.parseArray(sortColumns);
            cols.forEach(function (col) {
                var colDef = col.split(Codes.TYPE_SEPARATOR);
                if (colDef.length > 0) {
                    var colName = colDef[0];
                    var colSort = colDef[1] || Codes.ASC_SORT;
                    sortColArray.push({
                        columnName: colName,
                        ascendent: colSort === Codes.ASC_SORT
                    });
                }
            });
        }
        return sortColArray;
    };
    ServiceUtils.redirectLogin = function (router, sessionExpired) {
        if (sessionExpired === void 0) { sessionExpired = false; }
        var arg = {};
        arg[Codes.SESSION_EXPIRED_KEY] = sessionExpired;
        var extras = {};
        extras[Codes.QUERY_PARAMS] = arg;
        router.navigate([Codes.LOGIN_ROUTE], extras);
    };
    return ServiceUtils;
}());
export { ServiceUtils };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS51dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvdXRpbC9zZXJ2aWNlLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUU5QjtJQUFBO0lBbUlBLENBQUM7SUFqSVEsa0NBQXFCLEdBQTVCLFVBQTZCLGdCQUF3QixFQUFFLElBQW9CO1FBQ3pFLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixJQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXBELElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDeEQsSUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFaEUsSUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzVELElBQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFcEUsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFF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Q0o7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRU0sMEJBQWEsR0FBcEIsVUFBcUIsTUFBYyxFQUFFLGNBQStCO1FBQS9CLCtCQUFBLEVBQUEsc0JBQStCO1FBQ2xFLElBQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNmLEdBQUcsQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsR0FBRyxjQUFjLENBQUM7UUFDaEQsSUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVILG1CQUFDO0FBQUQsQ0FBQyxBQW5JRCxJQW1JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IE9Gb3JtQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtL28tZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHsgT0Zvcm1WYWx1ZSB9IGZyb20gJy4uL2NvbXBvbmVudHMvZm9ybS9PRm9ybVZhbHVlJztcbmltcG9ydCB7IFNRTE9yZGVyIH0gZnJvbSAnLi4vdHlwZXMvc3FsLW9yZGVyLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuL2NvZGVzJztcbmltcG9ydCB7IFNRTFR5cGVzIH0gZnJvbSAnLi9zcWx0eXBlcyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IGNsYXNzIFNlcnZpY2VVdGlscyB7XG5cbiAgc3RhdGljIGdldFBhcmVudEtleXNGcm9tRm9ybShwYXJlbnRLZXlzT2JqZWN0OiBvYmplY3QsIGZvcm06IE9Gb3JtQ29tcG9uZW50KSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgb3duS2V5cyA9IE9iamVjdC5rZXlzKHBhcmVudEtleXNPYmplY3QgfHwge30pO1xuXG4gICAgY29uc3QgZm9ybUNvbXBvbmVudHMgPSBmb3JtID8gZm9ybS5nZXRDb21wb25lbnRzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNDb21wb25lbnRzID0gT2JqZWN0LmtleXMoZm9ybUNvbXBvbmVudHMpLmxlbmd0aCA+IDA7XG5cbiAgICBjb25zdCBmb3JtRGF0YVByb3BlcnRpZXMgPSBmb3JtID8gZm9ybS5nZXREYXRhVmFsdWVzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNQcm9wZXJ0aWVzID0gT2JqZWN0LmtleXMoZm9ybURhdGFQcm9wZXJ0aWVzKS5sZW5ndGggPiAwO1xuXG4gICAgY29uc3QgdXJsRGF0YSA9IGZvcm0gPyBmb3JtLmdldEZvcm1OYXZpZ2F0aW9uKCkuZ2V0RmlsdGVyRnJvbVVybFBhcmFtcygpIDoge307XG4gICAgY29uc3QgZXhpc3RzVXJsRGF0YSA9IE9iamVjdC5rZXlzKHVybERhdGEpLmxlbmd0aCA+IDA7XG4gICAgaWYgKGV4aXN0c1VybERhdGEpIHtcbiAgICAgIGZvcm0ua2V5c0FycmF5LmZvckVhY2goKGtleTogc3RyaW5nLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIHVybERhdGFba2V5XSA9IFNRTFR5cGVzLnBhcnNlVXNpbmdTUUxUeXBlKHVybERhdGFba2V5XSwgZm9ybS5rZXlzU3FsVHlwZXNBcnJheVtpXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChleGlzdHNDb21wb25lbnRzIHx8IGV4aXN0c1Byb3BlcnRpZXMgfHwgZXhpc3RzVXJsRGF0YSkge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICAvLyBQYXJlbnQga2V5IGVxdWl2YWxlbmNlIG1heSBiZSBhbiBvYmplY3RcbiAgICAgICAgY29uc3QgaXNFcXVpdk9iamVjdCA9IFV0aWwuaXNPYmplY3Qoa2V5VmFsdWUpO1xuICAgICAgICBjb25zdCBmb3JtRmllbGRBdHRyID0gaXNFcXVpdk9iamVjdCA/IE9iamVjdC5rZXlzKGtleVZhbHVlKVswXSA6IGtleVZhbHVlO1xuICAgICAgICBsZXQgY3VycmVudERhdGE7XG4gICAgICAgIGlmIChmb3JtQ29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGZvcm1Db21wb25lbnRzW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICAgIC8vIElzIHNlcnZpY2UgY29tcG9uZW50IChjb21ibywgbGlzdHBpY2tlciwgcmFkaW8pXG4gICAgICAgICAgaWYgKCdnZXRTZWxlY3RlZFJlY29yZCcgaW4gY29tcG9uZW50ICYmIGlzRXF1aXZPYmplY3QpIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gKChjb21wb25lbnQgYXMgYW55KS5nZXRTZWxlY3RlZFJlY29yZCgpIHx8IHt9KVtrZXlWYWx1ZVtmb3JtRmllbGRBdHRyXV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gY29tcG9uZW50LmdldFZhbHVlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGZvcm1EYXRhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGZvcm1Qcm9wVmFsdWUgPSBmb3JtRGF0YVByb3BlcnRpZXNbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgICAgY3VycmVudERhdGEgPSBmb3JtUHJvcFZhbHVlIGluc3RhbmNlb2YgT0Zvcm1WYWx1ZSA/IGZvcm1Qcm9wVmFsdWUudmFsdWUgOiBmb3JtUHJvcFZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjdXJyZW50RGF0YSA9IHVybERhdGFbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFV0aWwuaXNEZWZpbmVkKGN1cnJlbnREYXRhKSkge1xuICAgICAgICAgIHN3aXRjaCAodHlwZW9mIChjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICAgIGlmIChjdXJyZW50RGF0YS50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdFtvd25LZXldID0gY3VycmVudERhdGEudHJpbSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgICAgaWYgKCFpc05hTihjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRbb3duS2V5XSA9IGN1cnJlbnREYXRhO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgZmlsdGVyQ29udGFpbnNBbGxQYXJlbnRLZXlzKHBhcmVudEtleXNGaWx0ZXIsIHBhcmVudEtleXMpOiBib29sZWFuIHtcbiAgICBjb25zdCBwa0tleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzKTtcbiAgICBpZiAoKHBrS2V5cy5sZW5ndGggPiAwKSAmJiBVdGlsLmlzRGVmaW5lZChwYXJlbnRLZXlzRmlsdGVyKSkge1xuICAgICAgY29uc3QgcGFyZW50S2V5c0ZpbHRlcktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzRmlsdGVyKTtcbiAgICAgIHJldHVybiBwa0tleXMuZXZlcnkoYSA9PiBwYXJlbnRLZXlzRmlsdGVyS2V5cy5pbmRleE9mKGEpICE9PSAtMSk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgc3RhdGljIGdldEZpbHRlclVzaW5nUGFyZW50S2V5cyhwYXJlbnRJdGVtOiBhbnksIHBhcmVudEtleXNPYmplY3Q6IG9iamVjdCkge1xuICAgIGNvbnN0IGZpbHRlciA9IHt9O1xuICAgIGNvbnN0IG93bktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzT2JqZWN0KTtcbiAgICBpZiAob3duS2V5cy5sZW5ndGggPiAwICYmIFV0aWwuaXNEZWZpbmVkKHBhcmVudEl0ZW0pKSB7XG4gICAgICBvd25LZXlzLmZvckVhY2gob3duS2V5ID0+IHtcbiAgICAgICAgY29uc3QgcGFyZW50S2V5ID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICBpZiAocGFyZW50SXRlbS5oYXNPd25Qcm9wZXJ0eShwYXJlbnRLZXkpKSB7XG4gICAgICAgICAgbGV0IGN1cnJlbnREYXRhID0gcGFyZW50SXRlbVtwYXJlbnRLZXldO1xuICAgICAgICAgIGlmIChjdXJyZW50RGF0YSBpbnN0YW5jZW9mIE9Gb3JtVmFsdWUpIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gY3VycmVudERhdGEudmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZpbHRlcltvd25LZXldID0gY3VycmVudERhdGE7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyO1xuICB9XG5cbiAgc3RhdGljIGdldEFycmF5UHJvcGVydGllcyhhcnJheTogYW55W10sIHByb3BlcnRpZXM6IGFueVtdKTogYW55W10ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGFycmF5Lm1hcChpdGVtID0+IHtcbiAgICAgIHJldHVybiBTZXJ2aWNlVXRpbHMuZ2V0T2JqZWN0UHJvcGVydGllcyhpdGVtLCBwcm9wZXJ0aWVzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIGdldE9iamVjdFByb3BlcnRpZXMob2JqZWN0OiBhbnksIHByb3BlcnRpZXM6IGFueVtdKTogYW55IHtcbiAgICBjb25zdCBvYmplY3RQcm9wZXJ0aWVzID0ge307XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBvYmplY3RQcm9wZXJ0aWVzW2tleV0gPSBvYmplY3Rba2V5XTtcbiAgICB9KTtcbiAgICByZXR1cm4gb2JqZWN0UHJvcGVydGllcztcbiAgfVxuXG4gIHN0YXRpYyBwYXJzZVNvcnRDb2x1bW5zKHNvcnRDb2x1bW5zOiBzdHJpbmcpOiBBcnJheTxTUUxPcmRlcj4ge1xuICAgIGNvbnN0IHNvcnRDb2xBcnJheSA9IFtdO1xuICAgIGlmIChzb3J0Q29sdW1ucykge1xuICAgICAgY29uc3QgY29scyA9IFV0aWwucGFyc2VBcnJheShzb3J0Q29sdW1ucyk7XG4gICAgICBjb2xzLmZvckVhY2goY29sID0+IHtcbiAgICAgICAgY29uc3QgY29sRGVmID0gY29sLnNwbGl0KENvZGVzLlRZUEVfU0VQQVJBVE9SKTtcbiAgICAgICAgaWYgKGNvbERlZi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgY29sTmFtZSA9IGNvbERlZlswXTtcbiAgICAgICAgICBjb25zdCBjb2xTb3J0ID0gY29sRGVmWzFdIHx8IENvZGVzLkFTQ19TT1JUO1xuICAgICAgICAgIHNvcnRDb2xBcnJheS5wdXNoKHtcbiAgICAgICAgICAgIGNvbHVtbk5hbWU6IGNvbE5hbWUsXG4gICAgICAgICAgICBhc2NlbmRlbnQ6IGNvbFNvcnQgPT09IENvZGVzLkFTQ19TT1JUXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc29ydENvbEFycmF5O1xuICB9XG5cbiAgc3RhdGljIHJlZGlyZWN0TG9naW4ocm91dGVyOiBSb3V0ZXIsIHNlc3Npb25FeHBpcmVkOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBjb25zdCBhcmcgPSB7fTtcbiAgICBhcmdbQ29kZXMuU0VTU0lPTl9FWFBJUkVEX0tFWV0gPSBzZXNzaW9uRXhwaXJlZDtcbiAgICBjb25zdCBleHRyYXMgPSB7fTtcbiAgICBleHRyYXNbQ29kZXMuUVVFUllfUEFSQU1TXSA9IGFyZztcbiAgICByb3V0ZXIubmF2aWdhdGUoW0NvZGVzLkxPR0lOX1JPVVRFXSwgZXh0cmFzKTtcbiAgfVxuXG59XG4iXX0=