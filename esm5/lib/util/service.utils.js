import { OFormValue } from '../components/form/OFormValue';
import { Codes } from './codes';
import { SQLTypes } from './sqltypes';
import { Util } from './util';
var ServiceUtils = (function () {
    function ServiceUtils() {
    }
    ServiceUtils.getParentKeysFromExpandableContainer = function (parentKeysObject, expandableContainer) {
        var result = {};
        var ownKeys = Object.keys(parentKeysObject || {});
        var dataComponent = expandableContainer ? expandableContainer.data : {};
        var existsData = Object.keys(dataComponent).length > 0;
        if (existsData) {
            ownKeys.forEach(function (ownKey) {
                var keyValue = parentKeysObject[ownKey];
                if (dataComponent.hasOwnProperty(keyValue)) {
                    var value = dataComponent[keyValue];
                    if (Util.isDefined(value)) {
                        switch (typeof (value)) {
                            case 'string':
                                if (value.trim().length > 0) {
                                    result[ownKey] = value.trim();
                                }
                                break;
                            case 'number':
                                if (!isNaN(value)) {
                                    result[ownKey] = value;
                                }
                                break;
                        }
                    }
                }
            });
        }
        return result;
    };
    ServiceUtils.getParentKeysFromForm = function (parentKeysObject, form) {
        var result = {};
        var ownKeys = Object.keys(parentKeysObject || {});
        var formComponents = form ? form.getComponents() : {};
        var existsComponents = Object.keys(formComponents).length > 0;
        var formDataProperties = form ? form.getDataValues() : {};
        var existsProperties = Object.keys(formDataProperties).length > 0;
        var urlData = form ? form.getFormNavigation().getFilterFromUrlParams() : {};
        var existsUrlData = Object.keys(urlData).length > 0;
        if (existsUrlData) {
            form.keysArray.forEach(function (key, i) {
                if (urlData.hasOwnProperty(key)) {
                    urlData[key] = SQLTypes.parseUsingSQLType(urlData[key], form.keysSqlTypesArray[i]);
                }
            });
        }
        if (existsComponents || existsProperties || existsUrlData) {
            ownKeys.forEach(function (ownKey) {
                var keyValue = parentKeysObject[ownKey];
                var isEquivObject = Util.isObject(keyValue);
                var formFieldAttr = isEquivObject ? Object.keys(keyValue)[0] : keyValue;
                var currentData;
                if (formComponents.hasOwnProperty(formFieldAttr)) {
                    var component = formComponents[formFieldAttr];
                    if ('getSelectedRecord' in component && isEquivObject) {
                        currentData = (component.getSelectedRecord() || {})[keyValue[formFieldAttr]];
                    }
                    else {
                        currentData = component.getValue();
                    }
                }
                else if (formDataProperties.hasOwnProperty(formFieldAttr)) {
                    var formPropValue = formDataProperties[formFieldAttr];
                    currentData = formPropValue instanceof OFormValue ? formPropValue.value : formPropValue;
                }
                else if (urlData.hasOwnProperty(formFieldAttr)) {
                    currentData = urlData[formFieldAttr];
                }
                if (Util.isDefined(currentData)) {
                    switch (typeof (currentData)) {
                        case 'string':
                            if (currentData.trim().length > 0) {
                                result[ownKey] = currentData.trim();
                            }
                            break;
                        case 'number':
                            if (!isNaN(currentData)) {
                                result[ownKey] = currentData;
                            }
                            break;
                    }
                }
            });
        }
        return result;
    };
    ServiceUtils.filterContainsAllParentKeys = function (parentKeysFilter, parentKeys) {
        var pkKeys = Object.keys(parentKeys);
        if ((pkKeys.length > 0) && Util.isDefined(parentKeysFilter)) {
            var parentKeysFilterKeys_1 = Object.keys(parentKeysFilter);
            return pkKeys.every(function (a) { return parentKeysFilterKeys_1.indexOf(a) !== -1; });
        }
        return true;
    };
    ServiceUtils.getFilterUsingParentKeys = function (parentItem, parentKeysObject) {
        var filter = {};
        var ownKeys = Object.keys(parentKeysObject);
        if (ownKeys.length > 0 && Util.isDefined(parentItem)) {
            ownKeys.forEach(function (ownKey) {
                var parentKey = parentKeysObject[ownKey];
                if (parentItem.hasOwnProperty(parentKey)) {
                    var currentData = parentItem[parentKey];
                    if (currentData instanceof OFormValue) {
                        currentData = currentData.value;
                    }
                    filter[ownKey] = currentData;
                }
            });
        }
        return filter;
    };
    ServiceUtils.getArrayProperties = function (array, properties) {
        var result = array.map(function (item) {
            return ServiceUtils.getObjectProperties(item, properties);
        });
        return result;
    };
    ServiceUtils.getObjectProperties = function (object, properties) {
        var objectProperties = {};
        properties.forEach(function (key) {
            objectProperties[key] = object[key];
        });
        return objectProperties;
    };
    ServiceUtils.parseSortColumns = function (sortColumns) {
        var sortColArray = [];
        if (sortColumns) {
            var cols = Util.parseArray(sortColumns);
            cols.forEach(function (col) {
                var colDef = col.split(Codes.TYPE_SEPARATOR);
                if (colDef.length > 0) {
                    var colName = colDef[0];
                    var colSort = colDef[1] || Codes.ASC_SORT;
                    sortColArray.push({
                        columnName: colName,
                        ascendent: colSort === Codes.ASC_SORT
                    });
                }
            });
        }
        return sortColArray;
    };
    ServiceUtils.redirectLogin = function (router, sessionExpired) {
        if (sessionExpired === void 0) { sessionExpired = false; }
        var arg = {};
        arg[Codes.SESSION_EXPIRED_KEY] = sessionExpired;
        var extras = {};
        extras[Codes.QUERY_PARAMS] = arg;
        router.navigate([Codes.LOGIN_ROUTE], extras);
    };
    return ServiceUtils;
}());
export { ServiceUtils };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS51dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvdXRpbC9zZXJ2aWNlLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUc5QjtJQUFBO0lBa0tBLENBQUM7SUFqS1EsaURBQW9DLEdBQTNDLFVBQTRDLGdCQUF3QixFQUFFLG1CQUFrRDtRQUN0SCxJQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNwRCxJQUFNLGFBQWEsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDMUUsSUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBR3pELElBQUksVUFBVSxFQUFFO1lBQ2QsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE1BQU07Z0JBQ3BCLElBQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQzFDLElBQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDdEMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO3dCQUN6QixRQUFRLE9BQU8sQ0FBQyxL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Q0o7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVNLDBCQUFhLEdBQXBCLFVBQXFCLE1BQWMsRUFBRSxjQUErQjtRQUEvQiwrQkFBQSxFQUFBLHNCQUErQjtRQUNsRSxJQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixHQUFHLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsY0FBYyxDQUFDO1FBQ2hELElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNqQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFSCxtQkFBQztBQUFELENBQUMsQUFsS0QsSUFrS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBPRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvZm9ybS9vLWZvcm0uY29tcG9uZW50JztcbmltcG9ydCB7IE9Gb3JtVmFsdWUgfSBmcm9tICcuLi9jb21wb25lbnRzL2Zvcm0vT0Zvcm1WYWx1ZSc7XG5pbXBvcnQgeyBTUUxPcmRlciB9IGZyb20gJy4uL3R5cGVzL3NxbC1vcmRlci50eXBlJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi9jb2Rlcyc7XG5pbXBvcnQgeyBTUUxUeXBlcyB9IGZyb20gJy4vc3FsdHlwZXMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBPRXhwYW5kYWJsZUNvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvZXhwYW5kYWJsZS1jb250YWluZXIvby1leHBhbmRhYmxlLWNvbnRhaW5lci5jb21wb25lbnQnO1xuXG5leHBvcnQgY2xhc3MgU2VydmljZVV0aWxzIHtcbiAgc3RhdGljIGdldFBhcmVudEtleXNGcm9tRXhwYW5kYWJsZUNvbnRhaW5lcihwYXJlbnRLZXlzT2JqZWN0OiBvYmplY3QsIGV4cGFuZGFibGVDb250YWluZXI6IE9FeHBhbmRhYmxlQ29udGFpbmVyQ29tcG9uZW50KToge30ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IG93bktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzT2JqZWN0IHx8IHt9KTtcbiAgICBjb25zdCBkYXRhQ29tcG9uZW50ID0gZXhwYW5kYWJsZUNvbnRhaW5lciA/IGV4cGFuZGFibGVDb250YWluZXIuZGF0YSA6IHt9O1xuICAgIGNvbnN0IGV4aXN0c0RhdGEgPSBPYmplY3Qua2V5cyhkYXRhQ29tcG9uZW50KS5sZW5ndGggPiAwO1xuXG5cbiAgICBpZiAoZXhpc3RzRGF0YSkge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICBpZiAoZGF0YUNvbXBvbmVudC5oYXNPd25Qcm9wZXJ0eShrZXlWYWx1ZSkpIHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGRhdGFDb21wb25lbnRba2V5VmFsdWVdO1xuICAgICAgICAgIGlmIChVdGlsLmlzRGVmaW5lZCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mICh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdFtvd25LZXldID0gdmFsdWUudHJpbSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0W293bktleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRQYXJlbnRLZXlzRnJvbUZvcm0ocGFyZW50S2V5c09iamVjdDogb2JqZWN0LCBmb3JtOiBPRm9ybUNvbXBvbmVudCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IG93bktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzT2JqZWN0IHx8IHt9KTtcblxuICAgIGNvbnN0IGZvcm1Db21wb25lbnRzID0gZm9ybSA/IGZvcm0uZ2V0Q29tcG9uZW50cygpIDoge307XG4gICAgY29uc3QgZXhpc3RzQ29tcG9uZW50cyA9IE9iamVjdC5rZXlzKGZvcm1Db21wb25lbnRzKS5sZW5ndGggPiAwO1xuXG4gICAgY29uc3QgZm9ybURhdGFQcm9wZXJ0aWVzID0gZm9ybSA/IGZvcm0uZ2V0RGF0YVZhbHVlcygpIDoge307XG4gICAgY29uc3QgZXhpc3RzUHJvcGVydGllcyA9IE9iamVjdC5rZXlzKGZvcm1EYXRhUHJvcGVydGllcykubGVuZ3RoID4gMDtcblxuICAgIGNvbnN0IHVybERhdGEgPSBmb3JtID8gZm9ybS5nZXRGb3JtTmF2aWdhdGlvbigpLmdldEZpbHRlckZyb21VcmxQYXJhbXMoKSA6IHt9O1xuICAgIGNvbnN0IGV4aXN0c1VybERhdGEgPSBPYmplY3Qua2V5cyh1cmxEYXRhKS5sZW5ndGggPiAwO1xuICAgIGlmIChleGlzdHNVcmxEYXRhKSB7XG4gICAgICBmb3JtLmtleXNBcnJheS5mb3JFYWNoKChrZXk6IHN0cmluZywgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmICh1cmxEYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICB1cmxEYXRhW2tleV0gPSBTUUxUeXBlcy5wYXJzZVVzaW5nU1FMVHlwZSh1cmxEYXRhW2tleV0sIGZvcm0ua2V5c1NxbFR5cGVzQXJyYXlbaV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZXhpc3RzQ29tcG9uZW50cyB8fCBleGlzdHNQcm9wZXJ0aWVzIHx8IGV4aXN0c1VybERhdGEpIHtcbiAgICAgIG93bktleXMuZm9yRWFjaChvd25LZXkgPT4ge1xuICAgICAgICBjb25zdCBrZXlWYWx1ZSA9IHBhcmVudEtleXNPYmplY3Rbb3duS2V5XTtcbiAgICAgICAgLy8gUGFyZW50IGtleSBlcXVpdmFsZW5jZSBtYXkgYmUgYW4gb2JqZWN0XG4gICAgICAgIGNvbnN0IGlzRXF1aXZPYmplY3QgPSBVdGlsLmlzT2JqZWN0KGtleVZhbHVlKTtcbiAgICAgICAgY29uc3QgZm9ybUZpZWxkQXR0ciA9IGlzRXF1aXZPYmplY3QgPyBPYmplY3Qua2V5cyhrZXlWYWx1ZSlbMF0gOiBrZXlWYWx1ZTtcbiAgICAgICAgbGV0IGN1cnJlbnREYXRhO1xuICAgICAgICBpZiAoZm9ybUNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnQgPSBmb3JtQ29tcG9uZW50c1tmb3JtRmllbGRBdHRyXTtcbiAgICAgICAgICAvLyBJcyBzZXJ2aWNlIGNvbXBvbmVudCAoY29tYm8sIGxpc3RwaWNrZXIsIHJhZGlvKVxuICAgICAgICAgIGlmICgnZ2V0U2VsZWN0ZWRSZWNvcmQnIGluIGNvbXBvbmVudCAmJiBpc0VxdWl2T2JqZWN0KSB7XG4gICAgICAgICAgICBjdXJyZW50RGF0YSA9ICgoY29tcG9uZW50IGFzIGFueSkuZ2V0U2VsZWN0ZWRSZWNvcmQoKSB8fCB7fSlba2V5VmFsdWVbZm9ybUZpZWxkQXR0cl1dO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50RGF0YSA9IGNvbXBvbmVudC5nZXRWYWx1ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChmb3JtRGF0YVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjb25zdCBmb3JtUHJvcFZhbHVlID0gZm9ybURhdGFQcm9wZXJ0aWVzW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICAgIGN1cnJlbnREYXRhID0gZm9ybVByb3BWYWx1ZSBpbnN0YW5jZW9mIE9Gb3JtVmFsdWUgPyBmb3JtUHJvcFZhbHVlLnZhbHVlIDogZm9ybVByb3BWYWx1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh1cmxEYXRhLmhhc093blByb3BlcnR5KGZvcm1GaWVsZEF0dHIpKSB7XG4gICAgICAgICAgY3VycmVudERhdGEgPSB1cmxEYXRhW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChVdGlsLmlzRGVmaW5lZChjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiAoY3VycmVudERhdGEpKSB7XG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICBpZiAoY3VycmVudERhdGEudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRbb3duS2V5XSA9IGN1cnJlbnREYXRhLnRyaW0oKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgIGlmICghaXNOYU4oY3VycmVudERhdGEpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0W293bktleV0gPSBjdXJyZW50RGF0YTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIGZpbHRlckNvbnRhaW5zQWxsUGFyZW50S2V5cyhwYXJlbnRLZXlzRmlsdGVyLCBwYXJlbnRLZXlzKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGtLZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5cyk7XG4gICAgaWYgKChwa0tleXMubGVuZ3RoID4gMCkgJiYgVXRpbC5pc0RlZmluZWQocGFyZW50S2V5c0ZpbHRlcikpIHtcbiAgICAgIGNvbnN0IHBhcmVudEtleXNGaWx0ZXJLZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5c0ZpbHRlcik7XG4gICAgICByZXR1cm4gcGtLZXlzLmV2ZXJ5KGEgPT4gcGFyZW50S2V5c0ZpbHRlcktleXMuaW5kZXhPZihhKSAhPT0gLTEpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRGaWx0ZXJVc2luZ1BhcmVudEtleXMocGFyZW50SXRlbTogYW55LCBwYXJlbnRLZXlzT2JqZWN0OiBvYmplY3QpIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7fTtcbiAgICBjb25zdCBvd25LZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5c09iamVjdCk7XG4gICAgaWYgKG93bktleXMubGVuZ3RoID4gMCAmJiBVdGlsLmlzRGVmaW5lZChwYXJlbnRJdGVtKSkge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmVudEtleSA9IHBhcmVudEtleXNPYmplY3Rbb3duS2V5XTtcbiAgICAgICAgaWYgKHBhcmVudEl0ZW0uaGFzT3duUHJvcGVydHkocGFyZW50S2V5KSkge1xuICAgICAgICAgIGxldCBjdXJyZW50RGF0YSA9IHBhcmVudEl0ZW1bcGFyZW50S2V5XTtcbiAgICAgICAgICBpZiAoY3VycmVudERhdGEgaW5zdGFuY2VvZiBPRm9ybVZhbHVlKSB7XG4gICAgICAgICAgICBjdXJyZW50RGF0YSA9IGN1cnJlbnREYXRhLnZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmaWx0ZXJbb3duS2V5XSA9IGN1cnJlbnREYXRhO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGZpbHRlcjtcbiAgfVxuXG4gIHN0YXRpYyBnZXRBcnJheVByb3BlcnRpZXMoYXJyYXk6IGFueVtdLCBwcm9wZXJ0aWVzOiBhbnlbXSk6IGFueVtdIHtcbiAgICBjb25zdCByZXN1bHQgPSBhcnJheS5tYXAoaXRlbSA9PiB7XG4gICAgICByZXR1cm4gU2VydmljZVV0aWxzLmdldE9iamVjdFByb3BlcnRpZXMoaXRlbSwgcHJvcGVydGllcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRPYmplY3RQcm9wZXJ0aWVzKG9iamVjdDogYW55LCBwcm9wZXJ0aWVzOiBhbnlbXSk6IGFueSB7XG4gICAgY29uc3Qgb2JqZWN0UHJvcGVydGllcyA9IHt9O1xuICAgIHByb3BlcnRpZXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgb2JqZWN0UHJvcGVydGllc1trZXldID0gb2JqZWN0W2tleV07XG4gICAgfSk7XG4gICAgcmV0dXJuIG9iamVjdFByb3BlcnRpZXM7XG4gIH1cblxuICBzdGF0aWMgcGFyc2VTb3J0Q29sdW1ucyhzb3J0Q29sdW1uczogc3RyaW5nKTogQXJyYXk8U1FMT3JkZXI+IHtcbiAgICBjb25zdCBzb3J0Q29sQXJyYXkgPSBbXTtcbiAgICBpZiAoc29ydENvbHVtbnMpIHtcbiAgICAgIGNvbnN0IGNvbHMgPSBVdGlsLnBhcnNlQXJyYXkoc29ydENvbHVtbnMpO1xuICAgICAgY29scy5mb3JFYWNoKGNvbCA9PiB7XG4gICAgICAgIGNvbnN0IGNvbERlZiA9IGNvbC5zcGxpdChDb2Rlcy5UWVBFX1NFUEFSQVRPUik7XG4gICAgICAgIGlmIChjb2xEZWYubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGNvbE5hbWUgPSBjb2xEZWZbMF07XG4gICAgICAgICAgY29uc3QgY29sU29ydCA9IGNvbERlZlsxXSB8fCBDb2Rlcy5BU0NfU09SVDtcbiAgICAgICAgICBzb3J0Q29sQXJyYXkucHVzaCh7XG4gICAgICAgICAgICBjb2x1bW5OYW1lOiBjb2xOYW1lLFxuICAgICAgICAgICAgYXNjZW5kZW50OiBjb2xTb3J0ID09PSBDb2Rlcy5BU0NfU09SVFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNvcnRDb2xBcnJheTtcbiAgfVxuXG4gIHN0YXRpYyByZWRpcmVjdExvZ2luKHJvdXRlcjogUm91dGVyLCBzZXNzaW9uRXhwaXJlZDogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgY29uc3QgYXJnID0ge307XG4gICAgYXJnW0NvZGVzLlNFU1NJT05fRVhQSVJFRF9LRVldID0gc2Vzc2lvbkV4cGlyZWQ7XG4gICAgY29uc3QgZXh0cmFzID0ge307XG4gICAgZXh0cmFzW0NvZGVzLlFVRVJZX1BBUkFNU10gPSBhcmc7XG4gICAgcm91dGVyLm5hdmlnYXRlKFtDb2Rlcy5MT0dJTl9ST1VURV0sIGV4dHJhcyk7XG4gIH1cblxufVxuIl19