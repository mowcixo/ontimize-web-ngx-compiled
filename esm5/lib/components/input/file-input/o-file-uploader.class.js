import { Codes } from '../../../util/codes';
var OFileUploader = (function () {
    function OFileUploader(service, entity) {
        this.service = service;
        this.files = [];
        this.isUploading = false;
        this.progress = 0;
        this.nextIndex = 0;
        this.splitUpload = true;
        this.entity = entity;
    }
    OFileUploader.prototype.addFile = function (fileItem) {
        this.files.push(fileItem);
        this.progress = this._getTotalProgress();
    };
    OFileUploader.prototype.clear = function () {
        this.cancel();
        while (this.files.length) {
            this.files[0].remove();
        }
        this.progress = 0;
    };
    OFileUploader.prototype.removeFile = function (value) {
        var index = this.getIndexOfItem(value);
        var item = this.files[index];
        if (item) {
            if (item.isUploading) {
                item.cancel();
            }
            this.files.splice(index, 1);
            this.progress = this._getTotalProgress();
        }
    };
    OFileUploader.prototype.upload = function () {
        var _this = this;
        this.files.forEach(function (item) {
            if (item.pendingUpload) {
                item.prepareToUpload();
            }
        });
        if (this.splitUpload) {
            this.files.forEach(function (item) {
                if (item.pendingUpload) {
                    _this.uploadItem(item);
                }
            });
        }
        else {
            this.uploadItems(this.files);
        }
    };
    OFileUploader.prototype.uploadItem = function (item) {
        item.prepareToUpload();
        if (this.isUploading || item.isUploading) {
            return;
        }
        this.isUploading = true;
        item.isUploading = true;
        this._onBeforeUploadItem(item);
        if (this.service === undefined) {
            console.warn('No service configured! aborting upload');
            return;
        }
        if (this._uploadSuscription) {
            this._uploadSuscription.unsubscribe();
        }
        var self = this;
        this._uploadSuscription = item._uploadSuscription = this.service.upload([item], this.entity, this.data).subscribe(function (resp) {
            if (resp.loaded && resp.total) {
                var progress = Math.round(resp.loaded * 100 / resp.total);
                self._onProgressItem(item, progress);
            }
            else if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                self._onSuccessItem(item, resp);
            }
            else {
                console.error('uploadItem error');
                self._onErrorItem(item, 'Unknow error');
            }
        }, function (err) { return self._onErrorItem(item, err); }, function () { return self._onCompleteItem(item); });
    };
    OFileUploader.prototype.uploadItems = function (items) {
        if (this.isUploading || items.some(function (item) { return item.isUploading; })) {
            return;
        }
        this.isUploading = true;
        this._onBeforeUploadAll();
        if (this.service === undefined) {
            console.warn('No service configured! aborting upload');
            return;
        }
        if (this._uploadSuscription) {
            this._uploadSuscription.unsubscribe();
        }
        var self = this;
        this._uploadSuscription = this.service.upload(items, this.entity, this.data).subscribe(function (resp) {
            if (resp.loaded && resp.total) {
                var progress = Math.round(resp.loaded * 100 / resp.total);
                self._onProgressAll(progress);
            }
            else if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                self._onSuccessAll(resp);
            }
            else {
                console.error('uploadItems error');
            }
        }, function (err) { return self._onErrorAll(err); }, function () { return self._onCompleteAll(); });
    };
    OFileUploader.prototype.cancel = function () {
        if (this.splitUpload) {
            this.files.forEach(function (item) { return item.cancel(); });
        }
        else {
            if (this._uploadSuscription) {
                this._uploadSuscription.unsubscribe();
            }
            this._onCancelAll();
            this._onCompleteAll();
        }
    };
    OFileUploader.prototype.cancelItem = function (value) {
        var index = this.getIndexOfItem(value);
        var item = this.files[index];
        if (item && item.isUploading && this.splitUpload) {
            item._uploadSuscription.unsubscribe();
        }
        this._onCancelItem(item);
        this._onCompleteItem(item);
    };
    OFileUploader.prototype.getNotUploadedItems = function () {
        return this.files.filter(function (item) { return !item.isUploaded; });
    };
    OFileUploader.prototype.getIndexOfItem = function (value) {
        return typeof value === 'number' ? value : this.files.indexOf(value);
    };
    OFileUploader.prototype.onBeforeUploadItem = function (fileItem) {
        return { fileItem: fileItem };
    };
    OFileUploader.prototype.onBeforeUploadAll = function () {
        return {};
    };
    OFileUploader.prototype.onProgressItem = function (fileItem, progress) {
        return { fileItem: fileItem, progress: progress };
    };
    OFileUploader.prototype.onProgressAll = function (progress) {
        return { progress: progress };
    };
    OFileUploader.prototype.onCancelItem = function (fileItem) {
        return { fileItem: fileItem };
    };
    OFileUploader.prototype.onCancelAll = function () {
        return {};
    };
    OFileUploader.prototype.onSuccessItem = function (fileItem, response) {
        return { fileItem: fileItem, response: response };
    };
    OFileUploader.prototype.onSuccessAll = function (response) {
        return { response: response };
    };
    OFileUploader.prototype.onErrorItem = function (fileItem, error) {
        return { fileItem: fileItem, error: error };
    };
    OFileUploader.prototype.onErrorAll = function (error) {
        return { error: error };
    };
    OFileUploader.prototype.onCompleteItem = function (fileItem) {
        return { fileItem: fileItem };
    };
    OFileUploader.prototype.onCompleteAll = function () {
        return void 0;
    };
    OFileUploader.prototype._onBeforeUploadItem = function (item) {
        item._onBeforeUpload();
        this.onBeforeUploadItem(item);
    };
    OFileUploader.prototype._onBeforeUploadAll = function () {
        this.files.forEach(function (item) { return item._onBeforeUpload(false); });
        this.onBeforeUploadAll();
    };
    OFileUploader.prototype._onProgressItem = function (item, progress) {
        var total = this._getTotalProgress(progress);
        this.progress = total;
        item._onProgress(progress);
        this.onProgressItem(item, progress);
        this.onProgressAll(total);
    };
    OFileUploader.prototype._onProgressAll = function (progress) {
        var total = this._getTotalProgress(progress);
        this.progress = total;
        this.onProgressAll(total);
    };
    OFileUploader.prototype._onSuccessItem = function (item, response) {
        item._onSuccess(response);
        this.onSuccessItem(item, response);
    };
    OFileUploader.prototype._onSuccessAll = function (response) {
        this.files.forEach(function (item) { return item._onSuccess(response, false); });
        this.onSuccessAll(response);
    };
    OFileUploader.prototype._onErrorItem = function (item, error) {
        item._onError(error);
        this.onErrorItem(item, error);
    };
    OFileUploader.prototype._onErrorAll = function (error) {
        this.files.forEach(function (item) { return item._onError(error, false); });
        this.onErrorAll(error);
    };
    OFileUploader.prototype._onCancelItem = function (item) {
        item._onCancel();
        this.onCancelItem(item);
    };
    OFileUploader.prototype._onCancelAll = function () {
        this.files.forEach(function (item) { return item._onCancel(false); });
        this.onCancelAll();
    };
    OFileUploader.prototype._onCompleteItem = function (item) {
        item._onComplete();
        this.onCompleteItem(item);
        var nextItem = this._getReadyItems()[0];
        this.isUploading = false;
        if (nextItem) {
            nextItem.upload();
            return;
        }
        this.onCompleteAll();
        this.progress = this._getTotalProgress();
    };
    OFileUploader.prototype._onCompleteAll = function () {
        this.files.forEach(function (item) { return item._onComplete(false); });
        this.isUploading = false;
        this.onCompleteAll();
        this.progress = this._getTotalProgress();
    };
    OFileUploader.prototype._getReadyItems = function () {
        return this.files
            .filter(function (item) { return (item.isReady && !item.isUploading); })
            .sort(function (item1, item2) { return item1.index - item2.index; });
    };
    OFileUploader.prototype._getTotalProgress = function (value) {
        if (value === void 0) { value = 0; }
        var notUploaded = this.getNotUploadedItems().length;
        var uploaded = notUploaded ? this.files.length - notUploaded : this.files.length;
        var ratio = this.splitUpload ? 100 / this.files.length : 100;
        var current = value * ratio / 100;
        return Math.round(uploaded * ratio + current);
    };
    return OFileUploader;
}());
export { OFileUploader };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1maWxlLXVwbG9hZGVyLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2lucHV0L2ZpbGUtaW5wdXQvby1maWxlLXVwbG9hZGVyLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUc1QztJQVlFLHVCQUNZLE9BQXFCLEVBQy9CLE1BQWM7UUFESixZQUFPLEdBQVAsT0FBTyxDQUFjO1FBVjFCLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGFBQVEsR0FBVyxDQUFDLENBQUM7UUFDckIsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixnQkFBVyxHQUFZLElBQUksQ0FBQztRQVNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRU0sK0JBQU8sR0FBZCxVQUFlLFFBQW1CO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUtELDZCQUFLLEdBQUw7UUFDRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDeEI7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBTUQsa0NBQVUsR0FBVixVQUFXLEtBQVU7UUFDbkIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxJQUFNLElBQUksR0FBRyxJ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Q0FBQyxFQUFuQyxDQUFtQyxDQUFDO2FBQ2hFLElBQUksQ0FBQyxVQUFDLEtBQWdCLEVBQUUsS0FBZ0IsSUFBSyxPQUFBLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBekIsQ0FBeUIsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFUyx5Q0FBaUIsR0FBM0IsVUFBNEIsS0FBaUI7UUFBakIsc0JBQUEsRUFBQSxTQUFpQjtRQUMzQyxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxNQUFNLENBQUM7UUFDdEQsSUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ25GLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBQy9ELElBQU0sT0FBTyxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ3BDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBSyxHQUFHLE9BQU8sQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFSCxvQkFBQztBQUFELENBQUMsQUE3VEQsSUE2VEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgSUZpbGVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vaW50ZXJmYWNlcy9maWxlLXNlcnZpY2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbC9jb2Rlcyc7XG5pbXBvcnQgeyBPRmlsZUl0ZW0gfSBmcm9tICcuL28tZmlsZS1pdGVtLmNsYXNzJztcblxuZXhwb3J0IGNsYXNzIE9GaWxlVXBsb2FkZXIge1xuXG4gIHB1YmxpYyBlbnRpdHk6IHN0cmluZztcbiAgcHVibGljIGZpbGVzOiBPRmlsZUl0ZW1bXSA9IFtdO1xuICBwdWJsaWMgaXNVcGxvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHVibGljIHByb2dyZXNzOiBudW1iZXIgPSAwO1xuICBwdWJsaWMgbmV4dEluZGV4OiBudW1iZXIgPSAwO1xuICBwdWJsaWMgc3BsaXRVcGxvYWQ6IGJvb2xlYW4gPSB0cnVlO1xuICBwdWJsaWMgZGF0YTogb2JqZWN0O1xuXG4gIHByb3RlY3RlZCBfdXBsb2FkU3VzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgc2VydmljZTogSUZpbGVTZXJ2aWNlLFxuICAgIGVudGl0eTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMuZW50aXR5ID0gZW50aXR5O1xuICB9XG5cbiAgcHVibGljIGFkZEZpbGUoZmlsZUl0ZW06IE9GaWxlSXRlbSk6IHZvaWQge1xuICAgIHRoaXMuZmlsZXMucHVzaChmaWxlSXRlbSk7XG4gICAgdGhpcy5wcm9ncmVzcyA9IHRoaXMuX2dldFRvdGFsUHJvZ3Jlc3MoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxzIHRoZSB1cGxvYWQgb2YgYWxsIGZpbGVzIGFuZCByZW1vdmUgdGhlbSBmcm9tIHRoZSBmaWxlIGxpc3QuXG4gICAqL1xuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLmNhbmNlbCgpO1xuICAgIHdoaWxlICh0aGlzLmZpbGVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5maWxlc1swXS5yZW1vdmUoKTtcbiAgICB9XG4gICAgdGhpcy5wcm9ncmVzcyA9IDA7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhIGZpbGUgZnJvbSB0aGUgZmlsZSBsaXN0LCBpdCBjYW5jZWxzIHVwbG9hZCBpZiBuZWVkZWQuXG4gICAqIEBwYXJhbSB2YWx1ZSB0aGUgZmlsZSB0byByZW1vdmVcbiAgICovXG4gIHJlbW92ZUZpbGUodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5nZXRJbmRleE9mSXRlbSh2YWx1ZSk7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuZmlsZXNbaW5kZXhdO1xuICAgIGlmIChpdGVtKSB7XG4gICAgICBpZiAoaXRlbS5pc1VwbG9hZGluZykge1xuICAgICAgICBpdGVtLmNhbmNlbCgpO1xuICAgICAgfVxuICAgICAgdGhpcy5maWxlcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgdGhpcy5wcm9ncmVzcyA9IHRoaXMuX2dldFRvdGFsUHJvZ3Jlc3MoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBsb2FkKCk6IHZvaWQge1xuICAgIHRoaXMuZmlsZXMuZm9yRWFjaCgoaXRlbTogT0ZpbGVJdGVtKSA9PiB7XG4gICAgICBpZiAoaXRlbS5wZW5kaW5nVXBsb2FkKSB7XG4gICAgICAgIGl0ZW0ucHJlcGFyZVRvVXBsb2FkKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHRoaXMuc3BsaXRVcGxvYWQpIHtcbiAgICAgIHRoaXMuZmlsZXMuZm9yRWFjaCgoaXRlbTogT0ZpbGVJdGVtKSA9PiB7XG4gICAgICAgIGlmIChpdGVtLnBlbmRpbmdVcGxvYWQpIHtcbiAgICAgICAgICB0aGlzLnVwbG9hZEl0ZW0oaXRlbSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVwbG9hZEl0ZW1zKHRoaXMuZmlsZXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGxvYWRzIGEgc2luZ2xlIGZpbGUgb24gYSBzaW5nbGUgcmVxdWVzdC5cbiAgICogQHBhcmFtIGl0ZW0gdGhlIGZpbGUgdG8gdXBsb2FkXG4gICAqL1xuICBwdWJsaWMgdXBsb2FkSXRlbShpdGVtOiBPRmlsZUl0ZW0pOiB2b2lkIHtcbiAgICBpdGVtLnByZXBhcmVUb1VwbG9hZCgpO1xuICAgIGlmICh0aGlzLmlzVXBsb2FkaW5nIHx8IGl0ZW0uaXNVcGxvYWRpbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5pc1VwbG9hZGluZyA9IHRydWU7XG4gICAgaXRlbS5pc1VwbG9hZGluZyA9IHRydWU7XG5cbiAgICB0aGlzLl9vbkJlZm9yZVVwbG9hZEl0ZW0oaXRlbSk7XG5cbiAgICBpZiAodGhpcy5zZXJ2aWNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnNvbGUud2FybignTm8gc2VydmljZSBjb25maWd1cmVkISBhYm9ydGluZyB1cGxvYWQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLl91cGxvYWRTdXNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uID0gaXRlbS5fdXBsb2FkU3VzY3JpcHRpb24gPSB0aGlzLnNlcnZpY2UudXBsb2FkKFtpdGVtXSwgdGhpcy5lbnRpdHksIHRoaXMuZGF0YSkuc3Vic2NyaWJlKFxuICAgICAgcmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLmxvYWRlZCAmJiByZXNwLnRvdGFsKSB7XG4gICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKHJlc3AubG9hZGVkICogMTAwIC8gcmVzcC50b3RhbCk7XG4gICAgICAgICAgc2VsZi5fb25Qcm9ncmVzc0l0ZW0oaXRlbSwgcHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3AuY29kZSA9PT0gQ29kZXMuT05USU1JWkVfU1VDQ0VTU0ZVTF9DT0RFKSB7XG4gICAgICAgICAgc2VsZi5fb25TdWNjZXNzSXRlbShpdGVtLCByZXNwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCd1cGxvYWRJdGVtIGVycm9yJyk7XG4gICAgICAgICAgc2VsZi5fb25FcnJvckl0ZW0oaXRlbSwgJ1Vua25vdyBlcnJvcicpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZXJyID0+IHNlbGYuX29uRXJyb3JJdGVtKGl0ZW0sIGVyciksXG4gICAgICAoKSA9PiBzZWxmLl9vbkNvbXBsZXRlSXRlbShpdGVtKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVXBsb2FkIGEgc2V0IG9mIGZpbGVzIG9uIGEgc2luZ2xlIHJlcXVlc3QuXG4gICAqIEBwYXJhbSBpdGVtcyB0aGUgYXJyYXkgb2YgZmlsZXMgdG8gdXBsb2FkXG4gICAqL1xuICBwdWJsaWMgdXBsb2FkSXRlbXMoaXRlbXM6IE9GaWxlSXRlbVtdKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNVcGxvYWRpbmcgfHwgaXRlbXMuc29tZShpdGVtID0+IGl0ZW0uaXNVcGxvYWRpbmcpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuaXNVcGxvYWRpbmcgPSB0cnVlO1xuXG4gICAgdGhpcy5fb25CZWZvcmVVcGxvYWRBbGwoKTtcblxuICAgIGlmICh0aGlzLnNlcnZpY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKCdObyBzZXJ2aWNlIGNvbmZpZ3VyZWQhIGFib3J0aW5nIHVwbG9hZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5fdXBsb2FkU3VzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5fdXBsb2FkU3VzY3JpcHRpb24gPSB0aGlzLnNlcnZpY2UudXBsb2FkKGl0ZW1zLCB0aGlzLmVudGl0eSwgdGhpcy5kYXRhKS5zdWJzY3JpYmUocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5sb2FkZWQgJiYgcmVzcC50b3RhbCkge1xuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IE1hdGgucm91bmQocmVzcC5sb2FkZWQgKiAxMDAgLyByZXNwLnRvdGFsKTtcbiAgICAgICAgc2VsZi5fb25Qcm9ncmVzc0FsbChwcm9ncmVzcyk7XG4gICAgICB9IGVsc2UgaWYgKHJlc3AuY29kZSA9PT0gQ29kZXMuT05USU1JWkVfU1VDQ0VTU0ZVTF9DT0RFKSB7XG4gICAgICAgIHNlbGYuX29uU3VjY2Vzc0FsbChyZXNwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ3VwbG9hZEl0ZW1zIGVycm9yJyk7XG4gICAgICB9XG4gICAgfSxcbiAgICAgIGVyciA9PiBzZWxmLl9vbkVycm9yQWxsKGVyciksXG4gICAgICAoKSA9PiBzZWxmLl9vbkNvbXBsZXRlQWxsKClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbmNlbHMgdGhlIHVwbG9hZCBvZiBhbGwgZmlsZXMuXG4gICAqL1xuICBwdWJsaWMgY2FuY2VsKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnNwbGl0VXBsb2FkKSB7XG4gICAgICB0aGlzLmZpbGVzLmZvckVhY2goaXRlbSA9PiBpdGVtLmNhbmNlbCgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uKSB7XG4gICAgICAgIHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgICB0aGlzLl9vbkNhbmNlbEFsbCgpO1xuICAgICAgdGhpcy5fb25Db21wbGV0ZUFsbCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5jZWxzIHRoZSB0aGUgZmlsZSB1cGxvYWQuXG4gICAqIEBwYXJhbSB2YWx1ZSB0aGUgZmlsZSB0byBjYW5jZWwgaXRzIHVwbG9hZFxuICAgKi9cbiAgcHVibGljIGNhbmNlbEl0ZW0odmFsdWU6IE9GaWxlSXRlbSk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5nZXRJbmRleE9mSXRlbSh2YWx1ZSk7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuZmlsZXNbaW5kZXhdO1xuICAgIGlmIChpdGVtICYmIGl0ZW0uaXNVcGxvYWRpbmcgJiYgdGhpcy5zcGxpdFVwbG9hZCkge1xuICAgICAgaXRlbS5fdXBsb2FkU3VzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgdGhpcy5fb25DYW5jZWxJdGVtKGl0ZW0pO1xuICAgIHRoaXMuX29uQ29tcGxldGVJdGVtKGl0ZW0pO1xuICB9XG5cbiAgcHVibGljIGdldE5vdFVwbG9hZGVkSXRlbXMoKTogT0ZpbGVJdGVtW10ge1xuICAgIHJldHVybiB0aGlzLmZpbGVzLmZpbHRlcigoaXRlbTogT0ZpbGVJdGVtKSA9PiAhaXRlbS5pc1VwbG9hZGVkKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRJbmRleE9mSXRlbSh2YWx1ZTogYW55KTogbnVtYmVyIHtcbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHZhbHVlIDogdGhpcy5maWxlcy5pbmRleE9mKHZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkJlZm9yZVVwbG9hZEl0ZW0oZmlsZUl0ZW06IE9GaWxlSXRlbSk6IGFueSB7XG4gICAgcmV0dXJuIHsgZmlsZUl0ZW0gfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkJlZm9yZVVwbG9hZEFsbCgpOiBhbnkge1xuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIHB1YmxpYyBvblByb2dyZXNzSXRlbShmaWxlSXRlbTogT0ZpbGVJdGVtLCBwcm9ncmVzczogYW55KTogYW55IHtcbiAgICByZXR1cm4geyBmaWxlSXRlbSwgcHJvZ3Jlc3MgfTtcbiAgfVxuXG4gIHB1YmxpYyBvblByb2dyZXNzQWxsKHByb2dyZXNzOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB7IHByb2dyZXNzIH07XG4gIH1cblxuICBwdWJsaWMgb25DYW5jZWxJdGVtKGZpbGVJdGVtOiBPRmlsZUl0ZW0pOiBhbnkge1xuICAgIHJldHVybiB7IGZpbGVJdGVtIH07XG4gIH1cblxuICBwdWJsaWMgb25DYW5jZWxBbGwoKTogYW55IHtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBwdWJsaWMgb25TdWNjZXNzSXRlbShmaWxlSXRlbTogT0ZpbGVJdGVtLCByZXNwb25zZTogYW55KTogYW55IHtcbiAgICByZXR1cm4geyBmaWxlSXRlbSwgcmVzcG9uc2UgfTtcbiAgfVxuXG4gIHB1YmxpYyBvblN1Y2Nlc3NBbGwocmVzcG9uc2U6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIHsgcmVzcG9uc2UgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkVycm9ySXRlbShmaWxlSXRlbTogT0ZpbGVJdGVtLCBlcnJvcjogYW55KTogYW55IHtcbiAgICByZXR1cm4geyBmaWxlSXRlbSwgZXJyb3IgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkVycm9yQWxsKGVycm9yOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB7IGVycm9yIH07XG4gIH1cblxuICBwdWJsaWMgb25Db21wbGV0ZUl0ZW0oZmlsZUl0ZW06IE9GaWxlSXRlbSk6IGFueSB7XG4gICAgcmV0dXJuIHsgZmlsZUl0ZW0gfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkNvbXBsZXRlQWxsKCk6IGFueSB7XG4gICAgcmV0dXJuIHZvaWQgMDtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25CZWZvcmVVcGxvYWRJdGVtKGl0ZW06IE9GaWxlSXRlbSk6IHZvaWQge1xuICAgIGl0ZW0uX29uQmVmb3JlVXBsb2FkKCk7XG4gICAgdGhpcy5vbkJlZm9yZVVwbG9hZEl0ZW0oaXRlbSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uQmVmb3JlVXBsb2FkQWxsKCk6IHZvaWQge1xuICAgIHRoaXMuZmlsZXMuZm9yRWFjaChpdGVtID0+IGl0ZW0uX29uQmVmb3JlVXBsb2FkKGZhbHNlKSk7XG4gICAgdGhpcy5vbkJlZm9yZVVwbG9hZEFsbCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vblByb2dyZXNzSXRlbShpdGVtOiBPRmlsZUl0ZW0sIHByb2dyZXNzOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMuX2dldFRvdGFsUHJvZ3Jlc3MocHJvZ3Jlc3MpO1xuICAgIHRoaXMucHJvZ3Jlc3MgPSB0b3RhbDtcbiAgICBpdGVtLl9vblByb2dyZXNzKHByb2dyZXNzKTtcbiAgICB0aGlzLm9uUHJvZ3Jlc3NJdGVtKGl0ZW0sIHByb2dyZXNzKTtcbiAgICB0aGlzLm9uUHJvZ3Jlc3NBbGwodG90YWwpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vblByb2dyZXNzQWxsKHByb2dyZXNzOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMuX2dldFRvdGFsUHJvZ3Jlc3MocHJvZ3Jlc3MpO1xuICAgIHRoaXMucHJvZ3Jlc3MgPSB0b3RhbDtcbiAgICB0aGlzLm9uUHJvZ3Jlc3NBbGwodG90YWwpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vblN1Y2Nlc3NJdGVtKGl0ZW06IE9GaWxlSXRlbSwgcmVzcG9uc2U6IGFueSk6IHZvaWQge1xuICAgIGl0ZW0uX29uU3VjY2VzcyhyZXNwb25zZSk7XG4gICAgdGhpcy5vblN1Y2Nlc3NJdGVtKGl0ZW0sIHJlc3BvbnNlKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25TdWNjZXNzQWxsKHJlc3BvbnNlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmZpbGVzLmZvckVhY2goaXRlbSA9PiBpdGVtLl9vblN1Y2Nlc3MocmVzcG9uc2UsIGZhbHNlKSk7XG4gICAgdGhpcy5vblN1Y2Nlc3NBbGwocmVzcG9uc2UpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkVycm9ySXRlbShpdGVtOiBPRmlsZUl0ZW0sIGVycm9yOiBhbnkpOiB2b2lkIHtcbiAgICBpdGVtLl9vbkVycm9yKGVycm9yKTtcbiAgICB0aGlzLm9uRXJyb3JJdGVtKGl0ZW0sIGVycm9yKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25FcnJvckFsbChlcnJvcjogYW55KTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5fb25FcnJvcihlcnJvciwgZmFsc2UpKTtcbiAgICB0aGlzLm9uRXJyb3JBbGwoZXJyb3IpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkNhbmNlbEl0ZW0oaXRlbTogT0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgaXRlbS5fb25DYW5jZWwoKTtcbiAgICB0aGlzLm9uQ2FuY2VsSXRlbShpdGVtKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25DYW5jZWxBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5fb25DYW5jZWwoZmFsc2UpKTtcbiAgICB0aGlzLm9uQ2FuY2VsQWxsKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uQ29tcGxldGVJdGVtKGl0ZW06IE9GaWxlSXRlbSk6IHZvaWQge1xuICAgIGl0ZW0uX29uQ29tcGxldGUoKTtcbiAgICB0aGlzLm9uQ29tcGxldGVJdGVtKGl0ZW0pO1xuICAgIGNvbnN0IG5leHRJdGVtID0gdGhpcy5fZ2V0UmVhZHlJdGVtcygpWzBdO1xuICAgIHRoaXMuaXNVcGxvYWRpbmcgPSBmYWxzZTtcbiAgICBpZiAobmV4dEl0ZW0pIHtcbiAgICAgIG5leHRJdGVtLnVwbG9hZCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm9uQ29tcGxldGVBbGwoKTtcbiAgICB0aGlzLnByb2dyZXNzID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcygpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkNvbXBsZXRlQWxsKCk6IHZvaWQge1xuICAgIHRoaXMuZmlsZXMuZm9yRWFjaChpdGVtID0+IGl0ZW0uX29uQ29tcGxldGUoZmFsc2UpKTtcbiAgICB0aGlzLmlzVXBsb2FkaW5nID0gZmFsc2U7XG4gICAgdGhpcy5vbkNvbXBsZXRlQWxsKCk7XG4gICAgdGhpcy5wcm9ncmVzcyA9IHRoaXMuX2dldFRvdGFsUHJvZ3Jlc3MoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfZ2V0UmVhZHlJdGVtcygpOiBPRmlsZUl0ZW1bXSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXNcbiAgICAgIC5maWx0ZXIoKGl0ZW06IE9GaWxlSXRlbSkgPT4gKGl0ZW0uaXNSZWFkeSAmJiAhaXRlbS5pc1VwbG9hZGluZykpXG4gICAgICAuc29ydCgoaXRlbTE6IE9GaWxlSXRlbSwgaXRlbTI6IE9GaWxlSXRlbSkgPT4gaXRlbTEuaW5kZXggLSBpdGVtMi5pbmRleCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2dldFRvdGFsUHJvZ3Jlc3ModmFsdWU6IG51bWJlciA9IDApOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdFVwbG9hZGVkID0gdGhpcy5nZXROb3RVcGxvYWRlZEl0ZW1zKCkubGVuZ3RoO1xuICAgIGNvbnN0IHVwbG9hZGVkID0gbm90VXBsb2FkZWQgPyB0aGlzLmZpbGVzLmxlbmd0aCAtIG5vdFVwbG9hZGVkIDogdGhpcy5maWxlcy5sZW5ndGg7XG4gICAgY29uc3QgcmF0aW8gPSB0aGlzLnNwbGl0VXBsb2FkID8gMTAwIC8gdGhpcy5maWxlcy5sZW5ndGggOiAxMDA7XG4gICAgY29uc3QgY3VycmVudCA9IHZhbHVlICogcmF0aW8gLyAxMDA7XG4gICAgcmV0dXJuIE1hdGgucm91bmQodXBsb2FkZWQgKiByYXRpbyArIGN1cnJlbnQpO1xuICB9XG5cbn1cbiJdfQ==