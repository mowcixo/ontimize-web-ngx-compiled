import { Codes } from '../../../util/codes';
import { Util } from '../../../util/util';
var OTableStorage = (function () {
    function OTableStorage(table) {
        this.table = table;
    }
    OTableStorage.prototype.getDataToStore = function () {
        var dataToStore = {
            filter: this.table.oTableQuickFilterComponent ? this.table.oTableQuickFilterComponent.value : ''
        };
        var properties = ['sort', 'columns-display', 'columns-filter', 'quick-filter', 'page', 'selection', 'initial-configuration'];
        Object.assign(dataToStore, this.getTablePropertiesToStore(properties));
        var storedFiltersArr = this.getStoredFilters();
        if (storedFiltersArr.length > 0) {
            dataToStore[OTableStorage.USER_STORED_FILTERS_KEY] = storedFiltersArr;
        }
        var storedConfigurationsArr = this.getStoredConfigurations();
        if (storedConfigurationsArr.length > 0) {
            dataToStore[OTableStorage.STORED_CONFIGURATIONS_KEY] = storedConfigurationsArr;
        }
        return dataToStore;
    };
    OTableStorage.prototype.getTablePropertiesToStore = function (properties) {
        var _this = this;
        var result = {};
        properties.forEach(function (prop) {
            Object.assign(result, _this.getTablePropertyToStore(prop));
        });
        return result;
    };
    OTableStorage.prototype.getTablePropertyToStore = function (property) {
        var result = {};
        switch (property) {
            case 'sort':
                result = this.getSortState();
                break;
            case 'columns-display':
                result = this.getColumnsDisplayState();
                break;
            case 'quick-filter':
                result = this.getColumnsQuickFilterState();
                break;
            case 'columns-filter':
                result = this.getColumnFiltersState();
                break;
            case 'page':
                result = this.getPageState();
                break;
            case 'selection':
                result = this.getSelectionState();
                break;
            case 'initial-configuration':
                result = this.getInitialConfigurationState();
                break;
        }
        return result;
    };
    OTableStorage.prototype.reset = function () {
        var state = {};
        state[OTableStorage.USER_STORED_FILTERS_KEY] = this.table.state[OTableStorage.USER_STORED_FILTERS_KEY];
        state[OTableStorage.STORED_CONFIGURATIONS_KEY] = this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY];
        if (this.table.pageable) {
            state.totalQueryRecordsNumber = this.table.state.totalQueryRecordsNumber;
        }
        state.currentPage = 0;
        this.table.state = state;
    };
    OTableStorage.prototype.getSortState = function () {
        var result = {};
        var sortColumnsArray = this.table.sort.getSortColumns();
        if (sortColumnsArray.length > 0) {
            var sortColumns_1 = [];
            sortColumnsArray.forEach(function (sortData) {
                sortColumns_1.push(sortData.id + Codes.COLUMNS_ALIAS_SEPARATOR + sortData.direction);
            });
            result['sort-columns'] = sortColumns_1.join(Codes.ARRAY_INPUT_SEPARATOR);
        }
        return result;
    };
    OTableStorage.prototype.getColumnFiltersState = function () {
        var result = {};
        if (this.table.oTableColumnsFilterComponent) {
            var columnValueFilters = this.table.dataSource.getColumnValueFilters();
            if (columnValueFilters.length > 0) {
                result['column-value-filters'] = columnValueFilters;
            }
        }
        return result;
    };
    OTableStorage.prototype.getColumnsDisplayState = function () {
        var result = {};
        var oColumnsData = [];
        this.table.oTableOptions.columns.forEach(function (oCol) {
            oColumnsData.push({
                attr: oCol.attr,
                visible: oCol.visible,
                width: oCol.getWidthToStore()
            });
        });
        result['oColumns-display'] = oColumnsData;
        result['select-column-visible'] = this.table.oTableOptions.selectColumn.visible;
        return result;
    };
    OTableStorage.prototype.getColumnsQuickFilterState = function () {
        var result = {};
        var tableOptions = this.table.oTableOptions;
        var oColumnsData = [];
        tableOptions.columns.forEach(function (oCol) {
            oColumnsData.push({
                attr: oCol.attr,
                searchable: oCol.searchable,
                searching: oCol.searching
            });
        });
        result.oColumns = oColumnsData;
        result['filter-case-sensitive'] = tableOptions.filterCaseSensitive;
        return result;
    };
    OTableStorage.prototype.getPageState = function () {
        var result = {
            'query-rows': this.table.matpaginator ? this.table.matpaginator.pageSize : ''
        };
        if (this.table.currentPage > 0 && this.table.storePaginationState) {
            result.currentPage = this.table.currentPage;
        }
        if (this.table.pageable && this.table.storePaginationState) {
            var state = this.table.state;
            result.totalQueryRecordsNumber = state.totalQueryRecordsNumber;
            result.queryRecordOffset = Math.max((state.queryRecordOffset - this.table.dataSource.renderedData.length), (state.queryRecordOffset - this.table.queryRows));
        }
        return result;
    };
    OTableStorage.prototype.getSelectionState = function () {
        var _this = this;
        var result = {
            selection: []
        };
        if (this.table && this.table.keepSelectedItems) {
            var selection_1 = [];
            this.table.getSelectedItems().forEach(function (item) {
                var data = {};
                _this.table.getKeys().forEach(function (key) {
                    data[key] = item[key];
                });
                selection_1.push(data);
            });
            result.selection = selection_1;
        }
        return result;
    };
    OTableStorage.prototype.getInitialConfigurationState = function () {
        var result = {};
        var initialConfiguration = {};
        var oColumnsData = [];
        var self = this;
        Util.parseArray(this.table.visibleColumns, true).forEach(function (x) {
            var oCol = self.table.getOColumn(x);
            oColumnsData.push({
                attr: oCol.attr,
                visible: true,
                width: oCol.definition ? oCol.definition.originalWidth : undefined
            });
        });
        initialConfiguration['oColumns-display'] = oColumnsData;
        initialConfiguration['sort-columns'] = this.table.sortColumns;
        initialConfiguration['select-column-visible'] = this.table.oTableOptions.selectColumn.visible;
        initialConfiguration['filter-case-sensitive'] = this.table.filterCaseSensitive;
        initialConfiguration['query-rows'] = this.table.originalQueryRows;
        result['initial-configuration'] = initialConfiguration;
        return result;
    };
    OTableStorage.prototype.setStoredFilters = function (filters) {
        return this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = filters;
    };
    OTableStorage.prototype.getStoredFilters = function () {
        return this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] || [];
    };
    OTableStorage.prototype.getStoredFilter = function (filterName) {
        return this.getStoredFilters().find(function (item) { return item.name === filterName; });
    };
    OTableStorage.prototype.getStoredFilterConf = function (filterName) {
        return (this.getStoredFilter(filterName) || {})[OTableStorage.STORED_FILTER_KEY];
    };
    OTableStorage.prototype.deleteStoredFilter = function (filterName) {
        var storedFilters = this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] || [];
        var index = storedFilters.findIndex(function (item) { return item.name === filterName; });
        if (index >= 0) {
            storedFilters.splice(index, 1);
            this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = storedFilters;
        }
    };
    OTableStorage.prototype.storeFilter = function (filterArgs) {
        var result = {};
        var storedFilter = {};
        Object.assign(storedFilter, this.getColumnFiltersState());
        Object.assign(storedFilter, this.getColumnsQuickFilterState());
        result[OTableStorage.STORED_FILTER_KEY] = storedFilter;
        Object.assign(result, filterArgs);
        var existingFilters = this.getStoredFilters();
        existingFilters.push(result);
        this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = existingFilters;
    };
    OTableStorage.prototype.getStoredColumnsFilters = function (arg) {
        var stateObj = arg || this.table.state;
        return stateObj['column-value-filters'] || [];
    };
    OTableStorage.prototype.getStoredConfigurations = function () {
        return this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] || [];
    };
    OTableStorage.prototype.getStoredConfiguration = function (configurationName) {
        return this.getStoredConfigurations().find(function (item) { return item.name === configurationName; });
    };
    OTableStorage.prototype.storeConfiguration = function (configurationAgs, tableProperties) {
        var result = {};
        this.table.storePaginationState = true;
        var storedConfiguration = this.getTablePropertiesToStore(tableProperties);
        this.table.storePaginationState = false;
        result[OTableStorage.STORED_CONFIGURATION_KEY] = storedConfiguration;
        Object.assign(result, configurationAgs);
        result[OTableStorage.STORED_PROPERTIES_KEY] = tableProperties;
        var existingConfigurations = this.getStoredConfigurations();
        existingConfigurations.push(result);
        this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] = existingConfigurations;
    };
    OTableStorage.prototype.deleteStoredConfiguration = function (configurationName) {
        var storedConfigurations = this.getStoredConfigurations();
        var index = storedConfigurations.findIndex(function (item) { return item.name === configurationName; });
        if (index >= 0) {
            storedConfigurations.splice(index, 1);
            this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] = storedConfigurations;
        }
    };
    OTableStorage.STORED_FILTER_KEY = 'stored-filter';
    OTableStorage.USER_STORED_FILTERS_KEY = 'user-stored-filters';
    OTableStorage.STORED_CONFIGURATION_KEY = 'stored-configuration';
    OTableStorage.STORED_PROPERTIES_KEY = 'stored-properties';
    OTableStorage.STORED_CONFIGURATIONS_KEY = 'user-stored-configurations';
    return OTableStorage;
}());
export { OTableStorage };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10YWJsZS1zdG9yYWdlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3RhYmxlL2V4dGVuc2lvbnMvby10YWJsZS1zdG9yYWdlLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJMUM7SUFTRSx1QkFDWSxLQUFzQjtRQUF0QixVQUFLLEdBQUwsS0FBSyxDQUFpQjtJQUM5QixDQUFDO0lBRUwsc0NBQWMsR0FBZDtRQUNFLElBQU0sV0FBVyxHQUFHO1lBQ2xCLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUNqRyxDQUFDO1FBRUYsSUFBTSxVQUFVLEdBQUcsQ0FBQyxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztRQUUvSCxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUV2RSxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2pELElBQUksZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQixXQUFXLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsZ0JBQWdCLENBQUM7U0FDdkU7UUFDRCxJQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQy9ELElBQUksdUJBQXVCLENBQUMsTUFB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O0lBQ2xELG1DQUFxQixHQUFHLG1CQUFtQixDQUFDO0lBQzVDLHVDQUF5QixHQUFHLDRCQUE0QixDQUFDO0lBMFF6RSxvQkFBQztDQUFBLEFBalJELElBaVJDO1NBalJZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPVGFibGVDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMvby10YWJsZS1jb25maWd1cmF0aW9uLnR5cGUnO1xuaW1wb3J0IHsgT1RhYmxlRmlsdGVyc1N0YXR1cyB9IGZyb20gJy4uLy4uLy4uL3R5cGVzL28tdGFibGUtZmlsdGVyLXN0YXR1cy50eXBlJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbC9jb2Rlcyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IE9Db2x1bW4gfSBmcm9tICcuLi9jb2x1bW4vby1jb2x1bW4uY2xhc3MnO1xuaW1wb3J0IHsgT1RhYmxlQ29tcG9uZW50IH0gZnJvbSAnLi4vby10YWJsZS5jb21wb25lbnQnO1xuXG5leHBvcnQgY2xhc3MgT1RhYmxlU3RvcmFnZSB7XG5cbiAgcHVibGljIHN0YXRpYyBTVE9SRURfRklMVEVSX0tFWSA9ICdzdG9yZWQtZmlsdGVyJztcbiAgcHVibGljIHN0YXRpYyBVU0VSX1NUT1JFRF9GSUxURVJTX0tFWSA9ICd1c2VyLXN0b3JlZC1maWx0ZXJzJztcblxuICBwdWJsaWMgc3RhdGljIFNUT1JFRF9DT05GSUdVUkFUSU9OX0tFWSA9ICdzdG9yZWQtY29uZmlndXJhdGlvbic7XG4gIHB1YmxpYyBzdGF0aWMgU1RPUkVEX1BST1BFUlRJRVNfS0VZID0gJ3N0b3JlZC1wcm9wZXJ0aWVzJztcbiAgcHVibGljIHN0YXRpYyBTVE9SRURfQ09ORklHVVJBVElPTlNfS0VZID0gJ3VzZXItc3RvcmVkLWNvbmZpZ3VyYXRpb25zJztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgdGFibGU6IE9UYWJsZUNvbXBvbmVudFxuICApIHsgfVxuXG4gIGdldERhdGFUb1N0b3JlKCkge1xuICAgIGNvbnN0IGRhdGFUb1N0b3JlID0ge1xuICAgICAgZmlsdGVyOiB0aGlzLnRhYmxlLm9UYWJsZVF1aWNrRmlsdGVyQ29tcG9uZW50ID8gdGhpcy50YWJsZS5vVGFibGVRdWlja0ZpbHRlckNvbXBvbmVudC52YWx1ZSA6ICcnXG4gICAgfTtcblxuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBbJ3NvcnQnLCAnY29sdW1ucy1kaXNwbGF5JywgJ2NvbHVtbnMtZmlsdGVyJywgJ3F1aWNrLWZpbHRlcicsICdwYWdlJywgJ3NlbGVjdGlvbicsICdpbml0aWFsLWNvbmZpZ3VyYXRpb24nXTtcblxuICAgIE9iamVjdC5hc3NpZ24oZGF0YVRvU3RvcmUsIHRoaXMuZ2V0VGFibGVQcm9wZXJ0aWVzVG9TdG9yZShwcm9wZXJ0aWVzKSk7XG5cbiAgICBjb25zdCBzdG9yZWRGaWx0ZXJzQXJyID0gdGhpcy5nZXRTdG9yZWRGaWx0ZXJzKCk7XG4gICAgaWYgKHN0b3JlZEZpbHRlcnNBcnIubGVuZ3RoID4gMCkge1xuICAgICAgZGF0YVRvU3RvcmVbT1RhYmxlU3RvcmFnZS5VU0VSX1NUT1JFRF9GSUxURVJTX0tFWV0gPSBzdG9yZWRGaWx0ZXJzQXJyO1xuICAgIH1cbiAgICBjb25zdCBzdG9yZWRDb25maWd1cmF0aW9uc0FyciA9IHRoaXMuZ2V0U3RvcmVkQ29uZmlndXJhdGlvbnMoKTtcbiAgICBpZiAoc3RvcmVkQ29uZmlndXJhdGlvbnNBcnIubGVuZ3RoID4gMCkge1xuICAgICAgZGF0YVRvU3RvcmVbT1RhYmxlU3RvcmFnZS5TVE9SRURfQ09ORklHVVJBVElPTlNfS0VZXSA9IHN0b3JlZENvbmZpZ3VyYXRpb25zQXJyO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhVG9TdG9yZTtcbiAgfVxuXG4gIGdldFRhYmxlUHJvcGVydGllc1RvU3RvcmUocHJvcGVydGllczogc3RyaW5nW10pIHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICBPYmplY3QuYXNzaWduKHJlc3VsdCwgdGhpcy5nZXRUYWJsZVByb3BlcnR5VG9TdG9yZShwcm9wKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGdldFRhYmxlUHJvcGVydHlUb1N0b3JlKHByb3BlcnR5OiBzdHJpbmcpIHtcbiAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgc3dpdGNoIChwcm9wZXJ0eSkge1xuICAgICAgY2FzZSAnc29ydCc6XG4gICAgICAgIHJlc3VsdCA9IHRoaXMuZ2V0U29ydFN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29sdW1ucy1kaXNwbGF5JzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5zRGlzcGxheVN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncXVpY2stZmlsdGVyJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5zUXVpY2tGaWx0ZXJTdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2NvbHVtbnMtZmlsdGVyJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5GaWx0ZXJzU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdwYWdlJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRQYWdlU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzZWxlY3Rpb24nOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldFNlbGVjdGlvblN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnaW5pdGlhbC1jb25maWd1cmF0aW9uJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRJbml0aWFsQ29uZmlndXJhdGlvblN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcmVzZXQoKSB7XG4gICAgY29uc3Qgc3RhdGU6IGFueSA9IHt9O1xuICAgIHN0YXRlW09UYWJsZVN0b3JhZ2UuVVNFUl9TVE9SRURfRklMVEVSU19LRVldID0gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXTtcbiAgICBzdGF0ZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldID0gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldO1xuICAgIGlmICh0aGlzLnRhYmxlLnBhZ2VhYmxlKSB7XG4gICAgICBzdGF0ZS50b3RhbFF1ZXJ5UmVjb3Jkc051bWJlciA9IHRoaXMudGFibGUuc3RhdGUudG90YWxRdWVyeVJlY29yZHNOdW1iZXI7XG4gICAgfVxuICAgIHN0YXRlLmN1cnJlbnRQYWdlID0gMDtcbiAgICB0aGlzLnRhYmxlLnN0YXRlID0gc3RhdGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0U29ydFN0YXRlKCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IHNvcnRDb2x1bW5zQXJyYXkgPSB0aGlzLnRhYmxlLnNvcnQuZ2V0U29ydENvbHVtbnMoKTtcbiAgICBpZiAoc29ydENvbHVtbnNBcnJheS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBzb3J0Q29sdW1ucyA9IFtdO1xuICAgICAgc29ydENvbHVtbnNBcnJheS5mb3JFYWNoKHNvcnREYXRhID0+IHtcbiAgICAgICAgc29ydENvbHVtbnMucHVzaChzb3J0RGF0YS5pZCArIENvZGVzLkNPTFVNTlNfQUxJQVNfU0VQQVJBVE9SICsgc29ydERhdGEuZGlyZWN0aW9uKTtcbiAgICAgIH0pO1xuICAgICAgcmVzdWx0Wydzb3J0LWNvbHVtbnMnXSA9IHNvcnRDb2x1bW5zLmpvaW4oQ29kZXMuQVJSQVlfSU5QVVRfU0VQQVJBVE9SKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDb2x1bW5GaWx0ZXJzU3RhdGUoKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgaWYgKHRoaXMudGFibGUub1RhYmxlQ29sdW1uc0ZpbHRlckNvbXBvbmVudCkge1xuICAgICAgY29uc3QgY29sdW1uVmFsdWVGaWx0ZXJzID0gdGhpcy50YWJsZS5kYXRhU291cmNlLmdldENvbHVtblZhbHVlRmlsdGVycygpO1xuICAgICAgaWYgKGNvbHVtblZhbHVlRmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc3VsdFsnY29sdW1uLXZhbHVlLWZpbHRlcnMnXSA9IGNvbHVtblZhbHVlRmlsdGVycztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDb2x1bW5zRGlzcGxheVN0YXRlKCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IG9Db2x1bW5zRGF0YSA9IFtdO1xuICAgIHRoaXMudGFibGUub1RhYmxlT3B0aW9ucy5jb2x1bW5zLmZvckVhY2goKG9Db2w6IE9Db2x1bW4pID0+IHtcbiAgICAgIG9Db2x1bW5zRGF0YS5wdXNoKHtcbiAgICAgICAgYXR0cjogb0NvbC5hdHRyLFxuICAgICAgICB2aXNpYmxlOiBvQ29sLnZpc2libGUsXG4gICAgICAgIHdpZHRoOiBvQ29sLmdldFdpZHRoVG9TdG9yZSgpXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXN1bHRbJ29Db2x1bW5zLWRpc3BsYXknXSA9IG9Db2x1bW5zRGF0YTtcbiAgICByZXN1bHRbJ3NlbGVjdC1jb2x1bW4tdmlzaWJsZSddID0gdGhpcy50YWJsZS5vVGFibGVPcHRpb25zLnNlbGVjdENvbHVtbi52aXNpYmxlO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0Q29sdW1uc1F1aWNrRmlsdGVyU3RhdGUoKSB7XG4gICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7fTtcbiAgICBjb25zdCB0YWJsZU9wdGlvbnMgPSB0aGlzLnRhYmxlLm9UYWJsZU9wdGlvbnM7XG4gICAgY29uc3Qgb0NvbHVtbnNEYXRhID0gW107XG4gICAgdGFibGVPcHRpb25zLmNvbHVtbnMuZm9yRWFjaCgob0NvbDogT0NvbHVtbikgPT4ge1xuICAgICAgb0NvbHVtbnNEYXRhLnB1c2goe1xuICAgICAgICBhdHRyOiBvQ29sLmF0dHIsXG4gICAgICAgIHNlYXJjaGFibGU6IG9Db2wuc2VhcmNoYWJsZSxcbiAgICAgICAgc2VhcmNoaW5nOiBvQ29sLnNlYXJjaGluZ1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVzdWx0Lm9Db2x1bW5zID0gb0NvbHVtbnNEYXRhO1xuICAgIHJlc3VsdFsnZmlsdGVyLWNhc2Utc2Vuc2l0aXZlJ10gPSB0YWJsZU9wdGlvbnMuZmlsdGVyQ2FzZVNlbnNpdGl2ZTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFBhZ2VTdGF0ZSgpOiBhbnkge1xuICAgIGNvbnN0IHJlc3VsdDogYW55ID0ge1xuICAgICAgJ3F1ZXJ5LXJvd3MnOiB0aGlzLnRhYmxlLm1hdHBhZ2luYXRvciA/IHRoaXMudGFibGUubWF0cGFnaW5hdG9yLnBhZ2VTaXplIDogJydcbiAgICB9O1xuICAgIGlmICh0aGlzLnRhYmxlLmN1cnJlbnRQYWdlID4gMCAmJiB0aGlzLnRhYmxlLnN0b3JlUGFnaW5hdGlvblN0YXRlKSB7XG4gICAgICByZXN1bHQuY3VycmVudFBhZ2UgPSB0aGlzLnRhYmxlLmN1cnJlbnRQYWdlO1xuICAgIH1cbiAgICBpZiAodGhpcy50YWJsZS5wYWdlYWJsZSAmJiB0aGlzLnRhYmxlLnN0b3JlUGFnaW5hdGlvblN0YXRlKSB7XG4gICAgICBjb25zdCBzdGF0ZSA9IHRoaXMudGFibGUuc3RhdGU7XG4gICAgICByZXN1bHQudG90YWxRdWVyeVJlY29yZHNOdW1iZXIgPSBzdGF0ZS50b3RhbFF1ZXJ5UmVjb3Jkc051bWJlcjtcbiAgICAgIHJlc3VsdC5xdWVyeVJlY29yZE9mZnNldCA9IE1hdGgubWF4KFxuICAgICAgICAoc3RhdGUucXVlcnlSZWNvcmRPZmZzZXQgLSB0aGlzLnRhYmxlLmRhdGFTb3VyY2UucmVuZGVyZWREYXRhLmxlbmd0aCksXG4gICAgICAgIChzdGF0ZS5xdWVyeVJlY29yZE9mZnNldCAtIHRoaXMudGFibGUucXVlcnlSb3dzKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTZWxlY3Rpb25TdGF0ZSgpOiBhbnkge1xuICAgIGNvbnN0IHJlc3VsdDogYW55ID0ge1xuICAgICAgc2VsZWN0aW9uOiBbXVxuICAgIH07XG4gICAgaWYgKHRoaXMudGFibGUgJiYgdGhpcy50YWJsZS5rZWVwU2VsZWN0ZWRJdGVtcykge1xuICAgICAgLy8gc3RvcmluZyBzZWxlY3RlZCBpdGVtcyBrZXlzIHZhbHVlc1xuICAgICAgY29uc3Qgc2VsZWN0aW9uID0gW107XG4gICAgICB0aGlzLnRhYmxlLmdldFNlbGVjdGVkSXRlbXMoKS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0ge307XG4gICAgICAgIHRoaXMudGFibGUuZ2V0S2V5cygpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICBkYXRhW2tleV0gPSBpdGVtW2tleV07XG4gICAgICAgIH0pO1xuICAgICAgICBzZWxlY3Rpb24ucHVzaChkYXRhKTtcbiAgICAgIH0pO1xuICAgICAgcmVzdWx0LnNlbGVjdGlvbiA9IHNlbGVjdGlvbjtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRJbml0aWFsQ29uZmlndXJhdGlvblN0YXRlKCk6IGFueSB7XG4gICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgIGxldCBpbml0aWFsQ29uZmlndXJhdGlvbiA9IHt9O1xuXG4gICAgbGV0IG9Db2x1bW5zRGF0YSA9IFtdO1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIFV0aWwucGFyc2VBcnJheSh0aGlzLnRhYmxlLnZpc2libGVDb2x1bW5zLCB0cnVlKS5mb3JFYWNoKCh4OiBzdHJpbmcpID0+IHtcbiAgICAgIGxldCBvQ29sID0gc2VsZi50YWJsZS5nZXRPQ29sdW1uKHgpO1xuICAgICAgb0NvbHVtbnNEYXRhLnB1c2goe1xuICAgICAgICBhdHRyOiBvQ29sLmF0dHIsXG4gICAgICAgIHZpc2libGU6IHRydWUsXG4gICAgICAgIHdpZHRoOiBvQ29sLmRlZmluaXRpb24gPyBvQ29sLmRlZmluaXRpb24ub3JpZ2luYWxXaWR0aCA6IHVuZGVmaW5lZFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpbml0aWFsQ29uZmlndXJhdGlvblsnb0NvbHVtbnMtZGlzcGxheSddID0gb0NvbHVtbnNEYXRhO1xuICAgIGluaXRpYWxDb25maWd1cmF0aW9uWydzb3J0LWNvbHVtbnMnXSA9IHRoaXMudGFibGUuc29ydENvbHVtbnM7XG4gICAgaW5pdGlhbENvbmZpZ3VyYXRpb25bJ3NlbGVjdC1jb2x1bW4tdmlzaWJsZSddID0gdGhpcy50YWJsZS5vVGFibGVPcHRpb25zLnNlbGVjdENvbHVtbi52aXNpYmxlO1xuICAgIGluaXRpYWxDb25maWd1cmF0aW9uWydmaWx0ZXItY2FzZS1zZW5zaXRpdmUnXSA9IHRoaXMudGFibGUuZmlsdGVyQ2FzZVNlbnNpdGl2ZTtcbiAgICBpbml0aWFsQ29uZmlndXJhdGlvblsncXVlcnktcm93cyddID0gdGhpcy50YWJsZS5vcmlnaW5hbFF1ZXJ5Um93cztcblxuICAgIHJlc3VsdFsnaW5pdGlhbC1jb25maWd1cmF0aW9uJ10gPSBpbml0aWFsQ29uZmlndXJhdGlvbjtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzZXRTdG9yZWRGaWx0ZXJzKGZpbHRlcnM6IEFycmF5PE9UYWJsZUZpbHRlcnNTdGF0dXM+KSB7XG4gICAgcmV0dXJuIHRoaXMudGFibGUuc3RhdGVbT1RhYmxlU3RvcmFnZS5VU0VSX1NUT1JFRF9GSUxURVJTX0tFWV0gPSBmaWx0ZXJzO1xuICB9XG5cbiAgZ2V0U3RvcmVkRmlsdGVycygpIHtcbiAgICByZXR1cm4gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXSB8fCBbXTtcbiAgfVxuXG4gIGdldFN0b3JlZEZpbHRlcihmaWx0ZXJOYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTdG9yZWRGaWx0ZXJzKCkuZmluZCgoaXRlbTogT1RhYmxlRmlsdGVyc1N0YXR1cykgPT4gaXRlbS5uYW1lID09PSBmaWx0ZXJOYW1lKTtcbiAgfVxuXG4gIGdldFN0b3JlZEZpbHRlckNvbmYoZmlsdGVyTmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuICh0aGlzLmdldFN0b3JlZEZpbHRlcihmaWx0ZXJOYW1lKSB8fCB7fSlbT1RhYmxlU3RvcmFnZS5TVE9SRURfRklMVEVSX0tFWV07XG4gIH1cblxuICBkZWxldGVTdG9yZWRGaWx0ZXIoZmlsdGVyTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3RvcmVkRmlsdGVycyA9IHRoaXMudGFibGUuc3RhdGVbT1RhYmxlU3RvcmFnZS5VU0VSX1NUT1JFRF9GSUxURVJTX0tFWV0gfHwgW107XG4gICAgY29uc3QgaW5kZXggPSBzdG9yZWRGaWx0ZXJzLmZpbmRJbmRleCgoaXRlbTogT1RhYmxlRmlsdGVyc1N0YXR1cykgPT4gaXRlbS5uYW1lID09PSBmaWx0ZXJOYW1lKTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgc3RvcmVkRmlsdGVycy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXSA9IHN0b3JlZEZpbHRlcnM7XG4gICAgfVxuICB9XG5cbiAgc3RvcmVGaWx0ZXIoZmlsdGVyQXJnczogT1RhYmxlRmlsdGVyc1N0YXR1cykge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IHN0b3JlZEZpbHRlciA9IHt9O1xuICAgIE9iamVjdC5hc3NpZ24oc3RvcmVkRmlsdGVyLCB0aGlzLmdldENvbHVtbkZpbHRlcnNTdGF0ZSgpKTtcbiAgICBPYmplY3QuYXNzaWduKHN0b3JlZEZpbHRlciwgdGhpcy5nZXRDb2x1bW5zUXVpY2tGaWx0ZXJTdGF0ZSgpKTtcblxuICAgIHJlc3VsdFtPVGFibGVTdG9yYWdlLlNUT1JFRF9GSUxURVJfS0VZXSA9IHN0b3JlZEZpbHRlcjtcbiAgICBPYmplY3QuYXNzaWduKHJlc3VsdCwgZmlsdGVyQXJncyk7XG4gICAgY29uc3QgZXhpc3RpbmdGaWx0ZXJzID0gdGhpcy5nZXRTdG9yZWRGaWx0ZXJzKCk7XG4gICAgZXhpc3RpbmdGaWx0ZXJzLnB1c2gocmVzdWx0KTtcbiAgICB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuVVNFUl9TVE9SRURfRklMVEVSU19LRVldID0gZXhpc3RpbmdGaWx0ZXJzO1xuICB9XG5cbiAgZ2V0U3RvcmVkQ29sdW1uc0ZpbHRlcnMoYXJnPzogYW55KSB7XG4gICAgY29uc3Qgc3RhdGVPYmogPSBhcmcgfHwgdGhpcy50YWJsZS5zdGF0ZTtcbiAgICByZXR1cm4gc3RhdGVPYmpbJ2NvbHVtbi12YWx1ZS1maWx0ZXJzJ10gfHwgW107XG4gIH1cblxuICBnZXRTdG9yZWRDb25maWd1cmF0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldIHx8IFtdO1xuICB9XG5cbiAgZ2V0U3RvcmVkQ29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uTmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U3RvcmVkQ29uZmlndXJhdGlvbnMoKS5maW5kKChpdGVtOiBPVGFibGVDb25maWd1cmF0aW9uKSA9PiBpdGVtLm5hbWUgPT09IGNvbmZpZ3VyYXRpb25OYW1lKTtcbiAgfVxuXG4gIHN0b3JlQ29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uQWdzOiBPVGFibGVDb25maWd1cmF0aW9uLCB0YWJsZVByb3BlcnRpZXM6IGFueVtdKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgdGhpcy50YWJsZS5zdG9yZVBhZ2luYXRpb25TdGF0ZSA9IHRydWU7XG4gICAgY29uc3Qgc3RvcmVkQ29uZmlndXJhdGlvbiA9IHRoaXMuZ2V0VGFibGVQcm9wZXJ0aWVzVG9TdG9yZSh0YWJsZVByb3BlcnRpZXMpO1xuICAgIHRoaXMudGFibGUuc3RvcmVQYWdpbmF0aW9uU3RhdGUgPSBmYWxzZTtcblxuICAgIHJlc3VsdFtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OX0tFWV0gPSBzdG9yZWRDb25maWd1cmF0aW9uO1xuICAgIE9iamVjdC5hc3NpZ24ocmVzdWx0LCBjb25maWd1cmF0aW9uQWdzKTtcbiAgICByZXN1bHRbT1RhYmxlU3RvcmFnZS5TVE9SRURfUFJPUEVSVElFU19LRVldID0gdGFibGVQcm9wZXJ0aWVzO1xuICAgIGNvbnN0IGV4aXN0aW5nQ29uZmlndXJhdGlvbnMgPSB0aGlzLmdldFN0b3JlZENvbmZpZ3VyYXRpb25zKCk7XG4gICAgZXhpc3RpbmdDb25maWd1cmF0aW9ucy5wdXNoKHJlc3VsdCk7XG4gICAgdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldID0gZXhpc3RpbmdDb25maWd1cmF0aW9ucztcbiAgfVxuXG4gIGRlbGV0ZVN0b3JlZENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IHN0b3JlZENvbmZpZ3VyYXRpb25zID0gdGhpcy5nZXRTdG9yZWRDb25maWd1cmF0aW9ucygpO1xuICAgIGNvbnN0IGluZGV4ID0gc3RvcmVkQ29uZmlndXJhdGlvbnMuZmluZEluZGV4KChpdGVtOiBPVGFibGVDb25maWd1cmF0aW9uKSA9PiBpdGVtLm5hbWUgPT09IGNvbmZpZ3VyYXRpb25OYW1lKTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgc3RvcmVkQ29uZmlndXJhdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIHRoaXMudGFibGUuc3RhdGVbT1RhYmxlU3RvcmFnZS5TVE9SRURfQ09ORklHVVJBVElPTlNfS0VZXSA9IHN0b3JlZENvbmZpZ3VyYXRpb25zO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=