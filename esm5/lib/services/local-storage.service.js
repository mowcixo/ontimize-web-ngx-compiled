import { EventEmitter, Injectable, Injector } from '@angular/core';
import { NavigationStart, Router } from '@angular/router';
import { AppConfig } from '../config/app-config';
import { ObservableWrapper } from '../util/async';
import { Util } from '../util/util';
import { LoginStorageService } from './login-storage.service';
import * as i0 from "@angular/core";
var LocalStorageService = (function () {
    function LocalStorageService(injector) {
        this.injector = injector;
        this.onRouteChange = new EventEmitter();
        this.onSetLocalStorage = new EventEmitter();
        this._config = this.injector.get(AppConfig).getConfiguration();
        this._router = this.injector.get(Router);
        this.loginStorageService = this.injector.get(LoginStorageService);
        var self = this;
        this._router.events.subscribe(function (event) {
            if (event instanceof NavigationStart) {
                ObservableWrapper.callEmit(self.onRouteChange, {});
            }
        });
    }
    LocalStorageService.prototype.getComponentStorage = function (comp, routeKey) {
        var componentKey = comp.getComponentKey();
        var completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        return this.getAppComponentData(completeKey) || {};
    };
    LocalStorageService.prototype.updateComponentStorage = function (comp, routeKey) {
        var dataToStore = comp.getDataToStore();
        var componentKey = comp.getComponentKey();
        if (!Util.isDefined(componentKey)) {
            return;
        }
        var completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        var storedObject = {};
        for (var prop in dataToStore) {
            if (dataToStore.hasOwnProperty(prop)) {
                storedObject[prop] = dataToStore[prop];
            }
        }
        this.updateAppComponentStorage(completeKey, storedObject);
    };
    LocalStorageService.prototype.getAppComponentData = function (key) {
        var componentData;
        var storedComponents = this.getSessionUserComponentsData() || {};
        if (storedComponents[key]) {
            var decoded = atob(storedComponents[key]);
            try {
                componentData = JSON.parse(decoded);
            }
            catch (e) {
                componentData = undefined;
            }
        }
        return componentData;
    };
    LocalStorageService.prototype.updateAppComponentStorage = function (componentKey, componentData) {
        var componentDataB64;
        try {
            componentDataB64 = btoa(JSON.stringify(componentData));
        }
        catch (e) {
            componentDataB64 = undefined;
        }
        this.storeComponentInSessionUser(componentKey, componentDataB64);
    };
    LocalStorageService.prototype.getSessionUserComponentsData = function () {
        var storedComponentsByUser = {};
        var appData = this.getStoredData();
        var session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        var users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        storedComponentsByUser = (users[session.user] || {})[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        return storedComponentsByUser;
    };
    LocalStorageService.prototype.storeSessionUserComponentsData = function (componentsData) {
        var appData = this.getStoredData();
        var session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY])) {
            appData[LocalStorageService.USERS_STORAGE_KEY] = {};
        }
        var userData = appData[LocalStorageService.USERS_STORAGE_KEY][session.user] || {};
        userData[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsData;
        appData[LocalStorageService.USERS_STORAGE_KEY][session.user] = userData;
        this.setLocalStorage(appData);
    };
    LocalStorageService.prototype.storeComponentInSessionUser = function (componentKey, componentDataB64) {
        var appData = this.getStoredData();
        var session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        var users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        var idUser = session.user || this.loginStorageService.getSessionInfo().user;
        var user = users[idUser] || {};
        var componentData = {};
        if (users[idUser]) {
            componentData = users[idUser][LocalStorageService.COMPONENTS_STORAGE_KEY];
        }
        componentData[componentKey] = componentDataB64 || {};
        user[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentData;
        users[idUser] = user;
        appData[LocalStorageService.USERS_STORAGE_KEY] = users;
        this.setLocalStorage(appData);
    };
    LocalStorageService.prototype.getStoredData = function () {
        var appData = {};
        var appStoredData = localStorage.getItem(this._config.uuid);
        if (appStoredData) {
            try {
                appData = JSON.parse(appStoredData);
            }
            catch (e) {
                appData = {};
            }
        }
        return appData;
    };
    LocalStorageService.prototype.setBackwardCompatibility = function () {
        var appData = this.getStoredData();
        var session = appData[LocalStorageService.SESSION_STORAGE_KEY];
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        var componentsInfo = appData[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        var usersObject = {};
        var existsUsersTag = Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY]);
        var createUserInfo = existsUsersTag;
        if (existsUsersTag) {
            usersObject = appData[LocalStorageService.USERS_STORAGE_KEY];
            createUserInfo = !Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY][session.user]);
        }
        if (createUserInfo) {
            usersObject[session.user] = {};
            usersObject[session.user][LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsInfo;
            appData[LocalStorageService.USERS_STORAGE_KEY] = usersObject;
            localStorage.setItem(this._config.uuid, JSON.stringify(appData));
        }
    };
    LocalStorageService.prototype.setLocalStorage = function (appData) {
        this.onSetLocalStorage.emit();
        localStorage.setItem(this._config.uuid, JSON.stringify(appData));
    };
    LocalStorageService.COMPONENTS_STORAGE_KEY = 'components';
    LocalStorageService.USERS_STORAGE_KEY = 'users';
    LocalStorageService.SESSION_STORAGE_KEY = 'session';
    LocalStorageService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    LocalStorageService.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    LocalStorageService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function LocalStorageService_Factory() { return new LocalStorageService(i0.ɵɵinject(i0.INJECTOR)); }, token: LocalStorageService, providedIn: "root" });
    return LocalStorageService;
}());
export { LocalStorageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwtc3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9sb2NhbC1zdG9yYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFMUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBSWpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOztBQUU5RDtJQWVFLDZCQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBUGpDLGtCQUFhLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEQsc0JBQWlCLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFPL0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQy9ELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFbEUsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUs7WUFDakMs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QUFDLGlCQUFpQixDQUFDLEdBQUcsV0FBVyxDQUFDO1lBQzdELFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0gsQ0FBQztJQUVTLDZDQUFlLEdBQXpCLFVBQTBCLE9BQVk7UUFDcEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQzlCLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUEvSk0sMENBQXNCLEdBQVcsWUFBWSxDQUFDO0lBQzlDLHFDQUFpQixHQUFXLE9BQU8sQ0FBQztJQUNwQyx1Q0FBbUIsR0FBVyxTQUFTLENBQUM7O2dCQU5oRCxVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7Z0JBYmtDLFFBQVE7Ozs4QkFBM0M7Q0ErS0MsQUFwS0QsSUFvS0M7U0FqS1ksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmF2aWdhdGlvblN0YXJ0LCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBBcHBDb25maWcgfSBmcm9tICcuLi9jb25maWcvYXBwLWNvbmZpZyc7XG5pbXBvcnQgeyBJTG9jYWxTdG9yYWdlQ29tcG9uZW50IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9sb2NhbC1zdG9yYWdlLWNvbXBvbmVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnLi4vdHlwZXMvY29uZmlnLnR5cGUnO1xuaW1wb3J0IHsgU2Vzc2lvbkluZm8gfSBmcm9tICcuLi90eXBlcy9zZXNzaW9uLWluZm8udHlwZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlV3JhcHBlciB9IGZyb20gJy4uL3V0aWwvYXN5bmMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQgeyBMb2dpblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sb2dpbi1zdG9yYWdlLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIHtcbiAgc3RhdGljIENPTVBPTkVOVFNfU1RPUkFHRV9LRVk6IHN0cmluZyA9ICdjb21wb25lbnRzJztcbiAgc3RhdGljIFVTRVJTX1NUT1JBR0VfS0VZOiBzdHJpbmcgPSAndXNlcnMnO1xuICBzdGF0aWMgU0VTU0lPTl9TVE9SQUdFX0tFWTogc3RyaW5nID0gJ3Nlc3Npb24nO1xuXG4gIHB1YmxpYyBvblJvdXRlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHVibGljIG9uU2V0TG9jYWxTdG9yYWdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIF9jb25maWc6IENvbmZpZztcbiAgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXI7XG4gIHByaXZhdGUgbG9naW5TdG9yYWdlU2VydmljZTogTG9naW5TdG9yYWdlU2VydmljZTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XG4gICAgdGhpcy5fY29uZmlnID0gdGhpcy5pbmplY3Rvci5nZXQoQXBwQ29uZmlnKS5nZXRDb25maWd1cmF0aW9uKCk7XG4gICAgdGhpcy5fcm91dGVyID0gdGhpcy5pbmplY3Rvci5nZXQoUm91dGVyKTtcbiAgICB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2dpblN0b3JhZ2VTZXJ2aWNlKTtcblxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHRoaXMuX3JvdXRlci5ldmVudHMuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25TdGFydCkge1xuICAgICAgICBPYnNlcnZhYmxlV3JhcHBlci5jYWxsRW1pdChzZWxmLm9uUm91dGVDaGFuZ2UsIHt9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldENvbXBvbmVudFN0b3JhZ2UoY29tcDogSUxvY2FsU3RvcmFnZUNvbXBvbmVudCwgcm91dGVLZXk/OiBzdHJpbmcpOiBvYmplY3Qge1xuICAgIGNvbnN0IGNvbXBvbmVudEtleSA9IGNvbXAuZ2V0Q29tcG9uZW50S2V5KCk7XG4gICAgbGV0IGNvbXBsZXRlS2V5ID0gY29tcG9uZW50S2V5O1xuICAgIGlmIChyb3V0ZUtleSkge1xuICAgICAgY29tcGxldGVLZXkgKz0gJ18nICsgcm91dGVLZXk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldEFwcENvbXBvbmVudERhdGEoY29tcGxldGVLZXkpIHx8IHt9O1xuICB9XG5cbiAgdXBkYXRlQ29tcG9uZW50U3RvcmFnZShjb21wOiBJTG9jYWxTdG9yYWdlQ29tcG9uZW50LCByb3V0ZUtleT86IHN0cmluZykge1xuICAgIGNvbnN0IGRhdGFUb1N0b3JlID0gY29tcC5nZXREYXRhVG9TdG9yZSgpO1xuICAgIGNvbnN0IGNvbXBvbmVudEtleSA9IGNvbXAuZ2V0Q29tcG9uZW50S2V5KCk7XG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZChjb21wb25lbnRLZXkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBjb21wbGV0ZUtleSA9IGNvbXBvbmVudEtleTtcbiAgICBpZiAocm91dGVLZXkpIHtcbiAgICAgIGNvbXBsZXRlS2V5ICs9ICdfJyArIHJvdXRlS2V5O1xuICAgIH1cbiAgICBjb25zdCBzdG9yZWRPYmplY3QgPSB7fTtcbiAgICBmb3IgKGNvbnN0IHByb3AgaW4gZGF0YVRvU3RvcmUpIHtcbiAgICAgIGlmIChkYXRhVG9TdG9yZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICBzdG9yZWRPYmplY3RbcHJvcF0gPSBkYXRhVG9TdG9yZVtwcm9wXTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy51cGRhdGVBcHBDb21wb25lbnRTdG9yYWdlKGNvbXBsZXRlS2V5LCBzdG9yZWRPYmplY3QpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBcHBDb21wb25lbnREYXRhKGtleTogc3RyaW5nKTogb2JqZWN0IHtcbiAgICBsZXQgY29tcG9uZW50RGF0YTtcbiAgICBjb25zdCBzdG9yZWRDb21wb25lbnRzOiBvYmplY3QgPSB0aGlzLmdldFNlc3Npb25Vc2VyQ29tcG9uZW50c0RhdGEoKSB8fCB7fTtcbiAgICBpZiAoc3RvcmVkQ29tcG9uZW50c1trZXldKSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gYXRvYihzdG9yZWRDb21wb25lbnRzW2tleV0pO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29tcG9uZW50RGF0YSA9IEpTT04ucGFyc2UoZGVjb2RlZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbXBvbmVudERhdGEgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBjb21wb25lbnREYXRhO1xuICB9XG5cbiAgdXBkYXRlQXBwQ29tcG9uZW50U3RvcmFnZShjb21wb25lbnRLZXk6IHN0cmluZywgY29tcG9uZW50RGF0YTogb2JqZWN0KSB7XG4gICAgbGV0IGNvbXBvbmVudERhdGFCNjQ7XG4gICAgdHJ5IHtcbiAgICAgIGNvbXBvbmVudERhdGFCNjQgPSBidG9hKEpTT04uc3RyaW5naWZ5KGNvbXBvbmVudERhdGEpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb21wb25lbnREYXRhQjY0ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB0aGlzLnN0b3JlQ29tcG9uZW50SW5TZXNzaW9uVXNlcihjb21wb25lbnRLZXksIGNvbXBvbmVudERhdGFCNjQpO1xuICB9XG5cbiAgcHVibGljIGdldFNlc3Npb25Vc2VyQ29tcG9uZW50c0RhdGEoKTogb2JqZWN0IHtcbiAgICBsZXQgc3RvcmVkQ29tcG9uZW50c0J5VXNlciA9IHt9O1xuICAgIGNvbnN0IGFwcERhdGEgPSB0aGlzLmdldFN0b3JlZERhdGEoKTtcbiAgICBjb25zdCBzZXNzaW9uOiBTZXNzaW9uSW5mbyA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5TRVNTSU9OX1NUT1JBR0VfS0VZXSB8fCB7fTtcbiAgICBjb25zdCB1c2VycyA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0gfHwge307XG4gICAgc3RvcmVkQ29tcG9uZW50c0J5VXNlciA9ICh1c2Vyc1tzZXNzaW9uLnVzZXJdIHx8IHt9KVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldIHx8IHt9O1xuICAgIHJldHVybiBzdG9yZWRDb21wb25lbnRzQnlVc2VyO1xuICB9XG5cbiAgcHVibGljIHN0b3JlU2Vzc2lvblVzZXJDb21wb25lbnRzRGF0YShjb21wb25lbnRzRGF0YTogb2JqZWN0KSB7XG4gICAgY29uc3QgYXBwRGF0YSA9IHRoaXMuZ2V0U3RvcmVkRGF0YSgpO1xuICAgIGNvbnN0IHNlc3Npb246IFNlc3Npb25JbmZvID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlNFU1NJT05fU1RPUkFHRV9LRVldIHx8IHt9O1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQoYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSkpIHtcbiAgICAgIGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0gPSB7fTtcbiAgICB9XG4gICAgY29uc3QgdXNlckRhdGEgPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldW3Nlc3Npb24udXNlcl0gfHwge307XG4gICAgdXNlckRhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5DT01QT05FTlRTX1NUT1JBR0VfS0VZXSA9IGNvbXBvbmVudHNEYXRhO1xuICAgIGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV1bc2Vzc2lvbi51c2VyXSA9IHVzZXJEYXRhO1xuICAgIHRoaXMuc2V0TG9jYWxTdG9yYWdlKGFwcERhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdG9yZUNvbXBvbmVudEluU2Vzc2lvblVzZXIoY29tcG9uZW50S2V5LCBjb21wb25lbnREYXRhQjY0KSB7XG4gICAgY29uc3QgYXBwRGF0YSA9IHRoaXMuZ2V0U3RvcmVkRGF0YSgpO1xuICAgIGNvbnN0IHNlc3Npb24gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuU0VTU0lPTl9TVE9SQUdFX0tFWV0gfHwge307IC8vIHV1aWQgLT4gc2Vzc2lvblxuICAgIGlmICghVXRpbC5pc0RlZmluZWQoc2Vzc2lvbikgfHwgIVV0aWwuaXNEZWZpbmVkKHNlc3Npb24udXNlcikpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdXNlcnMgPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldIHx8IHt9OyAvLyB1dWlkIC0+IHVzZXJzXG4gICAgY29uc3QgaWRVc2VyID0gc2Vzc2lvbi51c2VyIHx8IHRoaXMubG9naW5TdG9yYWdlU2VydmljZS5nZXRTZXNzaW9uSW5mbygpLnVzZXI7XG4gICAgY29uc3QgdXNlciA9IHVzZXJzW2lkVXNlcl0gfHwge307IC8vIHV1aWQgLT4gdXNlcnMtPiB1c2VyXG5cbiAgICBsZXQgY29tcG9uZW50RGF0YSA9IHt9O1xuICAgIGlmICh1c2Vyc1tpZFVzZXJdKSB7XG4gICAgICBjb21wb25lbnREYXRhID0gdXNlcnNbaWRVc2VyXVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldO1xuICAgIH1cbiAgICBjb21wb25lbnREYXRhW2NvbXBvbmVudEtleV0gPSBjb21wb25lbnREYXRhQjY0IHx8IHt9O1xuXG4gICAgdXNlcltMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldID0gY29tcG9uZW50RGF0YTtcbiAgICB1c2Vyc1tpZFVzZXJdID0gdXNlcjtcbiAgICBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldID0gdXNlcnM7XG5cbiAgICB0aGlzLnNldExvY2FsU3RvcmFnZShhcHBEYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTdG9yZWREYXRhKCk6IG9iamVjdCB7XG4gICAgbGV0IGFwcERhdGEgPSB7fTtcbiAgICBjb25zdCBhcHBTdG9yZWREYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5fY29uZmlnLnV1aWQpO1xuICAgIGlmIChhcHBTdG9yZWREYXRhKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhcHBEYXRhID0gSlNPTi5wYXJzZShhcHBTdG9yZWREYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgYXBwRGF0YSA9IHt9O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYXBwRGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRCYWNrd2FyZENvbXBhdGliaWxpdHkoKSB7XG4gICAgY29uc3QgYXBwRGF0YSA9IHRoaXMuZ2V0U3RvcmVkRGF0YSgpO1xuICAgIGNvbnN0IHNlc3Npb24gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuU0VTU0lPTl9TVE9SQUdFX0tFWV07XG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZChzZXNzaW9uKSB8fCAhVXRpbC5pc0RlZmluZWQoc2Vzc2lvbi51c2VyKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjb21wb25lbnRzSW5mbyA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5DT01QT05FTlRTX1NUT1JBR0VfS0VZXSB8fCB7fTtcbiAgICBsZXQgdXNlcnNPYmplY3QgPSB7fTtcbiAgICBjb25zdCBleGlzdHNVc2Vyc1RhZyA9IFV0aWwuaXNEZWZpbmVkKGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0pO1xuICAgIGxldCBjcmVhdGVVc2VySW5mbyA9IGV4aXN0c1VzZXJzVGFnO1xuICAgIGlmIChleGlzdHNVc2Vyc1RhZykge1xuICAgICAgdXNlcnNPYmplY3QgPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldO1xuICAgICAgY3JlYXRlVXNlckluZm8gPSAhVXRpbC5pc0RlZmluZWQoYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXVtzZXNzaW9uLnVzZXJdKTtcbiAgICB9XG4gICAgaWYgKGNyZWF0ZVVzZXJJbmZvKSB7XG4gICAgICB1c2Vyc09iamVjdFtzZXNzaW9uLnVzZXJdID0ge307XG4gICAgICB1c2Vyc09iamVjdFtzZXNzaW9uLnVzZXJdW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gPSBjb21wb25lbnRzSW5mbztcblxuICAgICAgYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSA9IHVzZXJzT2JqZWN0O1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5fY29uZmlnLnV1aWQsIEpTT04uc3RyaW5naWZ5KGFwcERhdGEpKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0TG9jYWxTdG9yYWdlKGFwcERhdGE6IGFueSkge1xuICAgIHRoaXMub25TZXRMb2NhbFN0b3JhZ2UuZW1pdCgpO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuX2NvbmZpZy51dWlkLCBKU09OLnN0cmluZ2lmeShhcHBEYXRhKSk7XG4gIH1cbn1cblxuIl19