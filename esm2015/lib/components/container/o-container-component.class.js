import { ElementRef, Inject, Injector, Optional, ViewChild, } from '@angular/core';
import { MAT_FORM_FIELD_DEFAULT_OPTIONS } from '@angular/material';
import { Util } from '../../util/util';
export const DEFAULT_INPUTS_O_CONTAINER = [
    'oattr: attr',
    'title',
    'layoutAlign: layout-align',
    'elevation',
    'icon',
    'appearance',
    'layoutGap: layout-gap'
];
export class OContainerComponent {
    constructor(elRef, injector, matFormDefaultOption) {
        this.elRef = elRef;
        this.injector = injector;
        this.matFormDefaultOption = matFormDefaultOption;
        this._elevation = 0;
        this.defaultLayoutAlign = 'start start';
        this._outlineGapCalculationNeededImmediately = false;
        this.titleObserver = new MutationObserver(() => this.updateOutlineGap());
    }
    set containerTitle(elem) {
        this._titleEl = elem;
        if (this._titleEl) {
            this.registerObserver();
            this.updateOutlineGap();
        }
        else {
            this.unRegisterObserver();
        }
    }
    ngAfterViewInit() {
        if (this.elRef) {
            this.elRef.nativeElement.removeAttribute('title');
        }
        this.registerObserver();
    }
    ngAfterContentChecked() {
        if (this._outlineGapCalculationNeededImmediately) {
            this.updateOutlineGap();
        }
    }
    ngOnDestroy() {
        this.unRegisterObserver();
    }
    getAttribute() {
        if (this.oattr) {
            return this.oattr;
        }
        else if (this.elRef && this.elRef.nativeElement.attributes.attr) {
            return this.elRef.nativeElement.attributes.attr.value;
        }
    }
    get appearance() {
        return this._appearance;
    }
    set appearance(value) {
        this._appearance = value;
        setTimeout(() => { this.updateOutlineGap(); }, 0);
    }
    get elevation() {
        return this._elevation;
    }
    set elevation(elevation) {
        this._elevation = elevation;
        this.propagateElevationToDOM();
    }
    get layoutAlign() {
        return this._layoutAlign;
    }
    set layoutAlign(align) {
        if (!align || align.length === 0) {
            align = this.defaultLayoutAlign;
        }
        this._layoutAlign = align;
    }
    get layoutGap() {
        return this._layoutGap;
    }
    set layoutGap(layoutGap) {
        this._layoutGap = layoutGap;
    }
    hasHeader() {
        return !!this.title || !!this.icon;
    }
    isAppearanceOutline() {
        let isAppearanceOutline = (this.matFormDefaultOption && this.matFormDefaultOption.appearance === OContainerComponent.APPEARANCE_OUTLINE);
        if (Util.isDefined(this.appearance)) {
            isAppearanceOutline = this.appearance === OContainerComponent.APPEARANCE_OUTLINE;
        }
        return isAppearanceOutline;
    }
    hasTitleInAppearanceOutline() {
        return this.isAppearanceOutline() && this.hasHeader();
    }
    propagateElevationToDOM() {
        this.cleanElevationCSSclasses();
        if (this.elevation > 0 && this.elevation <= 12) {
            this.elRef.nativeElement.classList.add('mat-elevation-z' + this.elevation);
        }
    }
    cleanElevationCSSclasses() {
        const classList = [].slice.call(this.elRef.nativeElement.classList);
        if (classList && classList.length) {
            classList.forEach((item) => {
                if (item.startsWith('mat-elevation')) {
                    this.elRef.nativeElement.classList.remove(item);
                }
            });
        }
    }
    updateOutlineGap() {
        if (this.isAppearanceOutline()) {
            const titleEl = this._titleEl ? this._titleEl.nativeElement : null;
            if (!this._containerRef) {
                return;
            }
            if (document.documentElement && !document.documentElement.contains(this.elRef.nativeElement)) {
                this._outlineGapCalculationNeededImmediately = true;
                return;
            }
            const container = this._containerRef.nativeElement;
            const containerRect = container.getBoundingClientRect();
            if (containerRect.width === 0 && containerRect.height === 0) {
                return;
            }
            const containerStart = containerRect.left;
            const labelStart = titleEl.getBoundingClientRect().left;
            const labelWidth = this.hasHeader() ? titleEl.offsetWidth : 0;
            const startWidth = labelStart - containerStart;
            const startEls = container.querySelectorAll('.o-container-outline-start');
            const gapEls = container.querySelectorAll('.o-container-outline-gap');
            gapEls[0].style.width = `${labelWidth}px`;
            startEls[0].style.width = `${startWidth}px`;
            this._outlineGapCalculationNeededImmediately = false;
        }
    }
    registerObserver() {
        if (this._titleEl) {
            this.titleObserver.observe(this._titleEl.nativeElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }
    }
    unRegisterObserver() {
        if (this.titleObserver) {
            this.titleObserver.disconnect();
        }
    }
}
OContainerComponent.APPEARANCE_OUTLINE = 'outline';
OContainerComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Injector },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [MAT_FORM_FIELD_DEFAULT_OPTIONS,] }] }
];
OContainerComponent.propDecorators = {
    containerTitle: [{ type: ViewChild, args: ['containerTitle', { static: false },] }],
    _containerRef: [{ type: ViewChild, args: ['container', { static: false },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1jb250YWluZXItY29tcG9uZW50LmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2NvbnRhaW5lci9vLWNvbnRhaW5lci1jb21wb25lbnQuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUdMLFVBQVUsRUFDVixNQUFNLEVBQ04sUUFBUSxFQUVSLFFBQVEsRUFDUixTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbkUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXZDLE1BQU0sQ0FBQyxNQUFNLDBCQUEwQixHQUFHO0lBQ3hDLGFBQWE7SUFDYixPQUFPO0lBQ1AsMkJBQTJCO0lBQzNCLFdBQVc7SUFDWCxNQUFNO0lBQ04sWUFBWTtJQUNaLHVCQUF1QjtDQUN4QixDQUFDO0FBRUYsTUFBTSxPQUFPLG1CQUFtQjtJQTZCOUIsWUFDWSxLQUFpQixFQUNqQixRQUFrQixFQUNrQyxvQkFBb0I7UUFGeEUsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUNqQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2tDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBQTtRQXpCMUUsZUFBVSxHQUFXLENBQUMsQ0FBQztRQUN2Qix1QkFBa0IsR0FBVyxhQUFhLENBQUM7UUFLN0MsNENBQXVDLEdBQUcsS0FBSyxDQUFDO1FBRTlDLGtCQUFhLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO0lBa0IxRSxDQUFDO0lBZkwsSUFBb0QsY0FBYyxDQUFDLElBQWdCO1FBQ2pGLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixJQUFJ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QUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RELFNBQVMsRUFBRSxJQUFJO2dCQUNmLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixPQUFPLEVBQUUsSUFBSTthQUNkLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVTLGtCQUFrQjtRQUMxQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNqQztJQUNILENBQUM7O0FBOUthLHNDQUFrQixHQUFHLFNBQVMsQ0FBQzs7WUF2QjdDLFVBQVU7WUFFVixRQUFROzRDQW1ETCxRQUFRLFlBQUksTUFBTSxTQUFDLDhCQUE4Qjs7OzZCQWRuRCxTQUFTLFNBQUMsZ0JBQWdCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFOzRCQVM3QyxTQUFTLFNBQUMsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyQ29udGVudENoZWNrZWQsXG4gIEFmdGVyVmlld0luaXQsXG4gIEVsZW1lbnRSZWYsXG4gIEluamVjdCxcbiAgSW5qZWN0b3IsXG4gIE9uRGVzdHJveSxcbiAgT3B0aW9uYWwsXG4gIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNQVRfRk9STV9GSUVMRF9ERUZBVUxUX09QVElPTlMgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5cbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi91dGlsL3V0aWwnO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9JTlBVVFNfT19DT05UQUlORVIgPSBbXG4gICdvYXR0cjogYXR0cicsXG4gICd0aXRsZScsXG4gICdsYXlvdXRBbGlnbjogbGF5b3V0LWFsaWduJyxcbiAgJ2VsZXZhdGlvbicsXG4gICdpY29uJyxcbiAgJ2FwcGVhcmFuY2UnLFxuICAnbGF5b3V0R2FwOiBsYXlvdXQtZ2FwJ1xuXTtcblxuZXhwb3J0IGNsYXNzIE9Db250YWluZXJDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIEFmdGVyQ29udGVudENoZWNrZWQge1xuXG4gIHB1YmxpYyBzdGF0aWMgQVBQRUFSQU5DRV9PVVRMSU5FID0gJ291dGxpbmUnO1xuXG4gIHB1YmxpYyBvYXR0cjogc3RyaW5nO1xuXG4gIHB1YmxpYyB0aXRsZTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX2VsZXZhdGlvbjogbnVtYmVyID0gMDtcbiAgcHJvdGVjdGVkIGRlZmF1bHRMYXlvdXRBbGlnbjogc3RyaW5nID0gJ3N0YXJ0IHN0YXJ0JztcbiAgcHJvdGVjdGVkIF9sYXlvdXRBbGlnbjogc3RyaW5nO1xuICBwdWJsaWMgaWNvbjogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX2FwcGVhcmFuY2U6IHN0cmluZztcbiAgcHJvdGVjdGVkIF9sYXlvdXRHYXA6IHN0cmluZztcbiAgcHJpdmF0ZSBfb3V0bGluZUdhcENhbGN1bGF0aW9uTmVlZGVkSW1tZWRpYXRlbHkgPSBmYWxzZTtcblxuICBwcm90ZWN0ZWQgdGl0bGVPYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCgpID0+IHRoaXMudXBkYXRlT3V0bGluZUdhcCgpKTtcblxuICBwcm90ZWN0ZWQgX3RpdGxlRWw6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2NvbnRhaW5lclRpdGxlJywgeyBzdGF0aWM6IGZhbHNlIH0pIHNldCBjb250YWluZXJUaXRsZShlbGVtOiBFbGVtZW50UmVmKSB7XG4gICAgdGhpcy5fdGl0bGVFbCA9IGVsZW07XG4gICAgaWYgKHRoaXMuX3RpdGxlRWwpIHtcbiAgICAgIHRoaXMucmVnaXN0ZXJPYnNlcnZlcigpO1xuICAgICAgdGhpcy51cGRhdGVPdXRsaW5lR2FwKCk7IC8vIFRoaXMgbXVzdCBiZSB0cmlnZ2VyZWQgd2hlbiB0aXRsZSBjb250YWluZXIgaXMgcmUtcmVnaXN0ZXJlZFxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVuUmVnaXN0ZXJPYnNlcnZlcigpO1xuICAgIH1cbiAgfVxuICBAVmlld0NoaWxkKCdjb250YWluZXInLCB7IHN0YXRpYzogZmFsc2UgfSkgcHJvdGVjdGVkIF9jb250YWluZXJSZWY6IEVsZW1lbnRSZWY7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGVsUmVmOiBFbGVtZW50UmVmLFxuICAgIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChNQVRfRk9STV9GSUVMRF9ERUZBVUxUX09QVElPTlMpIHByb3RlY3RlZCBtYXRGb3JtRGVmYXVsdE9wdGlvblxuICApIHsgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5lbFJlZikge1xuICAgICAgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3Rlck9ic2VydmVyKCk7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudENoZWNrZWQoKSB7XG4gICAgaWYgKHRoaXMuX291dGxpbmVHYXBDYWxjdWxhdGlvbk5lZWRlZEltbWVkaWF0ZWx5KSB7XG4gICAgICB0aGlzLnVwZGF0ZU91dGxpbmVHYXAoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnVuUmVnaXN0ZXJPYnNlcnZlcigpO1xuICB9XG5cbiAgcHVibGljIGdldEF0dHJpYnV0ZSgpIHtcbiAgICBpZiAodGhpcy5vYXR0cikge1xuICAgICAgcmV0dXJuIHRoaXMub2F0dHI7XG4gICAgfSBlbHNlIGlmICh0aGlzLmVsUmVmICYmIHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5hdHRyaWJ1dGVzLmF0dHIpIHtcbiAgICAgIHJldHVybiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQuYXR0cmlidXRlcy5hdHRyLnZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIGdldCBhcHBlYXJhbmNlKCkge1xuICAgIHJldHVybiB0aGlzLl9hcHBlYXJhbmNlO1xuICB9XG5cbiAgc2V0IGFwcGVhcmFuY2UodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMuX2FwcGVhcmFuY2UgPSB2YWx1ZTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy51cGRhdGVPdXRsaW5lR2FwKCk7IH0sIDApO1xuICB9XG5cbiAgZ2V0IGVsZXZhdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fZWxldmF0aW9uO1xuICB9XG5cbiAgc2V0IGVsZXZhdGlvbihlbGV2YXRpb246IG51bWJlcikge1xuICAgIHRoaXMuX2VsZXZhdGlvbiA9IGVsZXZhdGlvbjtcbiAgICB0aGlzLnByb3BhZ2F0ZUVsZXZhdGlvblRvRE9NKCk7XG4gIH1cblxuICBnZXQgbGF5b3V0QWxpZ24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xheW91dEFsaWduO1xuICB9XG5cbiAgc2V0IGxheW91dEFsaWduKGFsaWduOiBzdHJpbmcpIHtcbiAgICBpZiAoIWFsaWduIHx8IGFsaWduLmxlbmd0aCA9PT0gMCkge1xuICAgICAgYWxpZ24gPSB0aGlzLmRlZmF1bHRMYXlvdXRBbGlnbjtcbiAgICB9XG4gICAgdGhpcy5fbGF5b3V0QWxpZ24gPSBhbGlnbjtcbiAgfVxuXG4gIGdldCBsYXlvdXRHYXAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2xheW91dEdhcDtcbiAgfVxuXG4gIHNldCBsYXlvdXRHYXAobGF5b3V0R2FwOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9sYXlvdXRHYXAgPSBsYXlvdXRHYXA7XG4gIH1cblxuICBwdWJsaWMgaGFzSGVhZGVyKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMudGl0bGUgfHwgISF0aGlzLmljb247XG4gIH1cblxuICBwdWJsaWMgaXNBcHBlYXJhbmNlT3V0bGluZSgpOiBib29sZWFuIHtcbiAgICBsZXQgaXNBcHBlYXJhbmNlT3V0bGluZSA9ICh0aGlzLm1hdEZvcm1EZWZhdWx0T3B0aW9uICYmIHRoaXMubWF0Rm9ybURlZmF1bHRPcHRpb24uYXBwZWFyYW5jZSA9PT0gT0NvbnRhaW5lckNvbXBvbmVudC5BUFBFQVJBTkNFX09VVExJTkUpO1xuICAgIGlmIChVdGlsLmlzRGVmaW5lZCh0aGlzLmFwcGVhcmFuY2UpKSB7XG4gICAgICBpc0FwcGVhcmFuY2VPdXRsaW5lID0gdGhpcy5hcHBlYXJhbmNlID09PSBPQ29udGFpbmVyQ29tcG9uZW50LkFQUEVBUkFOQ0VfT1VUTElORTtcbiAgICB9XG4gICAgcmV0dXJuIGlzQXBwZWFyYW5jZU91dGxpbmU7XG4gIH1cblxuICBwdWJsaWMgaGFzVGl0bGVJbkFwcGVhcmFuY2VPdXRsaW5lKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzQXBwZWFyYW5jZU91dGxpbmUoKSAmJiB0aGlzLmhhc0hlYWRlcigpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHByb3BhZ2F0ZUVsZXZhdGlvblRvRE9NKCk6IHZvaWQge1xuICAgIHRoaXMuY2xlYW5FbGV2YXRpb25DU1NjbGFzc2VzKCk7XG4gICAgaWYgKHRoaXMuZWxldmF0aW9uID4gMCAmJiB0aGlzLmVsZXZhdGlvbiA8PSAxMikge1xuICAgICAgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ21hdC1lbGV2YXRpb24teicgKyB0aGlzLmVsZXZhdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGNsZWFuRWxldmF0aW9uQ1NTY2xhc3NlcygpOiB2b2lkIHtcbiAgICBjb25zdCBjbGFzc0xpc3QgPSBbXS5zbGljZS5jYWxsKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5jbGFzc0xpc3QpO1xuICAgIGlmIChjbGFzc0xpc3QgJiYgY2xhc3NMaXN0Lmxlbmd0aCkge1xuICAgICAgY2xhc3NMaXN0LmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAoaXRlbS5zdGFydHNXaXRoKCdtYXQtZWxldmF0aW9uJykpIHtcbiAgICAgICAgICB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZU91dGxpbmVHYXAoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNBcHBlYXJhbmNlT3V0bGluZSgpKSB7XG4gICAgICBjb25zdCB0aXRsZUVsID0gdGhpcy5fdGl0bGVFbCA/IHRoaXMuX3RpdGxlRWwubmF0aXZlRWxlbWVudCA6IG51bGw7XG5cbiAgICAgIGlmICghdGhpcy5fY29udGFpbmVyUmVmKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgIWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb250YWlucyh0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQpKSB7XG4gICAgICAgIHRoaXMuX291dGxpbmVHYXBDYWxjdWxhdGlvbk5lZWRlZEltbWVkaWF0ZWx5ID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLl9jb250YWluZXJSZWYubmF0aXZlRWxlbWVudDtcbiAgICAgIGNvbnN0IGNvbnRhaW5lclJlY3QgPSBjb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICBpZiAoY29udGFpbmVyUmVjdC53aWR0aCA9PT0gMCAmJiBjb250YWluZXJSZWN0LmhlaWdodCA9PT0gMCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRhaW5lclN0YXJ0ID0gY29udGFpbmVyUmVjdC5sZWZ0O1xuICAgICAgY29uc3QgbGFiZWxTdGFydCA9IHRpdGxlRWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDtcbiAgICAgIGNvbnN0IGxhYmVsV2lkdGggPSB0aGlzLmhhc0hlYWRlcigpID8gdGl0bGVFbC5vZmZzZXRXaWR0aCA6IDA7XG4gICAgICBjb25zdCBzdGFydFdpZHRoID0gbGFiZWxTdGFydCAtIGNvbnRhaW5lclN0YXJ0O1xuXG4gICAgICBjb25zdCBzdGFydEVscyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCcuby1jb250YWluZXItb3V0bGluZS1zdGFydCcpO1xuICAgICAgY29uc3QgZ2FwRWxzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoJy5vLWNvbnRhaW5lci1vdXRsaW5lLWdhcCcpO1xuICAgICAgZ2FwRWxzWzBdLnN0eWxlLndpZHRoID0gYCR7bGFiZWxXaWR0aH1weGA7XG4gICAgICBzdGFydEVsc1swXS5zdHlsZS53aWR0aCA9IGAke3N0YXJ0V2lkdGh9cHhgO1xuICAgICAgdGhpcy5fb3V0bGluZUdhcENhbGN1bGF0aW9uTmVlZGVkSW1tZWRpYXRlbHkgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVnaXN0ZXJPYnNlcnZlcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdGl0bGVFbCkge1xuICAgICAgdGhpcy50aXRsZU9ic2VydmVyLm9ic2VydmUodGhpcy5fdGl0bGVFbC5uYXRpdmVFbGVtZW50LCB7XG4gICAgICAgIGNoaWxkTGlzdDogdHJ1ZSxcbiAgICAgICAgY2hhcmFjdGVyRGF0YTogdHJ1ZSxcbiAgICAgICAgc3VidHJlZTogdHJ1ZVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHVuUmVnaXN0ZXJPYnNlcnZlcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50aXRsZU9ic2VydmVyKSB7XG4gICAgICB0aGlzLnRpdGxlT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=