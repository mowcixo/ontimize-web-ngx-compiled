import { Codes } from '../../../util/codes';
export class OFileUploader {
    constructor(service, entity) {
        this.service = service;
        this.files = [];
        this.isUploading = false;
        this.progress = 0;
        this.nextIndex = 0;
        this.splitUpload = true;
        this.entity = entity;
    }
    addFile(fileItem) {
        this.files.push(fileItem);
        this.progress = this._getTotalProgress();
    }
    clear() {
        this.cancel();
        while (this.files.length) {
            this.files[0].remove();
        }
        this.progress = 0;
    }
    removeFile(value) {
        const index = this.getIndexOfItem(value);
        const item = this.files[index];
        if (item) {
            if (item.isUploading) {
                item.cancel();
            }
            this.files.splice(index, 1);
            this.progress = this._getTotalProgress();
        }
    }
    upload() {
        this.files.forEach((item) => {
            if (item.pendingUpload) {
                item.prepareToUpload();
            }
        });
        if (this.splitUpload) {
            this.files.forEach((item) => {
                if (item.pendingUpload) {
                    this.uploadItem(item);
                }
            });
        }
        else {
            this.uploadItems(this.files);
        }
    }
    uploadItem(item) {
        item.prepareToUpload();
        if (this.isUploading || item.isUploading) {
            return;
        }
        this.isUploading = true;
        item.isUploading = true;
        this._onBeforeUploadItem(item);
        if (this.service === undefined) {
            console.warn('No service configured! aborting upload');
            return;
        }
        if (this._uploadSuscription) {
            this._uploadSuscription.unsubscribe();
        }
        const self = this;
        this._uploadSuscription = item._uploadSuscription = this.service.upload([item], this.entity, this.data).subscribe(resp => {
            if (resp.loaded && resp.total) {
                const progress = Math.round(resp.loaded * 100 / resp.total);
                self._onProgressItem(item, progress);
            }
            else if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                self._onSuccessItem(item, resp);
            }
            else {
                console.error('uploadItem error');
                self._onErrorItem(item, 'Unknow error');
            }
        }, err => self._onErrorItem(item, err), () => self._onCompleteItem(item));
    }
    uploadItems(items) {
        if (this.isUploading || items.some(item => item.isUploading)) {
            return;
        }
        this.isUploading = true;
        this._onBeforeUploadAll();
        if (this.service === undefined) {
            console.warn('No service configured! aborting upload');
            return;
        }
        if (this._uploadSuscription) {
            this._uploadSuscription.unsubscribe();
        }
        const self = this;
        this._uploadSuscription = this.service.upload(items, this.entity, this.data).subscribe(resp => {
            if (resp.loaded && resp.total) {
                const progress = Math.round(resp.loaded * 100 / resp.total);
                self._onProgressAll(progress);
            }
            else if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                self._onSuccessAll(resp);
            }
            else {
                console.error('uploadItems error');
            }
        }, err => self._onErrorAll(err), () => self._onCompleteAll());
    }
    cancel() {
        if (this.splitUpload) {
            this.files.forEach(item => item.cancel());
        }
        else {
            if (this._uploadSuscription) {
                this._uploadSuscription.unsubscribe();
            }
            this._onCancelAll();
            this._onCompleteAll();
        }
    }
    cancelItem(value) {
        const index = this.getIndexOfItem(value);
        const item = this.files[index];
        if (item && item.isUploading && this.splitUpload) {
            item._uploadSuscription.unsubscribe();
        }
        this._onCancelItem(item);
        this._onCompleteItem(item);
    }
    getNotUploadedItems() {
        return this.files.filter((item) => !item.isUploaded);
    }
    getIndexOfItem(value) {
        return typeof value === 'number' ? value : this.files.indexOf(value);
    }
    onBeforeUploadItem(fileItem) {
        return { fileItem };
    }
    onBeforeUploadAll() {
        return {};
    }
    onProgressItem(fileItem, progress) {
        return { fileItem, progress };
    }
    onProgressAll(progress) {
        return { progress };
    }
    onCancelItem(fileItem) {
        return { fileItem };
    }
    onCancelAll() {
        return {};
    }
    onSuccessItem(fileItem, response) {
        return { fileItem, response };
    }
    onSuccessAll(response) {
        return { response };
    }
    onErrorItem(fileItem, error) {
        return { fileItem, error };
    }
    onErrorAll(error) {
        return { error };
    }
    onCompleteItem(fileItem) {
        return { fileItem };
    }
    onCompleteAll() {
        return void 0;
    }
    _onBeforeUploadItem(item) {
        item._onBeforeUpload();
        this.onBeforeUploadItem(item);
    }
    _onBeforeUploadAll() {
        this.files.forEach(item => item._onBeforeUpload(false));
        this.onBeforeUploadAll();
    }
    _onProgressItem(item, progress) {
        const total = this._getTotalProgress(progress);
        this.progress = total;
        item._onProgress(progress);
        this.onProgressItem(item, progress);
        this.onProgressAll(total);
    }
    _onProgressAll(progress) {
        const total = this._getTotalProgress(progress);
        this.progress = total;
        this.onProgressAll(total);
    }
    _onSuccessItem(item, response) {
        item._onSuccess(response);
        this.onSuccessItem(item, response);
    }
    _onSuccessAll(response) {
        this.files.forEach(item => item._onSuccess(response, false));
        this.onSuccessAll(response);
    }
    _onErrorItem(item, error) {
        item._onError(error);
        this.onErrorItem(item, error);
    }
    _onErrorAll(error) {
        this.files.forEach(item => item._onError(error, false));
        this.onErrorAll(error);
    }
    _onCancelItem(item) {
        item._onCancel();
        this.onCancelItem(item);
    }
    _onCancelAll() {
        this.files.forEach(item => item._onCancel(false));
        this.onCancelAll();
    }
    _onCompleteItem(item) {
        item._onComplete();
        this.onCompleteItem(item);
        const nextItem = this._getReadyItems()[0];
        this.isUploading = false;
        if (nextItem) {
            nextItem.upload();
            return;
        }
        this.onCompleteAll();
        this.progress = this._getTotalProgress();
    }
    _onCompleteAll() {
        this.files.forEach(item => item._onComplete(false));
        this.isUploading = false;
        this.onCompleteAll();
        this.progress = this._getTotalProgress();
    }
    _getReadyItems() {
        return this.files
            .filter((item) => (item.isReady && !item.isUploading))
            .sort((item1, item2) => item1.index - item2.index);
    }
    _getTotalProgress(value = 0) {
        const notUploaded = this.getNotUploadedItems().length;
        const uploaded = notUploaded ? this.files.length - notUploaded : this.files.length;
        const ratio = this.splitUpload ? 100 / this.files.length : 100;
        const current = value * ratio / 100;
        return Math.round(uploaded * ratio + current);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1maWxlLXVwbG9hZGVyLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2lucHV0L2ZpbGUtaW5wdXQvby1maWxlLXVwbG9hZGVyLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUc1QyxNQUFNLE9BQU8sYUFBYTtJQVl4QixZQUNZLE9BQXFCLEVBQy9CLE1BQWM7UUFESixZQUFPLEdBQVAsT0FBTyxDQUFjO1FBVjFCLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGFBQVEsR0FBVyxDQUFDLENBQUM7UUFDckIsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixnQkFBVyxHQUFZLElBQUksQ0FBQztRQVNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRU0sT0FBTyxDQUFDLFFBQW1CO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDM0MsQ0FBQztJQUtELEtBQUs7UUFDSCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDeEI7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBTUQsVUFBVSxDQUFDLEtBQVU7UUFDbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxNQUFNLElBQUksR0FBRyxJQUFJ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S0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBQy9ELE1BQU0sT0FBTyxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ3BDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBSyxHQUFHLE9BQU8sQ0FBQyxDQUFDO0lBQ2hELENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBJRmlsZVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL2ZpbGUtc2VydmljZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi8uLi8uLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IE9GaWxlSXRlbSB9IGZyb20gJy4vby1maWxlLWl0ZW0uY2xhc3MnO1xuXG5leHBvcnQgY2xhc3MgT0ZpbGVVcGxvYWRlciB7XG5cbiAgcHVibGljIGVudGl0eTogc3RyaW5nO1xuICBwdWJsaWMgZmlsZXM6IE9GaWxlSXRlbVtdID0gW107XG4gIHB1YmxpYyBpc1VwbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBwdWJsaWMgcHJvZ3Jlc3M6IG51bWJlciA9IDA7XG4gIHB1YmxpYyBuZXh0SW5kZXg6IG51bWJlciA9IDA7XG4gIHB1YmxpYyBzcGxpdFVwbG9hZDogYm9vbGVhbiA9IHRydWU7XG4gIHB1YmxpYyBkYXRhOiBvYmplY3Q7XG5cbiAgcHJvdGVjdGVkIF91cGxvYWRTdXNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBzZXJ2aWNlOiBJRmlsZVNlcnZpY2UsXG4gICAgZW50aXR5OiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy5lbnRpdHkgPSBlbnRpdHk7XG4gIH1cblxuICBwdWJsaWMgYWRkRmlsZShmaWxlSXRlbTogT0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5wdXNoKGZpbGVJdGVtKTtcbiAgICB0aGlzLnByb2dyZXNzID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbmNlbHMgdGhlIHVwbG9hZCBvZiBhbGwgZmlsZXMgYW5kIHJlbW92ZSB0aGVtIGZyb20gdGhlIGZpbGUgbGlzdC5cbiAgICovXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuY2FuY2VsKCk7XG4gICAgd2hpbGUgKHRoaXMuZmlsZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmZpbGVzWzBdLnJlbW92ZSgpO1xuICAgIH1cbiAgICB0aGlzLnByb2dyZXNzID0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGEgZmlsZSBmcm9tIHRoZSBmaWxlIGxpc3QsIGl0IGNhbmNlbHMgdXBsb2FkIGlmIG5lZWRlZC5cbiAgICogQHBhcmFtIHZhbHVlIHRoZSBmaWxlIHRvIHJlbW92ZVxuICAgKi9cbiAgcmVtb3ZlRmlsZSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldEluZGV4T2ZJdGVtKHZhbHVlKTtcbiAgICBjb25zdCBpdGVtID0gdGhpcy5maWxlc1tpbmRleF07XG4gICAgaWYgKGl0ZW0pIHtcbiAgICAgIGlmIChpdGVtLmlzVXBsb2FkaW5nKSB7XG4gICAgICAgIGl0ZW0uY2FuY2VsKCk7XG4gICAgICB9XG4gICAgICB0aGlzLmZpbGVzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB0aGlzLnByb2dyZXNzID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB1cGxvYWQoKTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5mb3JFYWNoKChpdGVtOiBPRmlsZUl0ZW0pID0+IHtcbiAgICAgIGlmIChpdGVtLnBlbmRpbmdVcGxvYWQpIHtcbiAgICAgICAgaXRlbS5wcmVwYXJlVG9VcGxvYWQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodGhpcy5zcGxpdFVwbG9hZCkge1xuICAgICAgdGhpcy5maWxlcy5mb3JFYWNoKChpdGVtOiBPRmlsZUl0ZW0pID0+IHtcbiAgICAgICAgaWYgKGl0ZW0ucGVuZGluZ1VwbG9hZCkge1xuICAgICAgICAgIHRoaXMudXBsb2FkSXRlbShpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudXBsb2FkSXRlbXModGhpcy5maWxlcyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwbG9hZHMgYSBzaW5nbGUgZmlsZSBvbiBhIHNpbmdsZSByZXF1ZXN0LlxuICAgKiBAcGFyYW0gaXRlbSB0aGUgZmlsZSB0byB1cGxvYWRcbiAgICovXG4gIHB1YmxpYyB1cGxvYWRJdGVtKGl0ZW06IE9GaWxlSXRlbSk6IHZvaWQge1xuICAgIGl0ZW0ucHJlcGFyZVRvVXBsb2FkKCk7XG4gICAgaWYgKHRoaXMuaXNVcGxvYWRpbmcgfHwgaXRlbS5pc1VwbG9hZGluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlzVXBsb2FkaW5nID0gdHJ1ZTtcbiAgICBpdGVtLmlzVXBsb2FkaW5nID0gdHJ1ZTtcblxuICAgIHRoaXMuX29uQmVmb3JlVXBsb2FkSXRlbShpdGVtKTtcblxuICAgIGlmICh0aGlzLnNlcnZpY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKCdObyBzZXJ2aWNlIGNvbmZpZ3VyZWQhIGFib3J0aW5nIHVwbG9hZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5fdXBsb2FkU3VzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3VwbG9hZFN1c2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5fdXBsb2FkU3VzY3JpcHRpb24gPSBpdGVtLl91cGxvYWRTdXNjcmlwdGlvbiA9IHRoaXMuc2VydmljZS51cGxvYWQoW2l0ZW1dLCB0aGlzLmVudGl0eSwgdGhpcy5kYXRhKS5zdWJzY3JpYmUoXG4gICAgICByZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3AubG9hZGVkICYmIHJlc3AudG90YWwpIHtcbiAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IE1hdGgucm91bmQocmVzcC5sb2FkZWQgKiAxMDAgLyByZXNwLnRvdGFsKTtcbiAgICAgICAgICBzZWxmLl9vblByb2dyZXNzSXRlbShpdGVtLCBwcm9ncmVzcyk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcC5jb2RlID09PSBDb2Rlcy5PTlRJTUlaRV9TVUNDRVNTRlVMX0NPREUpIHtcbiAgICAgICAgICBzZWxmLl9vblN1Y2Nlc3NJdGVtKGl0ZW0sIHJlc3ApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ3VwbG9hZEl0ZW0gZXJyb3InKTtcbiAgICAgICAgICBzZWxmLl9vbkVycm9ySXRlbShpdGVtLCAnVW5rbm93IGVycm9yJyk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBlcnIgPT4gc2VsZi5fb25FcnJvckl0ZW0oaXRlbSwgZXJyKSxcbiAgICAgICgpID0+IHNlbGYuX29uQ29tcGxldGVJdGVtKGl0ZW0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGxvYWQgYSBzZXQgb2YgZmlsZXMgb24gYSBzaW5nbGUgcmVxdWVzdC5cbiAgICogQHBhcmFtIGl0ZW1zIHRoZSBhcnJheSBvZiBmaWxlcyB0byB1cGxvYWRcbiAgICovXG4gIHB1YmxpYyB1cGxvYWRJdGVtcyhpdGVtczogT0ZpbGVJdGVtW10pOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc1VwbG9hZGluZyB8fCBpdGVtcy5zb21lKGl0ZW0gPT4gaXRlbS5pc1VwbG9hZGluZykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5pc1VwbG9hZGluZyA9IHRydWU7XG5cbiAgICB0aGlzLl9vbkJlZm9yZVVwbG9hZEFsbCgpO1xuXG4gICAgaWYgKHRoaXMuc2VydmljZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ05vIHNlcnZpY2UgY29uZmlndXJlZCEgYWJvcnRpbmcgdXBsb2FkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLl91cGxvYWRTdXNjcmlwdGlvbikge1xuICAgICAgdGhpcy5fdXBsb2FkU3VzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICB0aGlzLl91cGxvYWRTdXNjcmlwdGlvbiA9IHRoaXMuc2VydmljZS51cGxvYWQoaXRlbXMsIHRoaXMuZW50aXR5LCB0aGlzLmRhdGEpLnN1YnNjcmliZShyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLmxvYWRlZCAmJiByZXNwLnRvdGFsKSB7XG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5yb3VuZChyZXNwLmxvYWRlZCAqIDEwMCAvIHJlc3AudG90YWwpO1xuICAgICAgICBzZWxmLl9vblByb2dyZXNzQWxsKHByb2dyZXNzKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcC5jb2RlID09PSBDb2Rlcy5PTlRJTUlaRV9TVUNDRVNTRlVMX0NPREUpIHtcbiAgICAgICAgc2VsZi5fb25TdWNjZXNzQWxsKHJlc3ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcigndXBsb2FkSXRlbXMgZXJyb3InKTtcbiAgICAgIH1cbiAgICB9LFxuICAgICAgZXJyID0+IHNlbGYuX29uRXJyb3JBbGwoZXJyKSxcbiAgICAgICgpID0+IHNlbGYuX29uQ29tcGxldGVBbGwoKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQ2FuY2VscyB0aGUgdXBsb2FkIG9mIGFsbCBmaWxlcy5cbiAgICovXG4gIHB1YmxpYyBjYW5jZWwoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc3BsaXRVcGxvYWQpIHtcbiAgICAgIHRoaXMuZmlsZXMuZm9yRWFjaChpdGVtID0+IGl0ZW0uY2FuY2VsKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fdXBsb2FkU3VzY3JpcHRpb24pIHtcbiAgICAgICAgdGhpcy5fdXBsb2FkU3VzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX29uQ2FuY2VsQWxsKCk7XG4gICAgICB0aGlzLl9vbkNvbXBsZXRlQWxsKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhbmNlbHMgdGhlIHRoZSBmaWxlIHVwbG9hZC5cbiAgICogQHBhcmFtIHZhbHVlIHRoZSBmaWxlIHRvIGNhbmNlbCBpdHMgdXBsb2FkXG4gICAqL1xuICBwdWJsaWMgY2FuY2VsSXRlbSh2YWx1ZTogT0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldEluZGV4T2ZJdGVtKHZhbHVlKTtcbiAgICBjb25zdCBpdGVtID0gdGhpcy5maWxlc1tpbmRleF07XG4gICAgaWYgKGl0ZW0gJiYgaXRlbS5pc1VwbG9hZGluZyAmJiB0aGlzLnNwbGl0VXBsb2FkKSB7XG4gICAgICBpdGVtLl91cGxvYWRTdXNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgICB0aGlzLl9vbkNhbmNlbEl0ZW0oaXRlbSk7XG4gICAgdGhpcy5fb25Db21wbGV0ZUl0ZW0oaXRlbSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Tm90VXBsb2FkZWRJdGVtcygpOiBPRmlsZUl0ZW1bXSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsZXMuZmlsdGVyKChpdGVtOiBPRmlsZUl0ZW0pID0+ICFpdGVtLmlzVXBsb2FkZWQpO1xuICB9XG5cbiAgcHVibGljIGdldEluZGV4T2ZJdGVtKHZhbHVlOiBhbnkpOiBudW1iZXIge1xuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gdmFsdWUgOiB0aGlzLmZpbGVzLmluZGV4T2YodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIG9uQmVmb3JlVXBsb2FkSXRlbShmaWxlSXRlbTogT0ZpbGVJdGVtKTogYW55IHtcbiAgICByZXR1cm4geyBmaWxlSXRlbSB9O1xuICB9XG5cbiAgcHVibGljIG9uQmVmb3JlVXBsb2FkQWxsKCk6IGFueSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgcHVibGljIG9uUHJvZ3Jlc3NJdGVtKGZpbGVJdGVtOiBPRmlsZUl0ZW0sIHByb2dyZXNzOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB7IGZpbGVJdGVtLCBwcm9ncmVzcyB9O1xuICB9XG5cbiAgcHVibGljIG9uUHJvZ3Jlc3NBbGwocHJvZ3Jlc3M6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIHsgcHJvZ3Jlc3MgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkNhbmNlbEl0ZW0oZmlsZUl0ZW06IE9GaWxlSXRlbSk6IGFueSB7XG4gICAgcmV0dXJuIHsgZmlsZUl0ZW0gfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkNhbmNlbEFsbCgpOiBhbnkge1xuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIHB1YmxpYyBvblN1Y2Nlc3NJdGVtKGZpbGVJdGVtOiBPRmlsZUl0ZW0sIHJlc3BvbnNlOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB7IGZpbGVJdGVtLCByZXNwb25zZSB9O1xuICB9XG5cbiAgcHVibGljIG9uU3VjY2Vzc0FsbChyZXNwb25zZTogYW55KTogYW55IHtcbiAgICByZXR1cm4geyByZXNwb25zZSB9O1xuICB9XG5cbiAgcHVibGljIG9uRXJyb3JJdGVtKGZpbGVJdGVtOiBPRmlsZUl0ZW0sIGVycm9yOiBhbnkpOiBhbnkge1xuICAgIHJldHVybiB7IGZpbGVJdGVtLCBlcnJvciB9O1xuICB9XG5cbiAgcHVibGljIG9uRXJyb3JBbGwoZXJyb3I6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIHsgZXJyb3IgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkNvbXBsZXRlSXRlbShmaWxlSXRlbTogT0ZpbGVJdGVtKTogYW55IHtcbiAgICByZXR1cm4geyBmaWxlSXRlbSB9O1xuICB9XG5cbiAgcHVibGljIG9uQ29tcGxldGVBbGwoKTogYW55IHtcbiAgICByZXR1cm4gdm9pZCAwO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkJlZm9yZVVwbG9hZEl0ZW0oaXRlbTogT0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgaXRlbS5fb25CZWZvcmVVcGxvYWQoKTtcbiAgICB0aGlzLm9uQmVmb3JlVXBsb2FkSXRlbShpdGVtKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25CZWZvcmVVcGxvYWRBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5fb25CZWZvcmVVcGxvYWQoZmFsc2UpKTtcbiAgICB0aGlzLm9uQmVmb3JlVXBsb2FkQWxsKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uUHJvZ3Jlc3NJdGVtKGl0ZW06IE9GaWxlSXRlbSwgcHJvZ3Jlc3M6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcyhwcm9ncmVzcyk7XG4gICAgdGhpcy5wcm9ncmVzcyA9IHRvdGFsO1xuICAgIGl0ZW0uX29uUHJvZ3Jlc3MocHJvZ3Jlc3MpO1xuICAgIHRoaXMub25Qcm9ncmVzc0l0ZW0oaXRlbSwgcHJvZ3Jlc3MpO1xuICAgIHRoaXMub25Qcm9ncmVzc0FsbCh0b3RhbCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uUHJvZ3Jlc3NBbGwocHJvZ3Jlc3M6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcyhwcm9ncmVzcyk7XG4gICAgdGhpcy5wcm9ncmVzcyA9IHRvdGFsO1xuICAgIHRoaXMub25Qcm9ncmVzc0FsbCh0b3RhbCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uU3VjY2Vzc0l0ZW0oaXRlbTogT0ZpbGVJdGVtLCByZXNwb25zZTogYW55KTogdm9pZCB7XG4gICAgaXRlbS5fb25TdWNjZXNzKHJlc3BvbnNlKTtcbiAgICB0aGlzLm9uU3VjY2Vzc0l0ZW0oaXRlbSwgcmVzcG9uc2UpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vblN1Y2Nlc3NBbGwocmVzcG9uc2U6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuZmlsZXMuZm9yRWFjaChpdGVtID0+IGl0ZW0uX29uU3VjY2VzcyhyZXNwb25zZSwgZmFsc2UpKTtcbiAgICB0aGlzLm9uU3VjY2Vzc0FsbChyZXNwb25zZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uRXJyb3JJdGVtKGl0ZW06IE9GaWxlSXRlbSwgZXJyb3I6IGFueSk6IHZvaWQge1xuICAgIGl0ZW0uX29uRXJyb3IoZXJyb3IpO1xuICAgIHRoaXMub25FcnJvckl0ZW0oaXRlbSwgZXJyb3IpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkVycm9yQWxsKGVycm9yOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmZpbGVzLmZvckVhY2goaXRlbSA9PiBpdGVtLl9vbkVycm9yKGVycm9yLCBmYWxzZSkpO1xuICAgIHRoaXMub25FcnJvckFsbChlcnJvcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uQ2FuY2VsSXRlbShpdGVtOiBPRmlsZUl0ZW0pOiB2b2lkIHtcbiAgICBpdGVtLl9vbkNhbmNlbCgpO1xuICAgIHRoaXMub25DYW5jZWxJdGVtKGl0ZW0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9vbkNhbmNlbEFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLmZpbGVzLmZvckVhY2goaXRlbSA9PiBpdGVtLl9vbkNhbmNlbChmYWxzZSkpO1xuICAgIHRoaXMub25DYW5jZWxBbGwoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25Db21wbGV0ZUl0ZW0oaXRlbTogT0ZpbGVJdGVtKTogdm9pZCB7XG4gICAgaXRlbS5fb25Db21wbGV0ZSgpO1xuICAgIHRoaXMub25Db21wbGV0ZUl0ZW0oaXRlbSk7XG4gICAgY29uc3QgbmV4dEl0ZW0gPSB0aGlzLl9nZXRSZWFkeUl0ZW1zKClbMF07XG4gICAgdGhpcy5pc1VwbG9hZGluZyA9IGZhbHNlO1xuICAgIGlmIChuZXh0SXRlbSkge1xuICAgICAgbmV4dEl0ZW0udXBsb2FkKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMub25Db21wbGV0ZUFsbCgpO1xuICAgIHRoaXMucHJvZ3Jlc3MgPSB0aGlzLl9nZXRUb3RhbFByb2dyZXNzKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX29uQ29tcGxldGVBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5maWxlcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5fb25Db21wbGV0ZShmYWxzZSkpO1xuICAgIHRoaXMuaXNVcGxvYWRpbmcgPSBmYWxzZTtcbiAgICB0aGlzLm9uQ29tcGxldGVBbGwoKTtcbiAgICB0aGlzLnByb2dyZXNzID0gdGhpcy5fZ2V0VG90YWxQcm9ncmVzcygpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9nZXRSZWFkeUl0ZW1zKCk6IE9GaWxlSXRlbVtdIHtcbiAgICByZXR1cm4gdGhpcy5maWxlc1xuICAgICAgLmZpbHRlcigoaXRlbTogT0ZpbGVJdGVtKSA9PiAoaXRlbS5pc1JlYWR5ICYmICFpdGVtLmlzVXBsb2FkaW5nKSlcbiAgICAgIC5zb3J0KChpdGVtMTogT0ZpbGVJdGVtLCBpdGVtMjogT0ZpbGVJdGVtKSA9PiBpdGVtMS5pbmRleCAtIGl0ZW0yLmluZGV4KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfZ2V0VG90YWxQcm9ncmVzcyh2YWx1ZTogbnVtYmVyID0gMCk6IG51bWJlciB7XG4gICAgY29uc3Qgbm90VXBsb2FkZWQgPSB0aGlzLmdldE5vdFVwbG9hZGVkSXRlbXMoKS5sZW5ndGg7XG4gICAgY29uc3QgdXBsb2FkZWQgPSBub3RVcGxvYWRlZCA/IHRoaXMuZmlsZXMubGVuZ3RoIC0gbm90VXBsb2FkZWQgOiB0aGlzLmZpbGVzLmxlbmd0aDtcbiAgICBjb25zdCByYXRpbyA9IHRoaXMuc3BsaXRVcGxvYWQgPyAxMDAgLyB0aGlzLmZpbGVzLmxlbmd0aCA6IDEwMDtcbiAgICBjb25zdCBjdXJyZW50ID0gdmFsdWUgKiByYXRpbyAvIDEwMDtcbiAgICByZXR1cm4gTWF0aC5yb3VuZCh1cGxvYWRlZCAqIHJhdGlvICsgY3VycmVudCk7XG4gIH1cblxufVxuIl19