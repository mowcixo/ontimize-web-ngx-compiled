import { EventEmitter } from '@angular/core';
import { Util } from '../../../util/util';
export class OFormCacheClass {
    constructor(form) {
        this.form = form;
        this.initialDataCache = {};
        this.valueChangesStack = [];
        this._componentsSubscritpions = {};
        this.blockCaching = false;
        this.initializedCache = false;
        this.onCacheEmptyStateChanges = new EventEmitter();
        this.onCacheStateChanges = new EventEmitter();
        this.changedFormControls = [];
    }
    updateFormDataCache() {
        this.formDataCache = this.form.getRegisteredFieldsValues();
    }
    addChangeToStack(comp) {
        const currentValue = comp.getFormControl().value;
        const wasEmpty = this.valueChangesStack.length === 0;
        this.valueChangesStack.push({
            attr: comp.getAttribute(),
            value: currentValue
        });
        if (wasEmpty) {
            this.onCacheEmptyStateChanges.emit(false);
        }
        this.onCacheStateChanges.emit();
    }
    registerComponentCaching(comp) {
        const self = this;
        const attr = comp.getAttribute();
        const listenTo = this.form.detectChangesOnBlur ? comp.onValueChange : comp.onChange;
        if (!Util.isDefined(listenTo)) {
            return;
        }
        this._componentsSubscritpions[attr] = listenTo.subscribe(() => {
            if (self.initializedCache && !self.blockCaching && self.hasComponentChanged(attr, comp)) {
                if (self.changedFormControls.indexOf(attr) === -1) {
                    self.changedFormControls.push(attr);
                }
                self.updateFormDataCache();
                self.addChangeToStack(comp);
            }
        });
    }
    getCachedValue(attr) {
        if (this.formDataCache && this.formDataCache.hasOwnProperty(attr)) {
            return this.formDataCache[attr];
        }
        return undefined;
    }
    destroy() {
        Object.keys(this._componentsSubscritpions).forEach((attr) => {
            const subs = this._componentsSubscritpions[attr];
            subs.unsubscribe();
        });
        this._componentsSubscritpions = {};
        this.formDataCache = undefined;
        this.changedFormControls = [];
    }
    removeUndefinedProperties(arg) {
        Object.keys(arg).forEach((key) => {
            if (arg[key] === undefined) {
                delete arg[key];
            }
        });
        return arg;
    }
    registerCache() {
        const initialCache = this.form.getRegisteredFieldsValues();
        this.removeUndefinedProperties(initialCache);
        this.initializeCache(initialCache);
        this.formDataCache = initialCache;
        const components = this.form.getComponents();
        const self = this;
        Object.keys(components).forEach(attr => {
            const comp = components[attr];
            if (comp.isAutomaticRegistering()) {
                self.registerComponentCaching(comp);
            }
        });
    }
    initializeCache(val) {
        this.initialDataCache = val;
        this.valueChangesStack = [];
        this.onCacheEmptyStateChanges.emit(true);
        this.initializedCache = true;
        this.changedFormControls = [];
    }
    getInitialDataCache() {
        return this.initialDataCache;
    }
    getDataCache() {
        return this.formDataCache;
    }
    restartCache() {
        this.formDataCache = undefined;
        this.initializeCache({});
        this.initializedCache = false;
        this.onCacheStateChanges.emit();
    }
    setCacheSnapshot() {
        this.initializeCache(this.getDataCache());
    }
    undoLastChange(options = {}) {
        const lastElement = this.valueChangesStack[this.valueChangesStack.length - 1];
        if (lastElement) {
            const lastCacheValue = this.getCacheLastValue(lastElement.attr);
            const lastValue = (lastCacheValue !== null) ? lastCacheValue : this.initialDataCache[lastElement.attr];
            this.undoComponentValue(lastElement.attr, lastValue);
            this.updateFormDataCache();
            this.onCacheStateChanges.emit();
        }
    }
    undoComponentValue(attr, val) {
        this.blockCaching = true;
        const comp = this.form.getFieldReference(attr);
        if (comp) {
            comp.setValue(val);
        }
        this.blockCaching = false;
    }
    hasComponentChanged(attr, comp) {
        const currentValue = comp.getFormControl().value;
        const cache = this.formDataCache || this.initialDataCache;
        return (currentValue !== cache[attr]);
    }
    getCacheLastValue(attr) {
        this.updateChangesStack(attr);
        let result = null;
        for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {
            const current = this.valueChangesStack[i];
            if (current.attr === attr) {
                result = current.value;
                break;
            }
        }
        return result;
    }
    updateChangesStack(attr) {
        let index;
        for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {
            const current = this.valueChangesStack[i];
            if (current.attr === attr) {
                index = i;
                break;
            }
        }
        if (index !== undefined) {
            for (let i = index; i >= 0; i--) {
                const prev = this.valueChangesStack[i - 1];
                const current = this.valueChangesStack[i];
                if (current.attr === attr) {
                    this.valueChangesStack.splice(i, 1);
                    if (!prev || prev.attr === attr) {
                        continue;
                    }
                    else {
                        break;
                    }
                }
            }
        }
        if (this.valueChangesStack.length === 0) {
            this.onCacheEmptyStateChanges.emit(true);
        }
    }
    get isCacheStackEmpty() {
        return (this.valueChangesStack.length === 0);
    }
    isInitialStateChanged() {
        let currentCache;
        if (this.formDataCache) {
            currentCache = Object.assign({}, this.formDataCache);
            this.removeUndefinedProperties(currentCache);
        }
        const initialKeys = Object.keys(this.initialDataCache);
        const currentKeys = currentCache ? Object.keys(currentCache) : initialKeys;
        if (initialKeys.length !== currentKeys.length) {
            return true;
        }
        let res = false;
        for (let i = 0, len = initialKeys.length; i < len; i++) {
            const key = initialKeys[i];
            res = (this.initialDataCache[key] !== currentCache[key]);
            if (res) {
                break;
            }
        }
        return res;
    }
    getChangedFormControlsAttr() {
        return this.changedFormControls;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1mb3JtLmNhY2hlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2Zvcm0vY2FjaGUvby1mb3JtLmNhY2hlLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFLN0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRzFDLE1BQU0sT0FBTyxlQUFlO0lBYzFCLFlBQXNCLElBQW9CO1FBQXBCLFNBQUksR0FBSixJQUFJLENBQWdCO1FBWmhDLHFCQUFnQixHQUFXLEVBQUUsQ0FBQztRQUU5QixzQkFBaUIsR0FBZSxFQUFFLENBQUM7UUFDbkMsNkJBQXdCLEdBQVEsRUFBRSxDQUFDO1FBQ25DLGlCQUFZLEdBQVksS0FBSyxDQUFDO1FBQzlCLHFCQUFnQixHQUFZLEtBQUssQ0FBQztRQUU1Qyw2QkFBd0IsR0FBMEIsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUM5RSx3QkFBbUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV2RCx3QkFBbUIsR0FBYSxFQUFFLENBQUM7SUFHN0MsQ0FBQztJQUVTLG1CQUFtQjtRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztJQUM3RCxDQUFDO0lBRVMsZ0JBQWdCLENBQUMsSUFBMkI7UUFDcEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQztRQUNqRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztRQUNyRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDO1lBQzFCLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3pCLEtBQUssRUFBRSxZQUFZO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksUUFBUSxFQUFFO1lBQ1osSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQztRQUNELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRVMsd0JBQXdCLENBQUMsSUFBd0I7UUFDekQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNqQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ3BGLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzdCLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUM1RCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDdkYsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO29CQUNqRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNyQztnQkFDRCxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzdCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVk7UUFDekIsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2pFLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxPQUFPO1FBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMxRCxNQUFNLElBQUksR0FBaUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyx3QkFBd0IsR0FBRyxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUM7UUFDL0IsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRVMseUJBQXlCLENBQUMsR0FBUTtRQUMxQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQy9CLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDMUIsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDakI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELGFBQWE7UUFDWCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUM7UUFFbEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUM3QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckMsTUFBTSxJQUFJLEdBQXVCLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsRCxJQUFJLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxFQUFFO2dCQUNqQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDckM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxlQUFlLENBQUMsR0FBUTtRQUN0QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsR0FBRyxDQUFDO1FBQzVCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVELG1CQUFtQjtRQUNqQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUMvQixDQUFDO0lBRUQsWUFBWTtRQUNWLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQsWUFBWTtRQUNWLElBQUksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFDO1FBQy9CLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVELGdCQUFnQjtRQUNkLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELGNBQWMsQ0FBQyxVQUFlLEVBQUU7UUFDOUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDOUUsSUFBSSxXQUFXLEVBQUU7WUFDZixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hFLE1BQU0sU0FBUyxHQUFHLENBQUMsY0FBYyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFckQsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVTLGtCQUFrQixDQUFDLElBQVksRUFBRSxHQUFRO1FBQ2pELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0MsSUFBSSxJQUFJLEVBQUU7WUFFUixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3BCO1FBQ0QsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDNUIsQ0FBQztJQUVTLG1CQUFtQixDQUFDLElBQVksRUFBRSxJQUEyQjtRQUNyRSxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsS0FBSyxDQUFDO1FBQ2pELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQzFELE9BQU8sQ0FBQyxZQUFZLEtBQUssS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVTLGlCQUFpQixDQUFDLElBQVk7UUFDdEMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQztRQUNsQixLQUFLLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7Z0JBQ3pCLE1BQU0sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO2dCQUN2QixNQUFNO2FBQ1A7U0FDRjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFUyxrQkFBa0IsQ0FBQyxJQUFZO1FBQ3ZDLElBQUksS0FBYSxDQUFDO1FBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRTtnQkFDekIsS0FBSyxHQUFHLENBQUMsQ0FBQztnQkFDVixNQUFNO2FBQ1A7U0FDRjtRQUNELElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN2QixLQUFLLElBQUksQ0FBQyxHQUFHLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMvQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7b0JBQ3pCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNwQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO3dCQUMvQixTQUFTO3FCQUNWO3lCQUFNO3dCQUNMLE1BQU07cUJBQ1A7aUJBQ0Y7YUFDRjtTQUNGO1FBQ0QsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFDO0lBQ0gsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxxQkFBcUI7UUFDbkIsSUFBSSxZQUFZLENBQUM7UUFDakIsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLFlBQVksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQzlDO1FBRUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN2RCxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUMzRSxJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUM3QyxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdEQsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTNCLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN6RCxJQUFJLEdBQUcsRUFBRTtnQkFDUCxNQUFNO2FBQ1A7U0FDRjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELDBCQUEwQjtRQUN4QixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztJQUNsQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBJRm9ybUNvbnRyb2xDb21wb25lbnQgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL2Zvcm0tY29udHJvbC1jb21wb25lbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElGb3JtRGF0YUNvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL2ludGVyZmFjZXMvZm9ybS1kYXRhLWNvbXBvbmVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uLy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQgeyBPRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uL28tZm9ybS5jb21wb25lbnQnO1xuXG5leHBvcnQgY2xhc3MgT0Zvcm1DYWNoZUNsYXNzIHtcblxuICBwcm90ZWN0ZWQgaW5pdGlhbERhdGFDYWNoZTogb2JqZWN0ID0ge307XG4gIHByb3RlY3RlZCBmb3JtRGF0YUNhY2hlOiBvYmplY3Q7XG4gIHByb3RlY3RlZCB2YWx1ZUNoYW5nZXNTdGFjazogQXJyYXk8YW55PiA9IFtdO1xuICBwcm90ZWN0ZWQgX2NvbXBvbmVudHNTdWJzY3JpdHBpb25zOiBhbnkgPSB7fTtcbiAgcHJvdGVjdGVkIGJsb2NrQ2FjaGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZWRDYWNoZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIG9uQ2FjaGVFbXB0eVN0YXRlQ2hhbmdlczogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuICBvbkNhY2hlU3RhdGVDaGFuZ2VzOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHByb3RlY3RlZCBjaGFuZ2VkRm9ybUNvbnRyb2xzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBmb3JtOiBPRm9ybUNvbXBvbmVudCkge1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUZvcm1EYXRhQ2FjaGUoKSB7XG4gICAgdGhpcy5mb3JtRGF0YUNhY2hlID0gdGhpcy5mb3JtLmdldFJlZ2lzdGVyZWRGaWVsZHNWYWx1ZXMoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRDaGFuZ2VUb1N0YWNrKGNvbXA6IElGb3JtQ29udHJvbENvbXBvbmVudCkge1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGNvbXAuZ2V0Rm9ybUNvbnRyb2woKS52YWx1ZTtcbiAgICBjb25zdCB3YXNFbXB0eSA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2subGVuZ3RoID09PSAwO1xuICAgIHRoaXMudmFsdWVDaGFuZ2VzU3RhY2sucHVzaCh7XG4gICAgICBhdHRyOiBjb21wLmdldEF0dHJpYnV0ZSgpLFxuICAgICAgdmFsdWU6IGN1cnJlbnRWYWx1ZVxuICAgIH0pO1xuICAgIGlmICh3YXNFbXB0eSkge1xuICAgICAgdGhpcy5vbkNhY2hlRW1wdHlTdGF0ZUNoYW5nZXMuZW1pdChmYWxzZSk7XG4gICAgfVxuICAgIHRoaXMub25DYWNoZVN0YXRlQ2hhbmdlcy5lbWl0KCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVnaXN0ZXJDb21wb25lbnRDYWNoaW5nKGNvbXA6IElGb3JtRGF0YUNvbXBvbmVudCkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGNvbnN0IGF0dHIgPSBjb21wLmdldEF0dHJpYnV0ZSgpO1xuICAgIGNvbnN0IGxpc3RlblRvID0gdGhpcy5mb3JtLmRldGVjdENoYW5nZXNPbkJsdXIgPyBjb21wLm9uVmFsdWVDaGFuZ2UgOiBjb21wLm9uQ2hhbmdlO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQobGlzdGVuVG8pKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX2NvbXBvbmVudHNTdWJzY3JpdHBpb25zW2F0dHJdID0gbGlzdGVuVG8uc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGlmIChzZWxmLmluaXRpYWxpemVkQ2FjaGUgJiYgIXNlbGYuYmxvY2tDYWNoaW5nICYmIHNlbGYuaGFzQ29tcG9uZW50Q2hhbmdlZChhdHRyLCBjb21wKSkge1xuICAgICAgICBpZiAoc2VsZi5jaGFuZ2VkRm9ybUNvbnRyb2xzLmluZGV4T2YoYXR0cikgPT09IC0xKSB7XG4gICAgICAgICAgc2VsZi5jaGFuZ2VkRm9ybUNvbnRyb2xzLnB1c2goYXR0cik7XG4gICAgICAgIH1cbiAgICAgICAgc2VsZi51cGRhdGVGb3JtRGF0YUNhY2hlKCk7XG4gICAgICAgIHNlbGYuYWRkQ2hhbmdlVG9TdGFjayhjb21wKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldENhY2hlZFZhbHVlKGF0dHI6IHN0cmluZyk6IGFueSB7XG4gICAgaWYgKHRoaXMuZm9ybURhdGFDYWNoZSAmJiB0aGlzLmZvcm1EYXRhQ2FjaGUuaGFzT3duUHJvcGVydHkoYXR0cikpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1EYXRhQ2FjaGVbYXR0cl07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIE9iamVjdC5rZXlzKHRoaXMuX2NvbXBvbmVudHNTdWJzY3JpdHBpb25zKS5mb3JFYWNoKChhdHRyKSA9PiB7XG4gICAgICBjb25zdCBzdWJzOiBTdWJzY3JpcHRpb24gPSB0aGlzLl9jb21wb25lbnRzU3Vic2NyaXRwaW9uc1thdHRyXTtcbiAgICAgIHN1YnMudW5zdWJzY3JpYmUoKTtcbiAgICB9KTtcbiAgICB0aGlzLl9jb21wb25lbnRzU3Vic2NyaXRwaW9ucyA9IHt9O1xuICAgIHRoaXMuZm9ybURhdGFDYWNoZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNoYW5nZWRGb3JtQ29udHJvbHMgPSBbXTtcbiAgfVxuXG4gIHByb3RlY3RlZCByZW1vdmVVbmRlZmluZWRQcm9wZXJ0aWVzKGFyZzogYW55KTogYW55IHtcbiAgICBPYmplY3Qua2V5cyhhcmcpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKGFyZ1trZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZGVsZXRlIGFyZ1trZXldO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBhcmc7XG4gIH1cblxuICByZWdpc3RlckNhY2hlKCkge1xuICAgIGNvbnN0IGluaXRpYWxDYWNoZSA9IHRoaXMuZm9ybS5nZXRSZWdpc3RlcmVkRmllbGRzVmFsdWVzKCk7XG4gICAgdGhpcy5yZW1vdmVVbmRlZmluZWRQcm9wZXJ0aWVzKGluaXRpYWxDYWNoZSk7XG4gICAgdGhpcy5pbml0aWFsaXplQ2FjaGUoaW5pdGlhbENhY2hlKTtcbiAgICB0aGlzLmZvcm1EYXRhQ2FjaGUgPSBpbml0aWFsQ2FjaGU7XG5cbiAgICBjb25zdCBjb21wb25lbnRzID0gdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKTtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICBPYmplY3Qua2V5cyhjb21wb25lbnRzKS5mb3JFYWNoKGF0dHIgPT4ge1xuICAgICAgY29uc3QgY29tcDogSUZvcm1EYXRhQ29tcG9uZW50ID0gY29tcG9uZW50c1thdHRyXTtcbiAgICAgIGlmIChjb21wLmlzQXV0b21hdGljUmVnaXN0ZXJpbmcoKSkge1xuICAgICAgICBzZWxmLnJlZ2lzdGVyQ29tcG9uZW50Q2FjaGluZyhjb21wKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGluaXRpYWxpemVDYWNoZSh2YWw6IGFueSkge1xuICAgIHRoaXMuaW5pdGlhbERhdGFDYWNoZSA9IHZhbDtcbiAgICB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrID0gW107XG4gICAgdGhpcy5vbkNhY2hlRW1wdHlTdGF0ZUNoYW5nZXMuZW1pdCh0cnVlKTtcbiAgICB0aGlzLmluaXRpYWxpemVkQ2FjaGUgPSB0cnVlO1xuICAgIHRoaXMuY2hhbmdlZEZvcm1Db250cm9scyA9IFtdO1xuICB9XG5cbiAgZ2V0SW5pdGlhbERhdGFDYWNoZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pbml0aWFsRGF0YUNhY2hlO1xuICB9XG5cbiAgZ2V0RGF0YUNhY2hlKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm1EYXRhQ2FjaGU7XG4gIH1cblxuICByZXN0YXJ0Q2FjaGUoKSB7XG4gICAgdGhpcy5mb3JtRGF0YUNhY2hlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaW5pdGlhbGl6ZUNhY2hlKHt9KTtcbiAgICB0aGlzLmluaXRpYWxpemVkQ2FjaGUgPSBmYWxzZTtcbiAgICB0aGlzLm9uQ2FjaGVTdGF0ZUNoYW5nZXMuZW1pdCgpO1xuICB9XG5cbiAgc2V0Q2FjaGVTbmFwc2hvdCgpIHtcbiAgICB0aGlzLmluaXRpYWxpemVDYWNoZSh0aGlzLmdldERhdGFDYWNoZSgpKTtcbiAgfVxuXG4gIHVuZG9MYXN0Q2hhbmdlKG9wdGlvbnM6IGFueSA9IHt9KSB7XG4gICAgY29uc3QgbGFzdEVsZW1lbnQgPSB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrW3RoaXMudmFsdWVDaGFuZ2VzU3RhY2subGVuZ3RoIC0gMV07XG4gICAgaWYgKGxhc3RFbGVtZW50KSB7XG4gICAgICBjb25zdCBsYXN0Q2FjaGVWYWx1ZSA9IHRoaXMuZ2V0Q2FjaGVMYXN0VmFsdWUobGFzdEVsZW1lbnQuYXR0cik7XG4gICAgICBjb25zdCBsYXN0VmFsdWUgPSAobGFzdENhY2hlVmFsdWUgIT09IG51bGwpID8gbGFzdENhY2hlVmFsdWUgOiB0aGlzLmluaXRpYWxEYXRhQ2FjaGVbbGFzdEVsZW1lbnQuYXR0cl07XG4gICAgICB0aGlzLnVuZG9Db21wb25lbnRWYWx1ZShsYXN0RWxlbWVudC5hdHRyLCBsYXN0VmFsdWUpO1xuXG4gICAgICB0aGlzLnVwZGF0ZUZvcm1EYXRhQ2FjaGUoKTtcbiAgICAgIHRoaXMub25DYWNoZVN0YXRlQ2hhbmdlcy5lbWl0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHVuZG9Db21wb25lbnRWYWx1ZShhdHRyOiBzdHJpbmcsIHZhbDogYW55KSB7XG4gICAgdGhpcy5ibG9ja0NhY2hpbmcgPSB0cnVlO1xuICAgIGNvbnN0IGNvbXAgPSB0aGlzLmZvcm0uZ2V0RmllbGRSZWZlcmVuY2UoYXR0cik7XG4gICAgaWYgKGNvbXApIHtcbiAgICAgIC8vIChjb21wIGFzIGFueSkub2xkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICBjb21wLnNldFZhbHVlKHZhbCk7XG4gICAgfVxuICAgIHRoaXMuYmxvY2tDYWNoaW5nID0gZmFsc2U7XG4gIH1cblxuICBwcm90ZWN0ZWQgaGFzQ29tcG9uZW50Q2hhbmdlZChhdHRyOiBzdHJpbmcsIGNvbXA6IElGb3JtQ29udHJvbENvbXBvbmVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGNvbXAuZ2V0Rm9ybUNvbnRyb2woKS52YWx1ZTtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuZm9ybURhdGFDYWNoZSB8fCB0aGlzLmluaXRpYWxEYXRhQ2FjaGU7XG4gICAgcmV0dXJuIChjdXJyZW50VmFsdWUgIT09IGNhY2hlW2F0dHJdKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDYWNoZUxhc3RWYWx1ZShhdHRyOiBzdHJpbmcpOiBhbnkge1xuICAgIHRoaXMudXBkYXRlQ2hhbmdlc1N0YWNrKGF0dHIpO1xuICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgIGZvciAobGV0IGkgPSB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy52YWx1ZUNoYW5nZXNTdGFja1tpXTtcbiAgICAgIGlmIChjdXJyZW50LmF0dHIgPT09IGF0dHIpIHtcbiAgICAgICAgcmVzdWx0ID0gY3VycmVudC52YWx1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlQ2hhbmdlc1N0YWNrKGF0dHI6IHN0cmluZykge1xuICAgIGxldCBpbmRleDogbnVtYmVyO1xuICAgIGZvciAobGV0IGkgPSB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy52YWx1ZUNoYW5nZXNTdGFja1tpXTtcbiAgICAgIGlmIChjdXJyZW50LmF0dHIgPT09IGF0dHIpIHtcbiAgICAgICAgaW5kZXggPSBpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGluZGV4ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGZvciAobGV0IGkgPSBpbmRleDsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgY29uc3QgcHJldiA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2tbaSAtIDFdO1xuICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy52YWx1ZUNoYW5nZXNTdGFja1tpXTtcbiAgICAgICAgaWYgKGN1cnJlbnQuYXR0ciA9PT0gYXR0cikge1xuICAgICAgICAgIHRoaXMudmFsdWVDaGFuZ2VzU3RhY2suc3BsaWNlKGksIDEpO1xuICAgICAgICAgIGlmICghcHJldiB8fCBwcmV2LmF0dHIgPT09IGF0dHIpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMudmFsdWVDaGFuZ2VzU3RhY2subGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm9uQ2FjaGVFbXB0eVN0YXRlQ2hhbmdlcy5lbWl0KHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBpc0NhY2hlU3RhY2tFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKHRoaXMudmFsdWVDaGFuZ2VzU3RhY2subGVuZ3RoID09PSAwKTtcbiAgfVxuXG4gIGlzSW5pdGlhbFN0YXRlQ2hhbmdlZCgpOiBib29sZWFuIHtcbiAgICBsZXQgY3VycmVudENhY2hlO1xuICAgIGlmICh0aGlzLmZvcm1EYXRhQ2FjaGUpIHtcbiAgICAgIGN1cnJlbnRDYWNoZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZm9ybURhdGFDYWNoZSk7XG4gICAgICB0aGlzLnJlbW92ZVVuZGVmaW5lZFByb3BlcnRpZXMoY3VycmVudENhY2hlKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbml0aWFsS2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuaW5pdGlhbERhdGFDYWNoZSk7XG4gICAgY29uc3QgY3VycmVudEtleXMgPSBjdXJyZW50Q2FjaGUgPyBPYmplY3Qua2V5cyhjdXJyZW50Q2FjaGUpIDogaW5pdGlhbEtleXM7XG4gICAgaWYgKGluaXRpYWxLZXlzLmxlbmd0aCAhPT0gY3VycmVudEtleXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgbGV0IHJlcyA9IGZhbHNlO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBpbml0aWFsS2V5cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gaW5pdGlhbEtleXNbaV07XG4gICAgICAvLyBUT0RPIGJlIGNhcmVmdWwgd2l0aCB0eXBlcyBjb21wYXJpc2lvbnNcbiAgICAgIHJlcyA9ICh0aGlzLmluaXRpYWxEYXRhQ2FjaGVba2V5XSAhPT0gY3VycmVudENhY2hlW2tleV0pO1xuICAgICAgaWYgKHJlcykge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGdldENoYW5nZWRGb3JtQ29udHJvbHNBdHRyKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VkRm9ybUNvbnRyb2xzO1xuICB9XG59XG4iXX0=