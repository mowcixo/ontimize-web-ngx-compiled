import * as tslib_1 from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Injector } from '@angular/core';
import { Subscription } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { OFormComponent } from '../../components/form/o-form.component';
import { InputConverter } from '../../decorators/input-converter';
import { Codes } from '../../util/codes';
import { FilterExpressionUtils } from '../../util/filter-expression.utils';
import { Util } from '../../util/util';
export const DEFAULT_INPUTS_O_FILTER_BUILDER = [
    'filters',
    'targetCmp: target',
    'expressionBuilder: expression-builder',
    'queryOnChange: query-on-change',
    'queryOnChangeDelay: query-on-change-delay'
];
export const DEFAULT_OUTPUTS_O_FILTER_BUILDER = [
    'onFilter',
    'onClear'
];
export class OFilterBuilderComponent {
    constructor(form, injector) {
        this.form = form;
        this.onFilter = new EventEmitter();
        this.onClear = new EventEmitter();
        this.queryOnChange = false;
        this.queryOnChangeDelay = 0;
        this.filterComponents = [];
        this.subscriptions = new Subscription();
    }
    ngOnInit() {
        this.initialize();
    }
    ngAfterViewInit() {
        this.initializeListeners();
    }
    ngOnDestroy() {
        if (this.subscriptions) {
            this.subscriptions.unsubscribe();
        }
    }
    initialize() {
        if (this.filters) {
            const filterArray = Util.parseArray(this.filters);
            filterArray.forEach(filter => {
                const filterElms = filter.split(Codes.COLUMNS_ALIAS_SEPARATOR);
                this.filterComponents.push({
                    targetAttr: filterElms[0],
                    formComponentAttr: filterElms[1] ? filterElms[1] : filterElms[0]
                });
            });
        }
        if (Util.isDefined(this.targetCmp)) {
            this.targetCmp.setFilterBuilder(this);
        }
    }
    initializeListeners() {
        if (this.queryOnChange) {
            this.filterComponents.forEach((filterComponent) => {
                const formComponent = this.form.getComponents()[filterComponent.formComponentAttr];
                if (formComponent) {
                    this.subscriptions.add(formComponent.getFormControl().valueChanges
                        .pipe(debounceTime(this.queryOnChangeDelay))
                        .subscribe(a => this.triggerReload()));
                }
            });
        }
    }
    getExpression() {
        const formComponents = this.form.getComponents();
        const params = [];
        this.filterComponents.forEach((filterComponent) => {
            const formComponent = formComponents[filterComponent.formComponentAttr];
            const value = formComponent.getValue();
            params.push({
                attr: filterComponent.targetAttr,
                value: value
            });
        });
        if (this.expressionBuilder) {
            return this.expressionBuilder(params);
        }
        const expressions = [];
        params.forEach(elem => {
            if (Util.isDefined(elem.value)) {
                expressions.push(FilterExpressionUtils.buildExpressionEquals(elem.attr, elem.value));
            }
        });
        return expressions.length ? expressions.reduce((fe1, fe2) => FilterExpressionUtils.buildComplexExpression(fe1, fe2, FilterExpressionUtils.OP_OR)) : undefined;
    }
    getBasicExpression() {
        return FilterExpressionUtils.buildBasicExpression(this.getExpression());
    }
    getTargetComponent() {
        return this.targetCmp;
    }
    triggerReload() {
        if (!this.targetCmp) {
            return;
        }
        if (this.targetCmp.pageable) {
            this.targetCmp.reloadPaginatedDataFromStart();
        }
        else {
            this.targetCmp.reloadData();
        }
        this.onFilter.emit();
    }
    clearFilter() {
        const formComponents = this.form.getComponents();
        this.getFilterAttrs().forEach((attr) => {
            formComponents[attr].setValue(void 0);
        });
        this.onClear.emit();
    }
    getFilterAttrs() {
        return this.filterComponents.map((elem) => elem.formComponentAttr);
    }
}
OFilterBuilderComponent.decorators = [
    { type: Component, args: [{
                selector: 'o-filter-builder',
                template: "",
                inputs: DEFAULT_INPUTS_O_FILTER_BUILDER,
                outputs: DEFAULT_OUTPUTS_O_FILTER_BUILDER
            }] }
];
OFilterBuilderComponent.ctorParameters = () => [
    { type: OFormComponent, decorators: [{ type: Inject, args: [forwardRef(() => OFormComponent),] }] },
    { type: Injector }
];
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Boolean)
], OFilterBuilderComponent.prototype, "queryOnChange", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Number)
], OFilterBuilderComponent.prototype, "queryOnChangeDelay", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1maWx0ZXItYnVpbGRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZmlsdGVyLWJ1aWxkZXIvby1maWx0ZXItYnVpbGRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDeEgsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRXhFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUtsRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0UsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXZDLE1BQU0sQ0FBQyxNQUFNLCtCQUErQixHQUFHO0lBRTdDLFNBQVM7SUFHVCxtQkFBbUI7SUFHbkIsdUNBQXVDO0lBR3ZDLGdDQUFnQztJQUdoQywyQ0FBMkM7Q0FDNUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLGdDQUFnQyxHQUFHO0lBRTlDLFVBQVU7SUFHVixTQUFTO0NBQ1YsQ0FBQztBQVdGLE1BQU0sT0FBTyx1QkFBdUI7SUFpQmxDLFlBQ21ELElBQW9CLEVBQ3JFLFFBQWtCO1FBRCtCLFNBQUksR0FBSixJQUFJLENBQWdCO1FBaEJoRSxhQUFRLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFDdEQsWUFBTyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBTXJE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QUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUM3QyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFLUyxjQUFjO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQTZCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzlGLENBQUM7OztZQTdKRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGtCQUFrQjtnQkFDNUIsWUFBZ0Q7Z0JBQ2hELE1BQU0sRUFBRSwrQkFBK0I7Z0JBQ3ZDLE9BQU8sRUFBRSxnQ0FBZ0M7YUFDMUM7OztZQXpDUSxjQUFjLHVCQStEbEIsTUFBTSxTQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFuRXlCLFFBQVE7O0FBMEQzRTtJQURDLGNBQWMsRUFBRTs7OERBQ3FCO0FBRXRDO0lBREMsY0FBYyxFQUFFOzttRUFDcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgZm9yd2FyZFJlZiwgSW5qZWN0LCBJbmplY3RvciwgT25EZXN0cm95LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBPRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvZm9ybS9vLWZvcm0uY29tcG9uZW50JztcbmltcG9ydCB7IE9TZXJ2aWNlQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9vLXNlcnZpY2UtY29tcG9uZW50LmNsYXNzJztcbmltcG9ydCB7IElucHV0Q29udmVydGVyIH0gZnJvbSAnLi4vLi4vZGVjb3JhdG9ycy9pbnB1dC1jb252ZXJ0ZXInO1xuaW1wb3J0IHsgSUZpbHRlckJ1aWxkZXJDbXBUYXJnZXQgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2ZpbHRlci1idWlsZGVyLWNvbXBvbmVudC10YXJnZXQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElGb3JtRGF0YUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvZm9ybS1kYXRhLWNvbXBvbmVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQmFzaWNFeHByZXNzaW9uIH0gZnJvbSAnLi4vLi4vdHlwZXMvYmFzaWMtZXhwcmVzc2lvbi50eXBlJztcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi8uLi90eXBlcy9leHByZXNzaW9uLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi8uLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IEZpbHRlckV4cHJlc3Npb25VdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvZmlsdGVyLWV4cHJlc3Npb24udXRpbHMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uL3V0aWwvdXRpbCc7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0lOUFVUU19PX0ZJTFRFUl9CVUlMREVSID0gW1xuICAvLyBmaWx0ZXJzOiBbc3RyaW5nXSBMaXN0IG9mIHBhaXJzIG9mIGZvcm0gY29tcG9uZW50IGF0dHJpYnV0ZXMgYW5kIHRhcmdldCBjb21wb25lbnQgY29sdW1zICh0YXJnZXRDb2x1bW4xOmNvbXBvbmVudEF0dHIxO3RhcmdldENvbHVtbjI6Y29tcG9uZW50QXR0cjI7Li4uKS4gU2VwYXJhdGVkIGJ5ICc7Jy5cbiAgJ2ZpbHRlcnMnLFxuXG4gIC8vIHRhcmdldCBbYE9TZXJ2aWNlQ29tcG9uZW50YCBpbnN0YW5jZV06IENvbXBvbmVudCB3aG9zZSBkYXRhIHdpbGwgYmUgZmlsdGVyZWQuXG4gICd0YXJnZXRDbXA6IHRhcmdldCcsXG5cbiAgLy8gZXhwcmVzc2lvbi1idWlsZGVyIFtmdW50aW9uXTogRnVudGlvbiBjYWxsZWQgZm9yIGNyZWF0aW5nIHRoZSBleHByZXNzaW9uLlxuICAnZXhwcmVzc2lvbkJ1aWxkZXI6IGV4cHJlc3Npb24tYnVpbGRlcicsXG5cbiAgLy8gcXVlcnktb24tY2hhbmdlIFt5ZXN8bm98dHJ1ZXxmYWxzZV06IEluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCB0byB0cmlnZ2VyIHRoZSB0YXJnZXQgY29tcG9uZW50IHJlZnJlc2ggd2hlbiBhIGZpbHRlciBjb21wb25lbnQgYG9uQ2hhbmdlYCBldmVudCBpcyBmaXJlZC4gRGVmYXVsdDogbm8uXG4gICdxdWVyeU9uQ2hhbmdlOiBxdWVyeS1vbi1jaGFuZ2UnLFxuXG4gIC8vIHF1ZXJ5LW9uLWNoYW5nZS1kZWxheSBbbnVtYmVyXTogRGVsYXkgdGltZSBpbiBtaWxsaXNlY29uZHMgYHF1ZXJ5LW9uLWNoYW5nZWAgbWV0aG9kIGlzIHRyaWdnZXJlZC4gRGVmYXVsdDogMC5cbiAgJ3F1ZXJ5T25DaGFuZ2VEZWxheTogcXVlcnktb24tY2hhbmdlLWRlbGF5J1xuXTtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfT1VUUFVUU19PX0ZJTFRFUl9CVUlMREVSID0gW1xuICAvLyBFdmVudCB0cmlnZ2VyZWQgd2hlbiB0aGUgZmlsdGVyIGFjdGlvbiBpcyBleGVjdXRlZC5cbiAgJ29uRmlsdGVyJyxcblxuICAvLyBFdmVudCB0cmlnZ2VyZWQgd2hlbiB0aGUgY2xlYXIgYWN0aW9uIGlzIGV4Y3V0ZWQuXG4gICdvbkNsZWFyJ1xuXTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnby1maWx0ZXItYnVpbGRlcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9vLWZpbHRlci1idWlsZGVyLmNvbXBvbmVudC5odG1sJyxcbiAgaW5wdXRzOiBERUZBVUxUX0lOUFVUU19PX0ZJTFRFUl9CVUlMREVSLFxuICBvdXRwdXRzOiBERUZBVUxUX09VVFBVVFNfT19GSUxURVJfQlVJTERFUlxufSlcbi8qKlxuICogVGhlIE9GaWx0ZXJCdWlsZGVyQ29tcG9uZW50LlxuICovXG5leHBvcnQgY2xhc3MgT0ZpbHRlckJ1aWxkZXJDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uSW5pdCB7XG5cbiAgcHVibGljIG9uRmlsdGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBwdWJsaWMgb25DbGVhcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBwdWJsaWMgZmlsdGVyczogc3RyaW5nO1xuICBwdWJsaWMgdGFyZ2V0Q21wOiBPU2VydmljZUNvbXBvbmVudDtcbiAgcHVibGljIGV4cHJlc3Npb25CdWlsZGVyOiAodmFsdWVzOiBBcnJheTx7IGF0dHIsIHZhbHVlIH0+KSA9PiBFeHByZXNzaW9uO1xuICBASW5wdXRDb252ZXJ0ZXIoKVxuICBwdWJsaWMgcXVlcnlPbkNoYW5nZTogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXRDb252ZXJ0ZXIoKVxuICBwdWJsaWMgcXVlcnlPbkNoYW5nZURlbGF5OiBudW1iZXIgPSAwO1xuXG4gIHByb3RlY3RlZCBmaWx0ZXJDb21wb25lbnRzOiBBcnJheTxJRmlsdGVyQnVpbGRlckNtcFRhcmdldD4gPSBbXTtcblxuICBwcm90ZWN0ZWQgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBPRm9ybUNvbXBvbmVudCkpIHB1YmxpYyBmb3JtOiBPRm9ybUNvbXBvbmVudCxcbiAgICBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7IH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxpemVMaXN0ZW5lcnMoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgZmlsdGVyc1xuICAgIGlmICh0aGlzLmZpbHRlcnMpIHtcbiAgICAgIGNvbnN0IGZpbHRlckFycmF5OiBBcnJheTxzdHJpbmc+ID0gVXRpbC5wYXJzZUFycmF5KHRoaXMuZmlsdGVycyk7XG4gICAgICBmaWx0ZXJBcnJheS5mb3JFYWNoKGZpbHRlciA9PiB7XG4gICAgICAgIGNvbnN0IGZpbHRlckVsbXMgPSBmaWx0ZXIuc3BsaXQoQ29kZXMuQ09MVU1OU19BTElBU19TRVBBUkFUT1IpO1xuICAgICAgICB0aGlzLmZpbHRlckNvbXBvbmVudHMucHVzaCh7XG4gICAgICAgICAgdGFyZ2V0QXR0cjogZmlsdGVyRWxtc1swXSxcbiAgICAgICAgICBmb3JtQ29tcG9uZW50QXR0cjogZmlsdGVyRWxtc1sxXSA/IGZpbHRlckVsbXNbMV0gOiBmaWx0ZXJFbG1zWzBdXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKFV0aWwuaXNEZWZpbmVkKHRoaXMudGFyZ2V0Q21wKSkge1xuICAgICAgdGhpcy50YXJnZXRDbXAuc2V0RmlsdGVyQnVpbGRlcih0aGlzKTtcbiAgICB9XG4gIH1cblxuICBpbml0aWFsaXplTGlzdGVuZXJzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnF1ZXJ5T25DaGFuZ2UpIHtcbiAgICAgIHRoaXMuZmlsdGVyQ29tcG9uZW50cy5mb3JFYWNoKChmaWx0ZXJDb21wb25lbnQ6IElGaWx0ZXJCdWlsZGVyQ21wVGFyZ2V0KSA9PiB7XG4gICAgICAgIGNvbnN0IGZvcm1Db21wb25lbnQ6IElGb3JtRGF0YUNvbXBvbmVudCA9IHRoaXMuZm9ybS5nZXRDb21wb25lbnRzKClbZmlsdGVyQ29tcG9uZW50LmZvcm1Db21wb25lbnRBdHRyXTtcbiAgICAgICAgaWYgKGZvcm1Db21wb25lbnQpIHtcbiAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgICAgICAgZm9ybUNvbXBvbmVudC5nZXRGb3JtQ29udHJvbCgpLnZhbHVlQ2hhbmdlc1xuICAgICAgICAgICAgICAucGlwZShkZWJvdW5jZVRpbWUodGhpcy5xdWVyeU9uQ2hhbmdlRGVsYXkpKVxuICAgICAgICAgICAgICAuc3Vic2NyaWJlKGEgPT4gdGhpcy50cmlnZ2VyUmVsb2FkKCkpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gYEV4cHJlc3Npb25gIG9iamVjdCB3aXRoIHRoZSBmaWx0ZXIuXG4gICAqIEByZXR1cm5zIHRoZSBgRXhwcmVzc2lvbmAgb2JqZWN0IHdpdGggdGhlIGZpbHRlci5cbiAgICovXG4gIGdldEV4cHJlc3Npb24oKTogRXhwcmVzc2lvbiB7XG4gICAgLy8gUHJlcGFyZSBmb3JtIGZpbHRlciB2YWx1ZXMgWy4uLiB7IGF0dHIsIHZhbHVlIH1dXG4gICAgY29uc3QgZm9ybUNvbXBvbmVudHMgPSB0aGlzLmZvcm0uZ2V0Q29tcG9uZW50cygpO1xuICAgIGNvbnN0IHBhcmFtczogQXJyYXk8eyBhdHRyLCB2YWx1ZSB9PiA9IFtdO1xuICAgIHRoaXMuZmlsdGVyQ29tcG9uZW50cy5mb3JFYWNoKChmaWx0ZXJDb21wb25lbnQ6IElGaWx0ZXJCdWlsZGVyQ21wVGFyZ2V0KSA9PiB7XG4gICAgICBjb25zdCBmb3JtQ29tcG9uZW50OiBJRm9ybURhdGFDb21wb25lbnQgPSBmb3JtQ29tcG9uZW50c1tmaWx0ZXJDb21wb25lbnQuZm9ybUNvbXBvbmVudEF0dHJdO1xuICAgICAgY29uc3QgdmFsdWUgPSBmb3JtQ29tcG9uZW50LmdldFZhbHVlKCk7XG4gICAgICBwYXJhbXMucHVzaCh7XG4gICAgICAgIGF0dHI6IGZpbHRlckNvbXBvbmVudC50YXJnZXRBdHRyLFxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gVHJpZ2dlciB0aGUgZnVuY3Rpb24gcHJvdmlkZWQgYnkgdGhlIHVzZXJcbiAgICBpZiAodGhpcy5leHByZXNzaW9uQnVpbGRlcikge1xuICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIocGFyYW1zKTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSBkZXNmYXVsdCBleHByZXNzaW9uXG4gICAgY29uc3QgZXhwcmVzc2lvbnM6IEFycmF5PEV4cHJlc3Npb24+ID0gW107XG4gICAgcGFyYW1zLmZvckVhY2goZWxlbSA9PiB7XG4gICAgICBpZiAoVXRpbC5pc0RlZmluZWQoZWxlbS52YWx1ZSkpIHtcbiAgICAgICAgZXhwcmVzc2lvbnMucHVzaChGaWx0ZXJFeHByZXNzaW9uVXRpbHMuYnVpbGRFeHByZXNzaW9uRXF1YWxzKGVsZW0uYXR0ciwgZWxlbS52YWx1ZSkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGV4cHJlc3Npb25zLmxlbmd0aCA/IGV4cHJlc3Npb25zLnJlZHVjZSgoZmUxLCBmZTIpID0+IEZpbHRlckV4cHJlc3Npb25VdGlscy5idWlsZENvbXBsZXhFeHByZXNzaW9uKGZlMSwgZmUyLCBGaWx0ZXJFeHByZXNzaW9uVXRpbHMuT1BfT1IpKSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGBCYXNpY0V4cHJlc3Npb25gIG9iamVjdCB3aXRoIHRoZSBmaWx0ZXIuXG4gICAqIEByZXR1cm5zIHRoZSBgQmFzaWNFeHByZXNzaW9uYCBvYmplY3Qgd2l0aCB0aGUgZmlsdGVyLlxuICAgKi9cbiAgZ2V0QmFzaWNFeHByZXNzaW9uKCk6IEJhc2ljRXhwcmVzc2lvbiB7XG4gICAgcmV0dXJuIEZpbHRlckV4cHJlc3Npb25VdGlscy5idWlsZEJhc2ljRXhwcmVzc2lvbih0aGlzLmdldEV4cHJlc3Npb24oKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZmlsdGVyIGJ1aWxkZXIgdGFyZ2V0IGNvbXBvbmVudC5cbiAgICogQHJldHVybnMgdGhlIHRhcmdldCBjb21wb25lbnQuXG4gICAqL1xuICBnZXRUYXJnZXRDb21wb25lbnQoKTogT1NlcnZpY2VDb21wb25lbnQge1xuICAgIHJldHVybiB0aGlzLnRhcmdldENtcDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmlnZ2VyIHRoZSBgcmVsb2FkRGF0YWAgbWV0aG9kIGZyb20gdGhlIHRhcmdldCBjb21wb25lbnQuXG4gICAqL1xuICB0cmlnZ2VyUmVsb2FkKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy50YXJnZXRDbXApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMudGFyZ2V0Q21wLnBhZ2VhYmxlKSB7XG4gICAgICB0aGlzLnRhcmdldENtcC5yZWxvYWRQYWdpbmF0ZWREYXRhRnJvbVN0YXJ0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGFyZ2V0Q21wLnJlbG9hZERhdGEoKTtcbiAgICB9XG4gICAgdGhpcy5vbkZpbHRlci5lbWl0KCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIGZvcm0gY29tcG9uZW50cyB1c2VkIGZvciB0aGUgZmlsdGVyLlxuICAgKi9cbiAgY2xlYXJGaWx0ZXIoKTogdm9pZCB7XG4gICAgY29uc3QgZm9ybUNvbXBvbmVudHMgPSB0aGlzLmZvcm0uZ2V0Q29tcG9uZW50cygpO1xuICAgIHRoaXMuZ2V0RmlsdGVyQXR0cnMoKS5mb3JFYWNoKChhdHRyOiBzdHJpbmcpID0+IHtcbiAgICAgIGZvcm1Db21wb25lbnRzW2F0dHJdLnNldFZhbHVlKHZvaWQgMCk7XG4gICAgfSk7XG4gICAgdGhpcy5vbkNsZWFyLmVtaXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFycmF5IHdpdGggdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIGZpbHRlcmFibGUgY29tcG9uZW50c1xuICAgKi9cbiAgcHJvdGVjdGVkIGdldEZpbHRlckF0dHJzKCk6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmZpbHRlckNvbXBvbmVudHMubWFwKChlbGVtOiBJRmlsdGVyQnVpbGRlckNtcFRhcmdldCkgPT4gZWxlbS5mb3JtQ29tcG9uZW50QXR0cik7XG4gIH1cblxufVxuIl19