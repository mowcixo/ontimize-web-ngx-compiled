import { Codes } from '../../../util/codes';
import { Util } from '../../../util/util';
export class OTableStorage {
    constructor(table) {
        this.table = table;
    }
    getDataToStore() {
        const dataToStore = {
            filter: this.table.oTableQuickFilterComponent ? this.table.oTableQuickFilterComponent.value : ''
        };
        const properties = ['sort', 'columns-display', 'columns-filter', 'quick-filter', 'page', 'selection', 'initial-configuration'];
        Object.assign(dataToStore, this.getTablePropertiesToStore(properties));
        const storedFiltersArr = this.getStoredFilters();
        if (storedFiltersArr.length > 0) {
            dataToStore[OTableStorage.USER_STORED_FILTERS_KEY] = storedFiltersArr;
        }
        const storedConfigurationsArr = this.getStoredConfigurations();
        if (storedConfigurationsArr.length > 0) {
            dataToStore[OTableStorage.STORED_CONFIGURATIONS_KEY] = storedConfigurationsArr;
        }
        return dataToStore;
    }
    getTablePropertiesToStore(properties) {
        const result = {};
        properties.forEach(prop => {
            Object.assign(result, this.getTablePropertyToStore(prop));
        });
        return result;
    }
    getTablePropertyToStore(property) {
        let result = {};
        switch (property) {
            case 'sort':
                result = this.getSortState();
                break;
            case 'columns-display':
                result = this.getColumnsDisplayState();
                break;
            case 'quick-filter':
                result = this.getColumnsQuickFilterState();
                break;
            case 'columns-filter':
                result = this.getColumnFiltersState();
                break;
            case 'page':
                result = this.getPageState();
                break;
            case 'selection':
                result = this.getSelectionState();
                break;
            case 'initial-configuration':
                result = this.getInitialConfigurationState();
                break;
        }
        return result;
    }
    reset() {
        const state = {};
        state[OTableStorage.USER_STORED_FILTERS_KEY] = this.table.state[OTableStorage.USER_STORED_FILTERS_KEY];
        state[OTableStorage.STORED_CONFIGURATIONS_KEY] = this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY];
        if (this.table.pageable) {
            state.totalQueryRecordsNumber = this.table.state.totalQueryRecordsNumber;
        }
        state.currentPage = 0;
        this.table.state = state;
    }
    getSortState() {
        const result = {};
        const sortColumnsArray = this.table.sort.getSortColumns();
        if (sortColumnsArray.length > 0) {
            const sortColumns = [];
            sortColumnsArray.forEach(sortData => {
                sortColumns.push(sortData.id + Codes.COLUMNS_ALIAS_SEPARATOR + sortData.direction);
            });
            result['sort-columns'] = sortColumns.join(Codes.ARRAY_INPUT_SEPARATOR);
        }
        return result;
    }
    getColumnFiltersState() {
        const result = {};
        if (this.table.oTableColumnsFilterComponent) {
            const columnValueFilters = this.table.dataSource.getColumnValueFilters();
            if (columnValueFilters.length > 0) {
                result['column-value-filters'] = columnValueFilters;
            }
        }
        return result;
    }
    getColumnsDisplayState() {
        const result = {};
        const oColumnsData = [];
        this.table.oTableOptions.columns.forEach((oCol) => {
            oColumnsData.push({
                attr: oCol.attr,
                visible: oCol.visible,
                width: oCol.getWidthToStore()
            });
        });
        result['oColumns-display'] = oColumnsData;
        result['select-column-visible'] = this.table.oTableOptions.selectColumn.visible;
        return result;
    }
    getColumnsQuickFilterState() {
        const result = {};
        const tableOptions = this.table.oTableOptions;
        const oColumnsData = [];
        tableOptions.columns.forEach((oCol) => {
            oColumnsData.push({
                attr: oCol.attr,
                searchable: oCol.searchable,
                searching: oCol.searching
            });
        });
        result.oColumns = oColumnsData;
        result['filter-case-sensitive'] = tableOptions.filterCaseSensitive;
        return result;
    }
    getPageState() {
        const result = {
            'query-rows': this.table.matpaginator ? this.table.matpaginator.pageSize : ''
        };
        if (this.table.currentPage > 0 && this.table.storePaginationState) {
            result.currentPage = this.table.currentPage;
        }
        if (this.table.pageable && this.table.storePaginationState) {
            const state = this.table.state;
            result.totalQueryRecordsNumber = state.totalQueryRecordsNumber;
            result.queryRecordOffset = Math.max((state.queryRecordOffset - this.table.dataSource.renderedData.length), (state.queryRecordOffset - this.table.queryRows));
        }
        return result;
    }
    getSelectionState() {
        const result = {
            selection: []
        };
        if (this.table && this.table.keepSelectedItems) {
            const selection = [];
            this.table.getSelectedItems().forEach(item => {
                const data = {};
                this.table.getKeys().forEach(key => {
                    data[key] = item[key];
                });
                selection.push(data);
            });
            result.selection = selection;
        }
        return result;
    }
    getInitialConfigurationState() {
        let result = {};
        let initialConfiguration = {};
        let oColumnsData = [];
        const self = this;
        Util.parseArray(this.table.visibleColumns, true).forEach((x) => {
            let oCol = self.table.getOColumn(x);
            oColumnsData.push({
                attr: oCol.attr,
                visible: true,
                width: oCol.definition ? oCol.definition.originalWidth : undefined
            });
        });
        initialConfiguration['oColumns-display'] = oColumnsData;
        initialConfiguration['sort-columns'] = this.table.sortColumns;
        initialConfiguration['select-column-visible'] = this.table.oTableOptions.selectColumn.visible;
        initialConfiguration['filter-case-sensitive'] = this.table.filterCaseSensitive;
        initialConfiguration['query-rows'] = this.table.originalQueryRows;
        result['initial-configuration'] = initialConfiguration;
        return result;
    }
    setStoredFilters(filters) {
        return this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = filters;
    }
    getStoredFilters() {
        return this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] || [];
    }
    getStoredFilter(filterName) {
        return this.getStoredFilters().find((item) => item.name === filterName);
    }
    getStoredFilterConf(filterName) {
        return (this.getStoredFilter(filterName) || {})[OTableStorage.STORED_FILTER_KEY];
    }
    deleteStoredFilter(filterName) {
        const storedFilters = this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] || [];
        const index = storedFilters.findIndex((item) => item.name === filterName);
        if (index >= 0) {
            storedFilters.splice(index, 1);
            this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = storedFilters;
        }
    }
    storeFilter(filterArgs) {
        const result = {};
        const storedFilter = {};
        Object.assign(storedFilter, this.getColumnFiltersState());
        Object.assign(storedFilter, this.getColumnsQuickFilterState());
        result[OTableStorage.STORED_FILTER_KEY] = storedFilter;
        Object.assign(result, filterArgs);
        const existingFilters = this.getStoredFilters();
        existingFilters.push(result);
        this.table.state[OTableStorage.USER_STORED_FILTERS_KEY] = existingFilters;
    }
    getStoredColumnsFilters(arg) {
        const stateObj = arg || this.table.state;
        return stateObj['column-value-filters'] || [];
    }
    getStoredConfigurations() {
        return this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] || [];
    }
    getStoredConfiguration(configurationName) {
        return this.getStoredConfigurations().find((item) => item.name === configurationName);
    }
    storeConfiguration(configurationAgs, tableProperties) {
        const result = {};
        this.table.storePaginationState = true;
        const storedConfiguration = this.getTablePropertiesToStore(tableProperties);
        this.table.storePaginationState = false;
        result[OTableStorage.STORED_CONFIGURATION_KEY] = storedConfiguration;
        Object.assign(result, configurationAgs);
        result[OTableStorage.STORED_PROPERTIES_KEY] = tableProperties;
        const existingConfigurations = this.getStoredConfigurations();
        existingConfigurations.push(result);
        this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] = existingConfigurations;
    }
    deleteStoredConfiguration(configurationName) {
        const storedConfigurations = this.getStoredConfigurations();
        const index = storedConfigurations.findIndex((item) => item.name === configurationName);
        if (index >= 0) {
            storedConfigurations.splice(index, 1);
            this.table.state[OTableStorage.STORED_CONFIGURATIONS_KEY] = storedConfigurations;
        }
    }
}
OTableStorage.STORED_FILTER_KEY = 'stored-filter';
OTableStorage.USER_STORED_FILTERS_KEY = 'user-stored-filters';
OTableStorage.STORED_CONFIGURATION_KEY = 'stored-configuration';
OTableStorage.STORED_PROPERTIES_KEY = 'stored-properties';
OTableStorage.STORED_CONFIGURATIONS_KEY = 'user-stored-configurations';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10YWJsZS1zdG9yYWdlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3RhYmxlL2V4dGVuc2lvbnMvby10YWJsZS1zdG9yYWdlLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJMUMsTUFBTSxPQUFPLGFBQWE7SUFTeEIsWUFDWSxLQUFzQjtRQUF0QixVQUFLLEdBQUwsS0FBSyxDQUFpQjtJQUM5QixDQUFDO0lBRUwsY0FBYztRQUNaLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUNqRyxDQUFDO1FBRUYsTUFBTSxVQUFVLEdBQUcsQ0FBQyxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztRQUUvSCxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUV2RSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2pELElBQUksZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQixXQUFXLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsZ0JBQWdCLENBQUM7U0FDdkU7UUFDRCxNQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQy9ELElBQUksdUJBQXVC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Li8uLi90eXBlcy9vLXRhYmxlLWNvbmZpZ3VyYXRpb24udHlwZSc7XG5pbXBvcnQgeyBPVGFibGVGaWx0ZXJzU3RhdHVzIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMvby10YWJsZS1maWx0ZXItc3RhdHVzLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi8uLi8uLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi8uLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgT0NvbHVtbiB9IGZyb20gJy4uL2NvbHVtbi9vLWNvbHVtbi5jbGFzcyc7XG5pbXBvcnQgeyBPVGFibGVDb21wb25lbnQgfSBmcm9tICcuLi9vLXRhYmxlLmNvbXBvbmVudCc7XG5cbmV4cG9ydCBjbGFzcyBPVGFibGVTdG9yYWdlIHtcblxuICBwdWJsaWMgc3RhdGljIFNUT1JFRF9GSUxURVJfS0VZID0gJ3N0b3JlZC1maWx0ZXInO1xuICBwdWJsaWMgc3RhdGljIFVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZID0gJ3VzZXItc3RvcmVkLWZpbHRlcnMnO1xuXG4gIHB1YmxpYyBzdGF0aWMgU1RPUkVEX0NPTkZJR1VSQVRJT05fS0VZID0gJ3N0b3JlZC1jb25maWd1cmF0aW9uJztcbiAgcHVibGljIHN0YXRpYyBTVE9SRURfUFJPUEVSVElFU19LRVkgPSAnc3RvcmVkLXByb3BlcnRpZXMnO1xuICBwdWJsaWMgc3RhdGljIFNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVkgPSAndXNlci1zdG9yZWQtY29uZmlndXJhdGlvbnMnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCB0YWJsZTogT1RhYmxlQ29tcG9uZW50XG4gICkgeyB9XG5cbiAgZ2V0RGF0YVRvU3RvcmUoKSB7XG4gICAgY29uc3QgZGF0YVRvU3RvcmUgPSB7XG4gICAgICBmaWx0ZXI6IHRoaXMudGFibGUub1RhYmxlUXVpY2tGaWx0ZXJDb21wb25lbnQgPyB0aGlzLnRhYmxlLm9UYWJsZVF1aWNrRmlsdGVyQ29tcG9uZW50LnZhbHVlIDogJydcbiAgICB9O1xuXG4gICAgY29uc3QgcHJvcGVydGllcyA9IFsnc29ydCcsICdjb2x1bW5zLWRpc3BsYXknLCAnY29sdW1ucy1maWx0ZXInLCAncXVpY2stZmlsdGVyJywgJ3BhZ2UnLCAnc2VsZWN0aW9uJywgJ2luaXRpYWwtY29uZmlndXJhdGlvbiddO1xuXG4gICAgT2JqZWN0LmFzc2lnbihkYXRhVG9TdG9yZSwgdGhpcy5nZXRUYWJsZVByb3BlcnRpZXNUb1N0b3JlKHByb3BlcnRpZXMpKTtcblxuICAgIGNvbnN0IHN0b3JlZEZpbHRlcnNBcnIgPSB0aGlzLmdldFN0b3JlZEZpbHRlcnMoKTtcbiAgICBpZiAoc3RvcmVkRmlsdGVyc0Fyci5sZW5ndGggPiAwKSB7XG4gICAgICBkYXRhVG9TdG9yZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXSA9IHN0b3JlZEZpbHRlcnNBcnI7XG4gICAgfVxuICAgIGNvbnN0IHN0b3JlZENvbmZpZ3VyYXRpb25zQXJyID0gdGhpcy5nZXRTdG9yZWRDb25maWd1cmF0aW9ucygpO1xuICAgIGlmIChzdG9yZWRDb25maWd1cmF0aW9uc0Fyci5sZW5ndGggPiAwKSB7XG4gICAgICBkYXRhVG9TdG9yZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldID0gc3RvcmVkQ29uZmlndXJhdGlvbnNBcnI7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGFUb1N0b3JlO1xuICB9XG5cbiAgZ2V0VGFibGVQcm9wZXJ0aWVzVG9TdG9yZShwcm9wZXJ0aWVzOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIHByb3BlcnRpZXMuZm9yRWFjaChwcm9wID0+IHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocmVzdWx0LCB0aGlzLmdldFRhYmxlUHJvcGVydHlUb1N0b3JlKHByb3ApKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgZ2V0VGFibGVQcm9wZXJ0eVRvU3RvcmUocHJvcGVydHk6IHN0cmluZykge1xuICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICBzd2l0Y2ggKHByb3BlcnR5KSB7XG4gICAgICBjYXNlICdzb3J0JzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRTb3J0U3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjb2x1bW5zLWRpc3BsYXknOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldENvbHVtbnNEaXNwbGF5U3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdxdWljay1maWx0ZXInOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldENvbHVtbnNRdWlja0ZpbHRlclN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29sdW1ucy1maWx0ZXInOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldENvbHVtbkZpbHRlcnNTdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3BhZ2UnOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldFBhZ2VTdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NlbGVjdGlvbic6XG4gICAgICAgIHJlc3VsdCA9IHRoaXMuZ2V0U2VsZWN0aW9uU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdpbml0aWFsLWNvbmZpZ3VyYXRpb24nOlxuICAgICAgICByZXN1bHQgPSB0aGlzLmdldEluaXRpYWxDb25maWd1cmF0aW9uU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICBjb25zdCBzdGF0ZTogYW55ID0ge307XG4gICAgc3RhdGVbT1RhYmxlU3RvcmFnZS5VU0VSX1NUT1JFRF9GSUxURVJTX0tFWV0gPSB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuVVNFUl9TVE9SRURfRklMVEVSU19LRVldO1xuICAgIHN0YXRlW09UYWJsZVN0b3JhZ2UuU1RPUkVEX0NPTkZJR1VSQVRJT05TX0tFWV0gPSB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuU1RPUkVEX0NPTkZJR1VSQVRJT05TX0tFWV07XG4gICAgaWYgKHRoaXMudGFibGUucGFnZWFibGUpIHtcbiAgICAgIHN0YXRlLnRvdGFsUXVlcnlSZWNvcmRzTnVtYmVyID0gdGhpcy50YWJsZS5zdGF0ZS50b3RhbFF1ZXJ5UmVjb3Jkc051bWJlcjtcbiAgICB9XG4gICAgc3RhdGUuY3VycmVudFBhZ2UgPSAwO1xuICAgIHRoaXMudGFibGUuc3RhdGUgPSBzdGF0ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTb3J0U3RhdGUoKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgc29ydENvbHVtbnNBcnJheSA9IHRoaXMudGFibGUuc29ydC5nZXRTb3J0Q29sdW1ucygpO1xuICAgIGlmIChzb3J0Q29sdW1uc0FycmF5Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHNvcnRDb2x1bW5zID0gW107XG4gICAgICBzb3J0Q29sdW1uc0FycmF5LmZvckVhY2goc29ydERhdGEgPT4ge1xuICAgICAgICBzb3J0Q29sdW1ucy5wdXNoKHNvcnREYXRhLmlkICsgQ29kZXMuQ09MVU1OU19BTElBU19TRVBBUkFUT1IgKyBzb3J0RGF0YS5kaXJlY3Rpb24pO1xuICAgICAgfSk7XG4gICAgICByZXN1bHRbJ3NvcnQtY29sdW1ucyddID0gc29ydENvbHVtbnMuam9pbihDb2Rlcy5BUlJBWV9JTlBVVF9TRVBBUkFUT1IpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbHVtbkZpbHRlcnNTdGF0ZSgpIHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBpZiAodGhpcy50YWJsZS5vVGFibGVDb2x1bW5zRmlsdGVyQ29tcG9uZW50KSB7XG4gICAgICBjb25zdCBjb2x1bW5WYWx1ZUZpbHRlcnMgPSB0aGlzLnRhYmxlLmRhdGFTb3VyY2UuZ2V0Q29sdW1uVmFsdWVGaWx0ZXJzKCk7XG4gICAgICBpZiAoY29sdW1uVmFsdWVGaWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzdWx0Wydjb2x1bW4tdmFsdWUtZmlsdGVycyddID0gY29sdW1uVmFsdWVGaWx0ZXJzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbHVtbnNEaXNwbGF5U3RhdGUoKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgb0NvbHVtbnNEYXRhID0gW107XG4gICAgdGhpcy50YWJsZS5vVGFibGVPcHRpb25zLmNvbHVtbnMuZm9yRWFjaCgob0NvbDogT0NvbHVtbikgPT4ge1xuICAgICAgb0NvbHVtbnNEYXRhLnB1c2goe1xuICAgICAgICBhdHRyOiBvQ29sLmF0dHIsXG4gICAgICAgIHZpc2libGU6IG9Db2wudmlzaWJsZSxcbiAgICAgICAgd2lkdGg6IG9Db2wuZ2V0V2lkdGhUb1N0b3JlKClcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlc3VsdFsnb0NvbHVtbnMtZGlzcGxheSddID0gb0NvbHVtbnNEYXRhO1xuICAgIHJlc3VsdFsnc2VsZWN0LWNvbHVtbi12aXNpYmxlJ10gPSB0aGlzLnRhYmxlLm9UYWJsZU9wdGlvbnMuc2VsZWN0Q29sdW1uLnZpc2libGU7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDb2x1bW5zUXVpY2tGaWx0ZXJTdGF0ZSgpIHtcbiAgICBjb25zdCByZXN1bHQ6IGFueSA9IHt9O1xuICAgIGNvbnN0IHRhYmxlT3B0aW9ucyA9IHRoaXMudGFibGUub1RhYmxlT3B0aW9ucztcbiAgICBjb25zdCBvQ29sdW1uc0RhdGEgPSBbXTtcbiAgICB0YWJsZU9wdGlvbnMuY29sdW1ucy5mb3JFYWNoKChvQ29sOiBPQ29sdW1uKSA9PiB7XG4gICAgICBvQ29sdW1uc0RhdGEucHVzaCh7XG4gICAgICAgIGF0dHI6IG9Db2wuYXR0cixcbiAgICAgICAgc2VhcmNoYWJsZTogb0NvbC5zZWFyY2hhYmxlLFxuICAgICAgICBzZWFyY2hpbmc6IG9Db2wuc2VhcmNoaW5nXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXN1bHQub0NvbHVtbnMgPSBvQ29sdW1uc0RhdGE7XG4gICAgcmVzdWx0WydmaWx0ZXItY2FzZS1zZW5zaXRpdmUnXSA9IHRhYmxlT3B0aW9ucy5maWx0ZXJDYXNlU2Vuc2l0aXZlO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0UGFnZVN0YXRlKCk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7XG4gICAgICAncXVlcnktcm93cyc6IHRoaXMudGFibGUubWF0cGFnaW5hdG9yID8gdGhpcy50YWJsZS5tYXRwYWdpbmF0b3IucGFnZVNpemUgOiAnJ1xuICAgIH07XG4gICAgaWYgKHRoaXMudGFibGUuY3VycmVudFBhZ2UgPiAwICYmIHRoaXMudGFibGUuc3RvcmVQYWdpbmF0aW9uU3RhdGUpIHtcbiAgICAgIHJlc3VsdC5jdXJyZW50UGFnZSA9IHRoaXMudGFibGUuY3VycmVudFBhZ2U7XG4gICAgfVxuICAgIGlmICh0aGlzLnRhYmxlLnBhZ2VhYmxlICYmIHRoaXMudGFibGUuc3RvcmVQYWdpbmF0aW9uU3RhdGUpIHtcbiAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy50YWJsZS5zdGF0ZTtcbiAgICAgIHJlc3VsdC50b3RhbFF1ZXJ5UmVjb3Jkc051bWJlciA9IHN0YXRlLnRvdGFsUXVlcnlSZWNvcmRzTnVtYmVyO1xuICAgICAgcmVzdWx0LnF1ZXJ5UmVjb3JkT2Zmc2V0ID0gTWF0aC5tYXgoXG4gICAgICAgIChzdGF0ZS5xdWVyeVJlY29yZE9mZnNldCAtIHRoaXMudGFibGUuZGF0YVNvdXJjZS5yZW5kZXJlZERhdGEubGVuZ3RoKSxcbiAgICAgICAgKHN0YXRlLnF1ZXJ5UmVjb3JkT2Zmc2V0IC0gdGhpcy50YWJsZS5xdWVyeVJvd3MpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFNlbGVjdGlvblN0YXRlKCk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7XG4gICAgICBzZWxlY3Rpb246IFtdXG4gICAgfTtcbiAgICBpZiAodGhpcy50YWJsZSAmJiB0aGlzLnRhYmxlLmtlZXBTZWxlY3RlZEl0ZW1zKSB7XG4gICAgICAvLyBzdG9yaW5nIHNlbGVjdGVkIGl0ZW1zIGtleXMgdmFsdWVzXG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSBbXTtcbiAgICAgIHRoaXMudGFibGUuZ2V0U2VsZWN0ZWRJdGVtcygpLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7fTtcbiAgICAgICAgdGhpcy50YWJsZS5nZXRLZXlzKCkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgIGRhdGFba2V5XSA9IGl0ZW1ba2V5XTtcbiAgICAgICAgfSk7XG4gICAgICAgIHNlbGVjdGlvbi5wdXNoKGRhdGEpO1xuICAgICAgfSk7XG4gICAgICByZXN1bHQuc2VsZWN0aW9uID0gc2VsZWN0aW9uO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldEluaXRpYWxDb25maWd1cmF0aW9uU3RhdGUoKTogYW55IHtcbiAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgbGV0IGluaXRpYWxDb25maWd1cmF0aW9uID0ge307XG5cbiAgICBsZXQgb0NvbHVtbnNEYXRhID0gW107XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgVXRpbC5wYXJzZUFycmF5KHRoaXMudGFibGUudmlzaWJsZUNvbHVtbnMsIHRydWUpLmZvckVhY2goKHg6IHN0cmluZykgPT4ge1xuICAgICAgbGV0IG9Db2wgPSBzZWxmLnRhYmxlLmdldE9Db2x1bW4oeCk7XG4gICAgICBvQ29sdW1uc0RhdGEucHVzaCh7XG4gICAgICAgIGF0dHI6IG9Db2wuYXR0cixcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgd2lkdGg6IG9Db2wuZGVmaW5pdGlvbiA/IG9Db2wuZGVmaW5pdGlvbi5vcmlnaW5hbFdpZHRoIDogdW5kZWZpbmVkXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGluaXRpYWxDb25maWd1cmF0aW9uWydvQ29sdW1ucy1kaXNwbGF5J10gPSBvQ29sdW1uc0RhdGE7XG4gICAgaW5pdGlhbENvbmZpZ3VyYXRpb25bJ3NvcnQtY29sdW1ucyddID0gdGhpcy50YWJsZS5zb3J0Q29sdW1ucztcbiAgICBpbml0aWFsQ29uZmlndXJhdGlvblsnc2VsZWN0LWNvbHVtbi12aXNpYmxlJ10gPSB0aGlzLnRhYmxlLm9UYWJsZU9wdGlvbnMuc2VsZWN0Q29sdW1uLnZpc2libGU7XG4gICAgaW5pdGlhbENvbmZpZ3VyYXRpb25bJ2ZpbHRlci1jYXNlLXNlbnNpdGl2ZSddID0gdGhpcy50YWJsZS5maWx0ZXJDYXNlU2Vuc2l0aXZlO1xuICAgIGluaXRpYWxDb25maWd1cmF0aW9uWydxdWVyeS1yb3dzJ10gPSB0aGlzLnRhYmxlLm9yaWdpbmFsUXVlcnlSb3dzO1xuXG4gICAgcmVzdWx0Wydpbml0aWFsLWNvbmZpZ3VyYXRpb24nXSA9IGluaXRpYWxDb25maWd1cmF0aW9uO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHNldFN0b3JlZEZpbHRlcnMoZmlsdGVyczogQXJyYXk8T1RhYmxlRmlsdGVyc1N0YXR1cz4pIHtcbiAgICByZXR1cm4gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXSA9IGZpbHRlcnM7XG4gIH1cblxuICBnZXRTdG9yZWRGaWx0ZXJzKCkge1xuICAgIHJldHVybiB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuVVNFUl9TVE9SRURfRklMVEVSU19LRVldIHx8IFtdO1xuICB9XG5cbiAgZ2V0U3RvcmVkRmlsdGVyKGZpbHRlck5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmdldFN0b3JlZEZpbHRlcnMoKS5maW5kKChpdGVtOiBPVGFibGVGaWx0ZXJzU3RhdHVzKSA9PiBpdGVtLm5hbWUgPT09IGZpbHRlck5hbWUpO1xuICB9XG5cbiAgZ2V0U3RvcmVkRmlsdGVyQ29uZihmaWx0ZXJOYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKHRoaXMuZ2V0U3RvcmVkRmlsdGVyKGZpbHRlck5hbWUpIHx8IHt9KVtPVGFibGVTdG9yYWdlLlNUT1JFRF9GSUxURVJfS0VZXTtcbiAgfVxuXG4gIGRlbGV0ZVN0b3JlZEZpbHRlcihmaWx0ZXJOYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzdG9yZWRGaWx0ZXJzID0gdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlVTRVJfU1RPUkVEX0ZJTFRFUlNfS0VZXSB8fCBbXTtcbiAgICBjb25zdCBpbmRleCA9IHN0b3JlZEZpbHRlcnMuZmluZEluZGV4KChpdGVtOiBPVGFibGVGaWx0ZXJzU3RhdHVzKSA9PiBpdGVtLm5hbWUgPT09IGZpbHRlck5hbWUpO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICBzdG9yZWRGaWx0ZXJzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuVVNFUl9TVE9SRURfRklMVEVSU19LRVldID0gc3RvcmVkRmlsdGVycztcbiAgICB9XG4gIH1cblxuICBzdG9yZUZpbHRlcihmaWx0ZXJBcmdzOiBPVGFibGVGaWx0ZXJzU3RhdHVzKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgc3RvcmVkRmlsdGVyID0ge307XG4gICAgT2JqZWN0LmFzc2lnbihzdG9yZWRGaWx0ZXIsIHRoaXMuZ2V0Q29sdW1uRmlsdGVyc1N0YXRlKCkpO1xuICAgIE9iamVjdC5hc3NpZ24oc3RvcmVkRmlsdGVyLCB0aGlzLmdldENvbHVtbnNRdWlja0ZpbHRlclN0YXRlKCkpO1xuXG4gICAgcmVzdWx0W09UYWJsZVN0b3JhZ2UuU1RPUkVEX0ZJTFRFUl9LRVldID0gc3RvcmVkRmlsdGVyO1xuICAgIE9iamVjdC5hc3NpZ24ocmVzdWx0LCBmaWx0ZXJBcmdzKTtcbiAgICBjb25zdCBleGlzdGluZ0ZpbHRlcnMgPSB0aGlzLmdldFN0b3JlZEZpbHRlcnMoKTtcbiAgICBleGlzdGluZ0ZpbHRlcnMucHVzaChyZXN1bHQpO1xuICAgIHRoaXMudGFibGUuc3RhdGVbT1RhYmxlU3RvcmFnZS5VU0VSX1NUT1JFRF9GSUxURVJTX0tFWV0gPSBleGlzdGluZ0ZpbHRlcnM7XG4gIH1cblxuICBnZXRTdG9yZWRDb2x1bW5zRmlsdGVycyhhcmc/OiBhbnkpIHtcbiAgICBjb25zdCBzdGF0ZU9iaiA9IGFyZyB8fCB0aGlzLnRhYmxlLnN0YXRlO1xuICAgIHJldHVybiBzdGF0ZU9ialsnY29sdW1uLXZhbHVlLWZpbHRlcnMnXSB8fCBbXTtcbiAgfVxuXG4gIGdldFN0b3JlZENvbmZpZ3VyYXRpb25zKCkge1xuICAgIHJldHVybiB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuU1RPUkVEX0NPTkZJR1VSQVRJT05TX0tFWV0gfHwgW107XG4gIH1cblxuICBnZXRTdG9yZWRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb25OYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTdG9yZWRDb25maWd1cmF0aW9ucygpLmZpbmQoKGl0ZW06IE9UYWJsZUNvbmZpZ3VyYXRpb24pID0+IGl0ZW0ubmFtZSA9PT0gY29uZmlndXJhdGlvbk5hbWUpO1xuICB9XG5cbiAgc3RvcmVDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb25BZ3M6IE9UYWJsZUNvbmZpZ3VyYXRpb24sIHRhYmxlUHJvcGVydGllczogYW55W10pIHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICB0aGlzLnRhYmxlLnN0b3JlUGFnaW5hdGlvblN0YXRlID0gdHJ1ZTtcbiAgICBjb25zdCBzdG9yZWRDb25maWd1cmF0aW9uID0gdGhpcy5nZXRUYWJsZVByb3BlcnRpZXNUb1N0b3JlKHRhYmxlUHJvcGVydGllcyk7XG4gICAgdGhpcy50YWJsZS5zdG9yZVBhZ2luYXRpb25TdGF0ZSA9IGZhbHNlO1xuXG4gICAgcmVzdWx0W09UYWJsZVN0b3JhZ2UuU1RPUkVEX0NPTkZJR1VSQVRJT05fS0VZXSA9IHN0b3JlZENvbmZpZ3VyYXRpb247XG4gICAgT2JqZWN0LmFzc2lnbihyZXN1bHQsIGNvbmZpZ3VyYXRpb25BZ3MpO1xuICAgIHJlc3VsdFtPVGFibGVTdG9yYWdlLlNUT1JFRF9QUk9QRVJUSUVTX0tFWV0gPSB0YWJsZVByb3BlcnRpZXM7XG4gICAgY29uc3QgZXhpc3RpbmdDb25maWd1cmF0aW9ucyA9IHRoaXMuZ2V0U3RvcmVkQ29uZmlndXJhdGlvbnMoKTtcbiAgICBleGlzdGluZ0NvbmZpZ3VyYXRpb25zLnB1c2gocmVzdWx0KTtcbiAgICB0aGlzLnRhYmxlLnN0YXRlW09UYWJsZVN0b3JhZ2UuU1RPUkVEX0NPTkZJR1VSQVRJT05TX0tFWV0gPSBleGlzdGluZ0NvbmZpZ3VyYXRpb25zO1xuICB9XG5cbiAgZGVsZXRlU3RvcmVkQ29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3RvcmVkQ29uZmlndXJhdGlvbnMgPSB0aGlzLmdldFN0b3JlZENvbmZpZ3VyYXRpb25zKCk7XG4gICAgY29uc3QgaW5kZXggPSBzdG9yZWRDb25maWd1cmF0aW9ucy5maW5kSW5kZXgoKGl0ZW06IE9UYWJsZUNvbmZpZ3VyYXRpb24pID0+IGl0ZW0ubmFtZSA9PT0gY29uZmlndXJhdGlvbk5hbWUpO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICBzdG9yZWRDb25maWd1cmF0aW9ucy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgdGhpcy50YWJsZS5zdGF0ZVtPVGFibGVTdG9yYWdlLlNUT1JFRF9DT05GSUdVUkFUSU9OU19LRVldID0gc3RvcmVkQ29uZmlndXJhdGlvbnM7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==