import { Directive, EventEmitter, Output } from '@angular/core';
import { MatSort } from '@angular/material';
import { Codes } from '../../../../util/codes';
import { Util } from '../../../../util/util';
export class OMatSort extends MatSort {
    constructor() {
        super(...arguments);
        this.activeArray = [];
        this.directionById = {};
        this.oSortChange = new EventEmitter();
    }
    setMultipleSort(val) {
        this.multipleSort = val;
    }
    getSortColumns() {
        const activeData = [];
        this.activeArray.forEach((s) => {
            activeData.push({
                id: s.id,
                direction: this.directionById[s.id]
            });
        });
        return activeData;
    }
    setTableInfo(sortColArray) {
        sortColArray.forEach((colData) => {
            const sortDirection = colData.ascendent ? Codes.ASC_SORT : Codes.DESC_SORT;
            this.activeArray.push({
                id: colData.columnName,
                start: sortDirection,
                disableClear: false
            });
            this.directionById[colData.columnName] = sortDirection;
        });
    }
    addSortColumn(sortable) {
        if (this.isActive(sortable)) {
            this.direction = this.directionById[sortable.id];
            this.directionById[sortable.id] = this.getNextSortDirection(sortable);
            this.direction = '';
            if (this.directionById[sortable.id] === '') {
                this.deleteSortColumn(sortable.id);
            }
        }
        else {
            if (!this.multipleSort) {
                this.activeArray = [];
                this.directionById = {};
            }
            this.activeArray.push(sortable);
            this.directionById[sortable.id] = sortable.start ? sortable.start : this.start;
        }
        const activeData = this.getSortColumns();
        this._stateChanges.next();
        this.oSortChange.emit(activeData);
    }
    deleteSortColumn(id) {
        delete this.directionById[id];
        for (let i = 0, len = this.activeArray.length; i < len; i++) {
            if (this.activeArray[i].id === id) {
                this.activeArray.splice(i, 1);
                break;
            }
        }
    }
    isActive(sortable) {
        return Util.isDefined(this.activeArray.find((s) => sortable.id === s.id));
    }
    hasDirection(id) {
        let direction;
        if (Util.isDefined(this.directionById[id])) {
            direction = this.directionById[id];
        }
        return (direction === 'asc' || direction === 'desc');
    }
    getSortedData(data) {
        const sortColumns = this.getSortColumns();
        if (sortColumns.length === 0 || data.length === 0) {
            return data;
        }
        this.sortables.forEach((value, key) => {
            this.deregister(value);
        });
        return this.sortByColumns(data, sortColumns);
    }
    sortByColumns(data, sortColumns) {
        const sortFunctionBind = this.sortFunction.bind(this);
        for (let i = 0, len = sortColumns.length; i < len; i++) {
            const sortC = sortColumns[i];
            this.activeSortColumn = sortC.id;
            this.activeSortDirection = sortC.direction;
            if (i === 0) {
                data = data.sort(sortFunctionBind);
            }
            else {
                const groupedData = this.getDataGrouped(data, sortColumns, i);
                if (groupedData.length >= data.length) {
                    break;
                }
                data = this.sortGroupedData(groupedData);
            }
        }
        return data;
    }
    getDataGrouped(data, sortColumns, index) {
        const propArr = [];
        sortColumns.forEach((item, i) => {
            if (i < index) {
                propArr.push(item.id);
            }
        });
        if (propArr.length === 0) {
            return data;
        }
        const result = [];
        data.forEach(item => {
            let value = '';
            propArr.forEach(prop => {
                value += item[prop];
            });
            const filtered = result.filter(resItem => resItem.key === value);
            if (filtered.length === 0) {
                result.push({
                    key: value,
                    values: [item]
                });
            }
            else if (filtered.length === 1) {
                filtered[0].values.push(item);
            }
        });
        return result;
    }
    sortGroupedData(groupedData) {
        const self = this;
        return groupedData.reduce((obj, item) => {
            const arr = item.values;
            const sorted = arr.length <= 1 ? arr : arr.sort(self.sortFunction.bind(self));
            obj.push(...sorted);
            return obj;
        }, []);
    }
    sortFunction(a, b) {
        let propertyA = '';
        let propertyB = '';
        [propertyA, propertyB] = [a[this.activeSortColumn], b[this.activeSortColumn]];
        const valueA = typeof propertyA === 'undefined' ? '' : propertyA === '' ? propertyA : isNaN(+propertyA) ? propertyA.toString().trim().toLowerCase() : +propertyA;
        const valueB = typeof propertyB === 'undefined' ? '' : propertyB === '' ? propertyB : isNaN(+propertyB) ? propertyB.toString().trim().toLowerCase() : +propertyB;
        return (valueA <= valueB ? -1 : 1) * (this.activeSortDirection === 'asc' ? 1 : -1);
    }
}
OMatSort.decorators = [
    { type: Directive, args: [{
                selector: '[oMatSort]',
                exportAs: 'oMatSort',
                inputs: ['disabled: oMatSortDisabled']
            },] }
];
OMatSort.propDecorators = {
    oSortChange: [{ type: Output, args: ['matSortChange',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1tYXQtc29ydC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy90YWJsZS9leHRlbnNpb25zL3NvcnQvby1tYXQtc29ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBZSxNQUFNLG1CQUFtQixDQUFDO0FBR3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMvQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFZN0MsTUFBTSxPQUFPLFFBQVMsU0FBUSxPQUFPO0lBTHJDOztRQU9FLGdCQUFXLEdBQXVCLEVBQUUsQ0FBQztRQUNyQyxrQkFBYSxHQUFRLEVBQUUsQ0FBQztRQU1VLGdCQUFXLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUF5SjdGLENBQUM7SUF2SkMsZUFBZSxDQUFDLEdBQVk7UUFDMUIsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUM7SUFDMUIsQ0FBQztJQUVELGNBQWM7UUFDWixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFjLEVBQUUsRUFBRTtZQUMxQyxVQUFVLENBQUMsSUFBSSxDQUFDO2dCQUNkLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDUixTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2FBQ3BDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVELFlBQVksQ0FBQyxZQUE2QjtRQUN4QyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBaUIsRUFBRSxF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TSxHQUFHLE9BQU8sU0FBUyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2pLLE1BQU0sTUFBTSxHQUFHLE9BQU8sU0FBUyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2pLLE9BQU8sQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckYsQ0FBQzs7O1lBcktGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsWUFBWTtnQkFDdEIsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLE1BQU0sRUFBRSxDQUFDLDRCQUE0QixDQUFDO2FBQ3ZDOzs7MEJBVUUsTUFBTSxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXRTb3J0LCBNYXRTb3J0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcblxuaW1wb3J0IHsgU1FMT3JkZXIgfSBmcm9tICcuLi8uLi8uLi8uLi90eXBlcy9zcWwtb3JkZXIudHlwZSc7XG5pbXBvcnQgeyBDb2RlcyB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWwvY29kZXMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWwvdXRpbCc7XG5cbmV4cG9ydCB0eXBlIE9NYXRTb3J0R3JvdXBlZERhdGEgPSB7XG4gIGtleTogYW55O1xuICB2YWx1ZXM6IGFueVtdO1xufTtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW29NYXRTb3J0XScsXG4gIGV4cG9ydEFzOiAnb01hdFNvcnQnLFxuICBpbnB1dHM6IFsnZGlzYWJsZWQ6IG9NYXRTb3J0RGlzYWJsZWQnXVxufSlcbmV4cG9ydCBjbGFzcyBPTWF0U29ydCBleHRlbmRzIE1hdFNvcnQge1xuXG4gIGFjdGl2ZUFycmF5OiBBcnJheTxNYXRTb3J0YWJsZT4gPSBbXTtcbiAgZGlyZWN0aW9uQnlJZDogYW55ID0ge307XG5cbiAgcHJvdGVjdGVkIG11bHRpcGxlU29ydDogYm9vbGVhbjtcbiAgcHJvdGVjdGVkIGFjdGl2ZVNvcnRDb2x1bW46IHN0cmluZztcbiAgcHJvdGVjdGVkIGFjdGl2ZVNvcnREaXJlY3Rpb246IHN0cmluZztcblxuICBAT3V0cHV0KCdtYXRTb3J0Q2hhbmdlJykgcmVhZG9ubHkgb1NvcnRDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgc2V0TXVsdGlwbGVTb3J0KHZhbDogYm9vbGVhbikge1xuICAgIHRoaXMubXVsdGlwbGVTb3J0ID0gdmFsO1xuICB9XG5cbiAgZ2V0U29ydENvbHVtbnMoKTogYW55W10ge1xuICAgIGNvbnN0IGFjdGl2ZURhdGEgPSBbXTtcbiAgICB0aGlzLmFjdGl2ZUFycmF5LmZvckVhY2goKHM6IE1hdFNvcnRhYmxlKSA9PiB7XG4gICAgICBhY3RpdmVEYXRhLnB1c2goe1xuICAgICAgICBpZDogcy5pZCxcbiAgICAgICAgZGlyZWN0aW9uOiB0aGlzLmRpcmVjdGlvbkJ5SWRbcy5pZF1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBhY3RpdmVEYXRhO1xuICB9XG5cbiAgc2V0VGFibGVJbmZvKHNvcnRDb2xBcnJheTogQXJyYXk8U1FMT3JkZXI+KSB7XG4gICAgc29ydENvbEFycmF5LmZvckVhY2goKGNvbERhdGE6IFNRTE9yZGVyKSA9PiB7XG4gICAgICBjb25zdCBzb3J0RGlyZWN0aW9uOiBhbnkgPSBjb2xEYXRhLmFzY2VuZGVudCA/IENvZGVzLkFTQ19TT1JUIDogQ29kZXMuREVTQ19TT1JUO1xuICAgICAgdGhpcy5hY3RpdmVBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGNvbERhdGEuY29sdW1uTmFtZSxcbiAgICAgICAgc3RhcnQ6IHNvcnREaXJlY3Rpb24sXG4gICAgICAgIGRpc2FibGVDbGVhcjogZmFsc2VcbiAgICAgIH0pO1xuICAgICAgdGhpcy5kaXJlY3Rpb25CeUlkW2NvbERhdGEuY29sdW1uTmFtZV0gPSBzb3J0RGlyZWN0aW9uO1xuICAgIH0pO1xuICB9XG5cbiAgYWRkU29ydENvbHVtbihzb3J0YWJsZTogTWF0U29ydGFibGUpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc0FjdGl2ZShzb3J0YWJsZSkpIHtcbiAgICAgIC8vIHdvcmthcm91bmQgZm9yIGhhdmluZyBhIHByb3BwZXIgd29yayBpbiBnZXROZXh0U29ydERpcmVjdGlvbjtcbiAgICAgIHRoaXMuZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb25CeUlkW3NvcnRhYmxlLmlkXTtcbiAgICAgIHRoaXMuZGlyZWN0aW9uQnlJZFtzb3J0YWJsZS5pZF0gPSB0aGlzLmdldE5leHRTb3J0RGlyZWN0aW9uKHNvcnRhYmxlKTtcbiAgICAgIHRoaXMuZGlyZWN0aW9uID0gJyc7XG4gICAgICBpZiAodGhpcy5kaXJlY3Rpb25CeUlkW3NvcnRhYmxlLmlkXSA9PT0gJycpIHtcbiAgICAgICAgdGhpcy5kZWxldGVTb3J0Q29sdW1uKHNvcnRhYmxlLmlkKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLm11bHRpcGxlU29ydCkge1xuICAgICAgICB0aGlzLmFjdGl2ZUFycmF5ID0gW107XG4gICAgICAgIHRoaXMuZGlyZWN0aW9uQnlJZCA9IHt9O1xuICAgICAgfVxuICAgICAgdGhpcy5hY3RpdmVBcnJheS5wdXNoKHNvcnRhYmxlKTtcbiAgICAgIHRoaXMuZGlyZWN0aW9uQnlJZFtzb3J0YWJsZS5pZF0gPSBzb3J0YWJsZS5zdGFydCA/IHNvcnRhYmxlLnN0YXJ0IDogdGhpcy5zdGFydDtcbiAgICB9XG4gICAgY29uc3QgYWN0aXZlRGF0YSA9IHRoaXMuZ2V0U29ydENvbHVtbnMoKTtcbiAgICB0aGlzLl9zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICAgIHRoaXMub1NvcnRDaGFuZ2UuZW1pdChhY3RpdmVEYXRhKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBkZWxldGVTb3J0Q29sdW1uKGlkOiBzdHJpbmcpIHtcbiAgICBkZWxldGUgdGhpcy5kaXJlY3Rpb25CeUlkW2lkXTtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdGhpcy5hY3RpdmVBcnJheS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgaWYgKHRoaXMuYWN0aXZlQXJyYXlbaV0uaWQgPT09IGlkKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlQXJyYXkuc3BsaWNlKGksIDEpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpc0FjdGl2ZShzb3J0YWJsZTogTWF0U29ydGFibGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gVXRpbC5pc0RlZmluZWQodGhpcy5hY3RpdmVBcnJheS5maW5kKChzOiBNYXRTb3J0YWJsZSkgPT4gc29ydGFibGUuaWQgPT09IHMuaWQpKTtcbiAgfVxuXG4gIGhhc0RpcmVjdGlvbihpZDogYW55KTogYm9vbGVhbiB7XG4gICAgbGV0IGRpcmVjdGlvbjtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQodGhpcy5kaXJlY3Rpb25CeUlkW2lkXSkpIHtcbiAgICAgIGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uQnlJZFtpZF07XG4gICAgfVxuICAgIHJldHVybiAoZGlyZWN0aW9uID09PSAnYXNjJyB8fCBkaXJlY3Rpb24gPT09ICdkZXNjJyk7XG4gIH1cblxuICBnZXRTb3J0ZWREYXRhKGRhdGE6IGFueVtdKTogYW55W10ge1xuICAgIGNvbnN0IHNvcnRDb2x1bW5zID0gdGhpcy5nZXRTb3J0Q29sdW1ucygpO1xuICAgIGlmIChzb3J0Q29sdW1ucy5sZW5ndGggPT09IDAgfHwgZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgICB0aGlzLnNvcnRhYmxlcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICB0aGlzLmRlcmVnaXN0ZXIodmFsdWUpO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLnNvcnRCeUNvbHVtbnMoZGF0YSwgc29ydENvbHVtbnMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNvcnRCeUNvbHVtbnMoZGF0YTogYW55W10sIHNvcnRDb2x1bW5zOiBhbnlbXSkge1xuICAgIGNvbnN0IHNvcnRGdW5jdGlvbkJpbmQgPSB0aGlzLnNvcnRGdW5jdGlvbi5iaW5kKHRoaXMpO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzb3J0Q29sdW1ucy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3Qgc29ydEMgPSBzb3J0Q29sdW1uc1tpXTtcbiAgICAgIHRoaXMuYWN0aXZlU29ydENvbHVtbiA9IHNvcnRDLmlkO1xuICAgICAgdGhpcy5hY3RpdmVTb3J0RGlyZWN0aW9uID0gc29ydEMuZGlyZWN0aW9uO1xuICAgICAgaWYgKGkgPT09IDApIHtcbiAgICAgICAgZGF0YSA9IGRhdGEuc29ydChzb3J0RnVuY3Rpb25CaW5kKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGdyb3VwZWREYXRhOiBPTWF0U29ydEdyb3VwZWREYXRhW10gPSB0aGlzLmdldERhdGFHcm91cGVkKGRhdGEsIHNvcnRDb2x1bW5zLCBpKTtcbiAgICAgICAgaWYgKGdyb3VwZWREYXRhLmxlbmd0aCA+PSBkYXRhLmxlbmd0aCkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRhdGEgPSB0aGlzLnNvcnRHcm91cGVkRGF0YShncm91cGVkRGF0YSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldERhdGFHcm91cGVkKGRhdGE6IGFueSwgc29ydENvbHVtbnM6IGFueVtdLCBpbmRleDogbnVtYmVyKTogT01hdFNvcnRHcm91cGVkRGF0YVtdIHtcbiAgICBjb25zdCBwcm9wQXJyID0gW107XG4gICAgc29ydENvbHVtbnMuZm9yRWFjaCgoaXRlbSwgaSkgPT4ge1xuICAgICAgaWYgKGkgPCBpbmRleCkge1xuICAgICAgICBwcm9wQXJyLnB1c2goaXRlbS5pZCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHByb3BBcnIubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0OiBPTWF0U29ydEdyb3VwZWREYXRhW10gPSBbXTtcbiAgICBkYXRhLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBsZXQgdmFsdWUgPSAnJztcbiAgICAgIHByb3BBcnIuZm9yRWFjaChwcm9wID0+IHtcbiAgICAgICAgdmFsdWUgKz0gaXRlbVtwcm9wXTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBmaWx0ZXJlZCA9IHJlc3VsdC5maWx0ZXIocmVzSXRlbSA9PiByZXNJdGVtLmtleSA9PT0gdmFsdWUpO1xuICAgICAgaWYgKGZpbHRlcmVkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAga2V5OiB2YWx1ZSxcbiAgICAgICAgICB2YWx1ZXM6IFtpdGVtXVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGZpbHRlcmVkWzBdLnZhbHVlcy5wdXNoKGl0ZW0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgc29ydEdyb3VwZWREYXRhKGdyb3VwZWREYXRhOiBPTWF0U29ydEdyb3VwZWREYXRhW10pOiBhbnlbXSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgcmV0dXJuIGdyb3VwZWREYXRhLnJlZHVjZSgob2JqOiBhbnksIGl0ZW06IGFueSkgPT4ge1xuICAgICAgY29uc3QgYXJyID0gaXRlbS52YWx1ZXM7XG4gICAgICBjb25zdCBzb3J0ZWQgPSBhcnIubGVuZ3RoIDw9IDEgPyBhcnIgOiBhcnIuc29ydChzZWxmLnNvcnRGdW5jdGlvbi5iaW5kKHNlbGYpKTtcbiAgICAgIG9iai5wdXNoKC4uLnNvcnRlZCk7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0sIFtdKTtcbiAgfVxuXG4gIHNvcnRGdW5jdGlvbihhOiBhbnksIGI6IGFueSk6IG51bWJlciB7XG4gICAgbGV0IHByb3BlcnR5QTogbnVtYmVyIHwgc3RyaW5nID0gJyc7XG4gICAgbGV0IHByb3BlcnR5QjogbnVtYmVyIHwgc3RyaW5nID0gJyc7XG4gICAgW3Byb3BlcnR5QSwgcHJvcGVydHlCXSA9IFthW3RoaXMuYWN0aXZlU29ydENvbHVtbl0sIGJbdGhpcy5hY3RpdmVTb3J0Q29sdW1uXV07XG5cbiAgICBjb25zdCB2YWx1ZUEgPSB0eXBlb2YgcHJvcGVydHlBID09PSAndW5kZWZpbmVkJyA/ICcnIDogcHJvcGVydHlBID09PSAnJyA/IHByb3BlcnR5QSA6IGlzTmFOKCtwcm9wZXJ0eUEpID8gcHJvcGVydHlBLnRvU3RyaW5nKCkudHJpbSgpLnRvTG93ZXJDYXNlKCkgOiArcHJvcGVydHlBO1xuICAgIGNvbnN0IHZhbHVlQiA9IHR5cGVvZiBwcm9wZXJ0eUIgPT09ICd1bmRlZmluZWQnID8gJycgOiBwcm9wZXJ0eUIgPT09ICcnID8gcHJvcGVydHlCIDogaXNOYU4oK3Byb3BlcnR5QikgPyBwcm9wZXJ0eUIudG9TdHJpbmcoKS50cmltKCkudG9Mb3dlckNhc2UoKSA6ICtwcm9wZXJ0eUI7XG4gICAgcmV0dXJuICh2YWx1ZUEgPD0gdmFsdWVCID8gLTEgOiAxKSAqICh0aGlzLmFjdGl2ZVNvcnREaXJlY3Rpb24gPT09ICdhc2MnID8gMSA6IC0xKTtcbiAgfVxuXG59XG4iXX0=