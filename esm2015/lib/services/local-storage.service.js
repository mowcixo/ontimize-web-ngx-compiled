import { EventEmitter, Injectable, Injector } from '@angular/core';
import { NavigationStart, Router } from '@angular/router';
import { AppConfig } from '../config/app-config';
import { ObservableWrapper } from '../util/async';
import { Util } from '../util/util';
import { LoginStorageService } from './login-storage.service';
import * as i0 from "@angular/core";
export class LocalStorageService {
    constructor(injector) {
        this.injector = injector;
        this.onRouteChange = new EventEmitter();
        this.onSetLocalStorage = new EventEmitter();
        this._config = this.injector.get(AppConfig).getConfiguration();
        this._router = this.injector.get(Router);
        this.loginStorageService = this.injector.get(LoginStorageService);
        const self = this;
        this._router.events.subscribe(event => {
            if (event instanceof NavigationStart) {
                ObservableWrapper.callEmit(self.onRouteChange, {});
            }
        });
    }
    getComponentStorage(comp, routeKey) {
        const componentKey = comp.getComponentKey();
        let completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        return this.getAppComponentData(completeKey) || {};
    }
    updateComponentStorage(comp, routeKey) {
        const dataToStore = comp.getDataToStore();
        const componentKey = comp.getComponentKey();
        if (!Util.isDefined(componentKey)) {
            return;
        }
        let completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        const storedObject = {};
        for (const prop in dataToStore) {
            if (dataToStore.hasOwnProperty(prop)) {
                storedObject[prop] = dataToStore[prop];
            }
        }
        this.updateAppComponentStorage(completeKey, storedObject);
    }
    getAppComponentData(key) {
        let componentData;
        const storedComponents = this.getSessionUserComponentsData() || {};
        if (storedComponents[key]) {
            const decoded = atob(storedComponents[key]);
            try {
                componentData = JSON.parse(decoded);
            }
            catch (e) {
                componentData = undefined;
            }
        }
        return componentData;
    }
    updateAppComponentStorage(componentKey, componentData) {
        let componentDataB64;
        try {
            componentDataB64 = btoa(JSON.stringify(componentData));
        }
        catch (e) {
            componentDataB64 = undefined;
        }
        this.storeComponentInSessionUser(componentKey, componentDataB64);
    }
    getSessionUserComponentsData() {
        let storedComponentsByUser = {};
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        const users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        storedComponentsByUser = (users[session.user] || {})[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        return storedComponentsByUser;
    }
    storeSessionUserComponentsData(componentsData) {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY])) {
            appData[LocalStorageService.USERS_STORAGE_KEY] = {};
        }
        const userData = appData[LocalStorageService.USERS_STORAGE_KEY][session.user] || {};
        userData[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsData;
        appData[LocalStorageService.USERS_STORAGE_KEY][session.user] = userData;
        this.setLocalStorage(appData);
    }
    storeComponentInSessionUser(componentKey, componentDataB64) {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        const users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        const idUser = session.user || this.loginStorageService.getSessionInfo().user;
        const user = users[idUser] || {};
        let componentData = {};
        if (users[idUser]) {
            componentData = users[idUser][LocalStorageService.COMPONENTS_STORAGE_KEY];
        }
        componentData[componentKey] = componentDataB64 || {};
        user[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentData;
        users[idUser] = user;
        appData[LocalStorageService.USERS_STORAGE_KEY] = users;
        this.setLocalStorage(appData);
    }
    getStoredData() {
        let appData = {};
        const appStoredData = localStorage.getItem(this._config.uuid);
        if (appStoredData) {
            try {
                appData = JSON.parse(appStoredData);
            }
            catch (e) {
                appData = {};
            }
        }
        return appData;
    }
    setBackwardCompatibility() {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY];
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        const componentsInfo = appData[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        let usersObject = {};
        const existsUsersTag = Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY]);
        let createUserInfo = existsUsersTag;
        if (existsUsersTag) {
            usersObject = appData[LocalStorageService.USERS_STORAGE_KEY];
            createUserInfo = !Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY][session.user]);
        }
        if (createUserInfo) {
            usersObject[session.user] = {};
            usersObject[session.user][LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsInfo;
            appData[LocalStorageService.USERS_STORAGE_KEY] = usersObject;
            localStorage.setItem(this._config.uuid, JSON.stringify(appData));
        }
    }
    setLocalStorage(appData) {
        this.onSetLocalStorage.emit();
        localStorage.setItem(this._config.uuid, JSON.stringify(appData));
    }
}
LocalStorageService.COMPONENTS_STORAGE_KEY = 'components';
LocalStorageService.USERS_STORAGE_KEY = 'users';
LocalStorageService.SESSION_STORAGE_KEY = 'session';
LocalStorageService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
LocalStorageService.ctorParameters = () => [
    { type: Injector }
];
LocalStorageService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function LocalStorageService_Factory() { return new LocalStorageService(i0.ɵɵinject(i0.INJECTOR)); }, token: LocalStorageService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwtc3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9sb2NhbC1zdG9yYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFMUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBSWpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOztBQUs5RCxNQUFNLE9BQU8sbUJBQW1CO0lBWTlCLFlBQXNCLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFQakMsa0JBQWEsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN0RCxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU8vRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDL0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUVsRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFD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LFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO0lBQ0gsQ0FBQztJQUVTLGVBQWUsQ0FBQyxPQUFZO1FBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM5QixZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDOztBQS9KTSwwQ0FBc0IsR0FBVyxZQUFZLENBQUM7QUFDOUMscUNBQWlCLEdBQVcsT0FBTyxDQUFDO0FBQ3BDLHVDQUFtQixHQUFXLFNBQVMsQ0FBQzs7WUFOaEQsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFia0MsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5hdmlnYXRpb25TdGFydCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgQXBwQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2FwcC1jb25maWcnO1xuaW1wb3J0IHsgSUxvY2FsU3RvcmFnZUNvbXBvbmVudCB9IGZyb20gJy4uL2ludGVyZmFjZXMvbG9jYWwtc3RvcmFnZS1jb21wb25lbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4uL3R5cGVzL2NvbmZpZy50eXBlJztcbmltcG9ydCB7IFNlc3Npb25JbmZvIH0gZnJvbSAnLi4vdHlwZXMvc2Vzc2lvbi1pbmZvLnR5cGUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZVdyYXBwZXIgfSBmcm9tICcuLi91dGlsL2FzeW5jJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgTG9naW5TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbG9naW4tc3RvcmFnZS5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTG9jYWxTdG9yYWdlU2VydmljZSB7XG4gIHN0YXRpYyBDT01QT05FTlRTX1NUT1JBR0VfS0VZOiBzdHJpbmcgPSAnY29tcG9uZW50cyc7XG4gIHN0YXRpYyBVU0VSU19TVE9SQUdFX0tFWTogc3RyaW5nID0gJ3VzZXJzJztcbiAgc3RhdGljIFNFU1NJT05fU1RPUkFHRV9LRVk6IHN0cmluZyA9ICdzZXNzaW9uJztcblxuICBwdWJsaWMgb25Sb3V0ZUNoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHB1YmxpYyBvblNldExvY2FsU3RvcmFnZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcHJpdmF0ZSBfY29uZmlnOiBDb25maWc7XG4gIHByaXZhdGUgX3JvdXRlcjogUm91dGVyO1xuICBwcml2YXRlIGxvZ2luU3RvcmFnZVNlcnZpY2U6IExvZ2luU3RvcmFnZVNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMuX2NvbmZpZyA9IHRoaXMuaW5qZWN0b3IuZ2V0KEFwcENvbmZpZykuZ2V0Q29uZmlndXJhdGlvbigpO1xuICAgIHRoaXMuX3JvdXRlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJvdXRlcik7XG4gICAgdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTG9naW5TdG9yYWdlU2VydmljZSk7XG5cbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICB0aGlzLl9yb3V0ZXIuZXZlbnRzLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uU3RhcnQpIHtcbiAgICAgICAgT2JzZXJ2YWJsZVdyYXBwZXIuY2FsbEVtaXQoc2VsZi5vblJvdXRlQ2hhbmdlLCB7fSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRDb21wb25lbnRTdG9yYWdlKGNvbXA6IElMb2NhbFN0b3JhZ2VDb21wb25lbnQsIHJvdXRlS2V5Pzogc3RyaW5nKTogb2JqZWN0IHtcbiAgICBjb25zdCBjb21wb25lbnRLZXkgPSBjb21wLmdldENvbXBvbmVudEtleSgpO1xuICAgIGxldCBjb21wbGV0ZUtleSA9IGNvbXBvbmVudEtleTtcbiAgICBpZiAocm91dGVLZXkpIHtcbiAgICAgIGNvbXBsZXRlS2V5ICs9ICdfJyArIHJvdXRlS2V5O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBcHBDb21wb25lbnREYXRhKGNvbXBsZXRlS2V5KSB8fCB7fTtcbiAgfVxuXG4gIHVwZGF0ZUNvbXBvbmVudFN0b3JhZ2UoY29tcDogSUxvY2FsU3RvcmFnZUNvbXBvbmVudCwgcm91dGVLZXk/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBkYXRhVG9TdG9yZSA9IGNvbXAuZ2V0RGF0YVRvU3RvcmUoKTtcbiAgICBjb25zdCBjb21wb25lbnRLZXkgPSBjb21wLmdldENvbXBvbmVudEtleSgpO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQoY29tcG9uZW50S2V5KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgY29tcGxldGVLZXkgPSBjb21wb25lbnRLZXk7XG4gICAgaWYgKHJvdXRlS2V5KSB7XG4gICAgICBjb21wbGV0ZUtleSArPSAnXycgKyByb3V0ZUtleTtcbiAgICB9XG4gICAgY29uc3Qgc3RvcmVkT2JqZWN0ID0ge307XG4gICAgZm9yIChjb25zdCBwcm9wIGluIGRhdGFUb1N0b3JlKSB7XG4gICAgICBpZiAoZGF0YVRvU3RvcmUuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgc3RvcmVkT2JqZWN0W3Byb3BdID0gZGF0YVRvU3RvcmVbcHJvcF07XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMudXBkYXRlQXBwQ29tcG9uZW50U3RvcmFnZShjb21wbGV0ZUtleSwgc3RvcmVkT2JqZWN0KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QXBwQ29tcG9uZW50RGF0YShrZXk6IHN0cmluZyk6IG9iamVjdCB7XG4gICAgbGV0IGNvbXBvbmVudERhdGE7XG4gICAgY29uc3Qgc3RvcmVkQ29tcG9uZW50czogb2JqZWN0ID0gdGhpcy5nZXRTZXNzaW9uVXNlckNvbXBvbmVudHNEYXRhKCkgfHwge307XG4gICAgaWYgKHN0b3JlZENvbXBvbmVudHNba2V5XSkge1xuICAgICAgY29uc3QgZGVjb2RlZCA9IGF0b2Ioc3RvcmVkQ29tcG9uZW50c1trZXldKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbXBvbmVudERhdGEgPSBKU09OLnBhcnNlKGRlY29kZWQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb21wb25lbnREYXRhID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY29tcG9uZW50RGF0YTtcbiAgfVxuXG4gIHVwZGF0ZUFwcENvbXBvbmVudFN0b3JhZ2UoY29tcG9uZW50S2V5OiBzdHJpbmcsIGNvbXBvbmVudERhdGE6IG9iamVjdCkge1xuICAgIGxldCBjb21wb25lbnREYXRhQjY0O1xuICAgIHRyeSB7XG4gICAgICBjb21wb25lbnREYXRhQjY0ID0gYnRvYShKU09OLnN0cmluZ2lmeShjb21wb25lbnREYXRhKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29tcG9uZW50RGF0YUI2NCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdGhpcy5zdG9yZUNvbXBvbmVudEluU2Vzc2lvblVzZXIoY29tcG9uZW50S2V5LCBjb21wb25lbnREYXRhQjY0KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTZXNzaW9uVXNlckNvbXBvbmVudHNEYXRhKCk6IG9iamVjdCB7XG4gICAgbGV0IHN0b3JlZENvbXBvbmVudHNCeVVzZXIgPSB7fTtcbiAgICBjb25zdCBhcHBEYXRhID0gdGhpcy5nZXRTdG9yZWREYXRhKCk7XG4gICAgY29uc3Qgc2Vzc2lvbjogU2Vzc2lvbkluZm8gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuU0VTU0lPTl9TVE9SQUdFX0tFWV0gfHwge307XG4gICAgY29uc3QgdXNlcnMgPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldIHx8IHt9O1xuICAgIHN0b3JlZENvbXBvbmVudHNCeVVzZXIgPSAodXNlcnNbc2Vzc2lvbi51c2VyXSB8fCB7fSlbTG9jYWxTdG9yYWdlU2VydmljZS5DT01QT05FTlRTX1NUT1JBR0VfS0VZXSB8fCB7fTtcbiAgICByZXR1cm4gc3RvcmVkQ29tcG9uZW50c0J5VXNlcjtcbiAgfVxuXG4gIHB1YmxpYyBzdG9yZVNlc3Npb25Vc2VyQ29tcG9uZW50c0RhdGEoY29tcG9uZW50c0RhdGE6IG9iamVjdCkge1xuICAgIGNvbnN0IGFwcERhdGEgPSB0aGlzLmdldFN0b3JlZERhdGEoKTtcbiAgICBjb25zdCBzZXNzaW9uOiBTZXNzaW9uSW5mbyA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5TRVNTSU9OX1NUT1JBR0VfS0VZXSB8fCB7fTtcbiAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0pKSB7XG4gICAgICBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldID0ge307XG4gICAgfVxuICAgIGNvbnN0IHVzZXJEYXRhID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXVtzZXNzaW9uLnVzZXJdIHx8IHt9O1xuICAgIHVzZXJEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gPSBjb21wb25lbnRzRGF0YTtcbiAgICBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldW3Nlc3Npb24udXNlcl0gPSB1c2VyRGF0YTtcbiAgICB0aGlzLnNldExvY2FsU3RvcmFnZShhcHBEYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RvcmVDb21wb25lbnRJblNlc3Npb25Vc2VyKGNvbXBvbmVudEtleSwgY29tcG9uZW50RGF0YUI2NCkge1xuICAgIGNvbnN0IGFwcERhdGEgPSB0aGlzLmdldFN0b3JlZERhdGEoKTtcbiAgICBjb25zdCBzZXNzaW9uID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlNFU1NJT05fU1RPUkFHRV9LRVldIHx8IHt9OyAvLyB1dWlkIC0+IHNlc3Npb25cbiAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKHNlc3Npb24pIHx8ICFVdGlsLmlzRGVmaW5lZChzZXNzaW9uLnVzZXIpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHVzZXJzID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSB8fCB7fTsgLy8gdXVpZCAtPiB1c2Vyc1xuICAgIGNvbnN0IGlkVXNlciA9IHNlc3Npb24udXNlciB8fCB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKS51c2VyO1xuICAgIGNvbnN0IHVzZXIgPSB1c2Vyc1tpZFVzZXJdIHx8IHt9OyAvLyB1dWlkIC0+IHVzZXJzLT4gdXNlclxuXG4gICAgbGV0IGNvbXBvbmVudERhdGEgPSB7fTtcbiAgICBpZiAodXNlcnNbaWRVc2VyXSkge1xuICAgICAgY29tcG9uZW50RGF0YSA9IHVzZXJzW2lkVXNlcl1bTG9jYWxTdG9yYWdlU2VydmljZS5DT01QT05FTlRTX1NUT1JBR0VfS0VZXTtcbiAgICB9XG4gICAgY29tcG9uZW50RGF0YVtjb21wb25lbnRLZXldID0gY29tcG9uZW50RGF0YUI2NCB8fCB7fTtcblxuICAgIHVzZXJbTG9jYWxTdG9yYWdlU2VydmljZS5DT01QT05FTlRTX1NUT1JBR0VfS0VZXSA9IGNvbXBvbmVudERhdGE7XG4gICAgdXNlcnNbaWRVc2VyXSA9IHVzZXI7XG4gICAgYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSA9IHVzZXJzO1xuXG4gICAgdGhpcy5zZXRMb2NhbFN0b3JhZ2UoYXBwRGF0YSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U3RvcmVkRGF0YSgpOiBvYmplY3Qge1xuICAgIGxldCBhcHBEYXRhID0ge307XG4gICAgY29uc3QgYXBwU3RvcmVkRGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuX2NvbmZpZy51dWlkKTtcbiAgICBpZiAoYXBwU3RvcmVkRGF0YSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXBwRGF0YSA9IEpTT04ucGFyc2UoYXBwU3RvcmVkRGF0YSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGFwcERhdGEgPSB7fTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFwcERhdGE7XG4gIH1cblxuICBwdWJsaWMgc2V0QmFja3dhcmRDb21wYXRpYmlsaXR5KCkge1xuICAgIGNvbnN0IGFwcERhdGEgPSB0aGlzLmdldFN0b3JlZERhdGEoKTtcbiAgICBjb25zdCBzZXNzaW9uID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlNFU1NJT05fU1RPUkFHRV9LRVldO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQoc2Vzc2lvbikgfHwgIVV0aWwuaXNEZWZpbmVkKHNlc3Npb24udXNlcikpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY29tcG9uZW50c0luZm8gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gfHwge307XG4gICAgbGV0IHVzZXJzT2JqZWN0ID0ge307XG4gICAgY29uc3QgZXhpc3RzVXNlcnNUYWcgPSBVdGlsLmlzRGVmaW5lZChhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldKTtcbiAgICBsZXQgY3JlYXRlVXNlckluZm8gPSBleGlzdHNVc2Vyc1RhZztcbiAgICBpZiAoZXhpc3RzVXNlcnNUYWcpIHtcbiAgICAgIHVzZXJzT2JqZWN0ID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXTtcbiAgICAgIGNyZWF0ZVVzZXJJbmZvID0gIVV0aWwuaXNEZWZpbmVkKGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV1bc2Vzc2lvbi51c2VyXSk7XG4gICAgfVxuICAgIGlmIChjcmVhdGVVc2VySW5mbykge1xuICAgICAgdXNlcnNPYmplY3Rbc2Vzc2lvbi51c2VyXSA9IHt9O1xuICAgICAgdXNlcnNPYmplY3Rbc2Vzc2lvbi51c2VyXVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldID0gY29tcG9uZW50c0luZm87XG5cbiAgICAgIGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0gPSB1c2Vyc09iamVjdDtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuX2NvbmZpZy51dWlkLCBKU09OLnN0cmluZ2lmeShhcHBEYXRhKSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHNldExvY2FsU3RvcmFnZShhcHBEYXRhOiBhbnkpIHtcbiAgICB0aGlzLm9uU2V0TG9jYWxTdG9yYWdlLmVtaXQoKTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLl9jb25maWcudXVpZCwgSlNPTi5zdHJpbmdpZnkoYXBwRGF0YSkpO1xuICB9XG59XG5cbiJdfQ==