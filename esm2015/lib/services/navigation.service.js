import { Location } from '@angular/common';
import { EventEmitter, Injectable, Injector } from '@angular/core';
import { NavigationEnd, Router } from '@angular/router';
import { ReplaySubject } from 'rxjs';
import { filter, map } from 'rxjs/operators';
import { ObservableWrapper } from '../util/async';
import { Codes } from '../util/codes';
import { Util } from '../util/util';
import { LocalStorageService } from './local-storage.service';
import { OBreadcrumbService } from './o-breadcrumb.service';
import * as i0 from "@angular/core";
export class ONavigationItem {
    constructor(value) {
        this.url = value.url ? value.url : '';
        this.queryParams = value[Codes.QUERY_PARAMS] ? value[Codes.QUERY_PARAMS] : {};
        this.formRoutes = value.formRoutes;
        this.formLayoutRoutes = value.formLayoutRoutes;
        this.activeFormMode = value.activeFormMode;
        this.keysValues = value.keysValues;
        this.queryConfiguration = value.queryConfiguration;
    }
    getActiveModePath() {
        let result;
        if (Util.isDefined(this.activeFormMode)) {
            result = (this.formRoutes || {})[this.activeFormMode];
        }
        return result;
    }
    isInsertFormRoute() {
        return this.activeFormMode === 'insertFormRoute';
    }
    getInsertFormRoute() {
        const routes = this.formRoutes;
        return routes ? (routes.insertFormRoute || Codes.DEFAULT_INSERT_ROUTE) : Codes.DEFAULT_INSERT_ROUTE;
    }
    getEditFormRoute() {
        const routes = this.formRoutes;
        return routes ? (routes.editFormRoute || Codes.DEFAULT_EDIT_ROUTE) : Codes.DEFAULT_EDIT_ROUTE;
    }
    getDetailFormRoute() {
        const routes = this.formRoutes;
        return routes ? (routes.detailFormRoute || Codes.DEFAULT_DETAIL_ROUTE) : Codes.DEFAULT_DETAIL_ROUTE;
    }
    isMainFormLayoutManagerComponent() {
        return Util.isDefined(this.formLayoutRoutes);
    }
    isMainNavigationComponent() {
        return Util.isDefined(this.formRoutes) && this.formRoutes.isMainNavigationComponent;
    }
    getFormRoutes() {
        return this.formRoutes;
    }
    setFormRoutes(arg) {
        if (arg && arg.mainFormLayoutManagerComponent) {
            this.formLayoutRoutes = arg;
        }
        else {
            this.formRoutes = arg;
        }
    }
    deleteActiveFormMode() {
        this.activeFormMode = undefined;
    }
}
const MAXIMIUM_NAVIGATION_HEAP_SIZE = 15;
export class NavigationService {
    constructor(injector) {
        this.injector = injector;
        this.currentTitle = null;
        this.visible = true;
        this.navigationItems = [];
        this.allNavigationItems = [];
        this.navigationEvents$ = new ReplaySubject(1);
        this._titleEmitter = new EventEmitter();
        this._visibleEmitter = new EventEmitter();
        this._sidenavEmitter = new EventEmitter();
        this.router = this.injector.get(Router);
        this.oBreadcrumbService = this.injector.get(OBreadcrumbService);
        this.localStorageService = this.injector.get(LocalStorageService);
        this.location = this.injector.get(Location);
        this.location.subscribe(val => {
            const previousRoute = this.getPreviousRouteData();
            const qParams = Object.keys(previousRoute.queryParams);
            const arr = [];
            qParams.forEach((p) => {
                arr.push(`${p}=${previousRoute.queryParams[p]}`);
            });
            let fullUrl = `/${previousRoute.url}`;
            if (arr.length > 0) {
                fullUrl = `/${previousRoute.url}?${arr.join('&')}`;
            }
            if (fullUrl === val.url) {
                this.navigationItems.pop();
            }
        });
    }
    initialize() {
        this.router.events.pipe(filter(event => event instanceof NavigationEnd), map(() => this.router.routerState.root), map(route => {
            while (route.firstChild) {
                route = route.firstChild;
            }
            return route;
        }), filter(route => route.outlet === 'primary')).subscribe(this.parseNavigationItems.bind(this));
    }
    buildBreadcrumbsForRoute(activatedRoute) {
        const breadcrumbs = [];
        let url = '';
        let route = activatedRoute.firstChild;
        while (route.firstChild) {
            if (route.url.length) {
                const pRoute = this.parseRoute(url, route);
                breadcrumbs.push(pRoute);
                url = pRoute.route;
            }
            route = route.firstChild;
        }
        const parsedRoute = this.parseRoute(url, route);
        breadcrumbs.push(parsedRoute);
        this.oBreadcrumbService.breadcrumbs$.next(breadcrumbs);
    }
    parseRoute(route, activatedRoute) {
        let label = '';
        for (let i = 0, len = activatedRoute.url.length; i < len; i++) {
            const segment = activatedRoute.url[i];
            if (label.length === 0) {
                label = label.length > 0 ? ('/' + segment.path) : segment.path;
                route += '/' + segment.path;
            }
        }
        return { route, label, queryParams: activatedRoute.queryParams };
    }
    parseNavigationItems() {
        const storedNavigation = this.getStoredData();
        const route = this.router.routerState.root.snapshot;
        const url = this.router.routerState.snapshot.url.split('?')[0];
        this.buildBreadcrumbsForRoute(route);
        const lastStored = storedNavigation[storedNavigation.length - 1];
        if (!lastStored || lastStored.url !== url) {
            const navigationItem = new ONavigationItem({ url, queryParams: route.queryParams });
            this.navigationItems.push(navigationItem);
            this.setNavigationItems(this.navigationItems);
        }
    }
    setNavigationItems(navigationItems) {
        this.navigationItems = navigationItems;
        this.storeNavigation();
        this.navigationEvents$.next(navigationItems);
    }
    getDataToStore() {
        return this.navigationItems;
    }
    getComponentKey() {
        return NavigationService.NAVIGATION_STORAGE_KEY;
    }
    storeNavigation() {
        if (this.localStorageService) {
            this.localStorageService.updateComponentStorage(this);
        }
    }
    setTitle(title) {
        this.currentTitle = title;
        this._emitTitleChanged(this.currentTitle);
    }
    setVisible(visible) {
        this.visible = visible;
        this._emitVisibleChanged(this.visible);
    }
    openSidenav() {
        this._emitOpenSidenav();
    }
    closeSidenav() {
        this._emitCloseSidenav();
    }
    onTitleChange(onNext) {
        return ObservableWrapper.subscribe(this._titleEmitter, onNext);
    }
    onVisibleChange(onNext) {
        return ObservableWrapper.subscribe(this._visibleEmitter, onNext);
    }
    onSidenavChange(onNext) {
        return ObservableWrapper.subscribe(this._sidenavEmitter, onNext);
    }
    _emitTitleChanged(title) {
        ObservableWrapper.callEmit(this._titleEmitter, title);
    }
    _emitVisibleChanged(visible) {
        ObservableWrapper.callEmit(this._visibleEmitter, visible);
    }
    _emitOpenSidenav() {
        ObservableWrapper.callEmit(this._sidenavEmitter, 'open');
    }
    _emitCloseSidenav() {
        ObservableWrapper.callEmit(this._sidenavEmitter, 'close');
    }
    storeFormRoutes(routes, activeMode, queryConf) {
        if (this.navigationItems.length > 0) {
            this.navigationItems[this.navigationItems.length - 1].setFormRoutes(routes);
            this.navigationItems[this.navigationItems.length - 1].activeFormMode = activeMode;
            if (queryConf) {
                this.navigationItems[this.navigationItems.length - 1].keysValues = queryConf.keysValues;
                delete queryConf.keysValues;
                this.navigationItems[this.navigationItems.length - 1].queryConfiguration = Object.keys(queryConf).length > 0 ? queryConf : null;
            }
            this.storeNavigation();
        }
    }
    getStoredData() {
        const storageData = this.localStorageService.getComponentStorage(this);
        const result = [];
        Object.keys(storageData).forEach(key => result.push(new ONavigationItem(storageData[key])));
        return result;
    }
    getPreviousRouteData() {
        let result;
        const len = this.navigationItems.length;
        if (len >= 2) {
            result = this.navigationItems[len - 2];
            if (result && result.formRoutes && result.formRoutes.mainFormLayoutManagerComponent && this.navigationItems[len - 3]) {
                const parent = this.navigationItems[len - 3];
                if (parent.isMainFormLayoutManagerComponent()) {
                    result = parent;
                }
            }
        }
        return result;
    }
    getLastMainNavigationRouteData() {
        const routeMatches = [];
        const items = this.navigationItems.slice().reverse()
            .map((item, i) => {
            let currentLocation = this.location.path().substr(1);
            if (currentLocation.includes('?')) {
                currentLocation = currentLocation.substring(0, currentLocation.indexOf('?'));
            }
            const arr1 = item.url.substr(1).split('/');
            const arr2 = currentLocation.split('/');
            let result = 0;
            let index = -1;
            while (++index <= arr1.length && index <= arr2.length) {
                routeMatches[i] = (arr1[index] === arr2[index]) ? result++ : result;
            }
            return item;
        });
        let maxMatches = routeMatches.reduce((a, b) => Math.max(a, b));
        const lastNavItem = this.navigationItems[this.navigationItems.length - 1];
        if (!lastNavItem.isMainNavigationComponent() && !lastNavItem.isMainFormLayoutManagerComponent()) {
            maxMatches--;
        }
        let itemResult = void 0;
        while (!itemResult && maxMatches >= 0) {
            itemResult = items.find((item, i) => (item.isMainNavigationComponent() || item.isMainFormLayoutManagerComponent()) && routeMatches[i] === maxMatches);
            maxMatches--;
        }
        return itemResult;
    }
    removeLastItem() {
        this.navigationItems.pop();
        this.storeNavigation();
    }
    removeLastItemsUntilMain() {
        const lastMain = this.getLastMainNavigationRouteData();
        if (!Util.isDefined(lastMain)) {
            return false;
        }
        const index = this.navigationItems.indexOf(lastMain);
        this.navigationItems = this.navigationItems.slice(0, index + 1);
        this.storeNavigation();
        return true;
    }
    isCurrentRoute(route) {
        let currentRoute = this.router.routerState.snapshot.url;
        currentRoute = currentRoute.split('?')[0];
        return route === currentRoute;
    }
    getLastItem() {
        let result;
        if (this.navigationItems.length > 0) {
            result = this.navigationItems[this.navigationItems.length - 1];
        }
        return result;
    }
    deleteActiveFormMode(arg) {
        arg.deleteActiveFormMode();
        this.storeNavigation();
    }
}
NavigationService.NAVIGATION_STORAGE_KEY = 'nav_service';
NavigationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NavigationService.ctorParameters = () => [
    { type: Injector }
];
NavigationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function NavigationService_Factory() { return new NavigationService(i0.ɵɵinject(i0.INJECTOR)); }, token: NavigationService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9uYXZpZ2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQTBCLGFBQWEsRUFBRSxNQUFNLEVBQWMsTUFBTSxpQkFBaUIsQ0FBQztBQUM1RixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJN0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNwQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7QUFVNUQsTUFBTSxPQUFPLGVBQWU7SUFTMUIsWUFBWSxLQUFVO1FBQ3BCLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlFLElBQUksQ0FBQyxVQUFV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QUFDO1FBQzFDLE9BQU8sS0FBSyxLQUFLLFlBQVksQ0FBQztJQUNoQyxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksTUFBTSxDQUFDO1FBQ1gsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbkMsTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDaEU7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsb0JBQW9CLENBQUMsR0FBb0I7UUFDdkMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUM7O0FBcFJhLHdDQUFzQixHQUFXLGFBQWEsQ0FBQzs7WUFMOUQsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFoR2tDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIsIFVybFNlZ21lbnQgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IElMb2NhbFN0b3JhZ2VDb21wb25lbnQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2xvY2FsLXN0b3JhZ2UtY29tcG9uZW50LmludGVyZmFjZSc7XG5pbXBvcnQgeyBPQnJlYWRjcnVtYiB9IGZyb20gJy4uL3R5cGVzL28tYnJlYWRjcnVtYi1pdGVtLnR5cGUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZVdyYXBwZXIgfSBmcm9tICcuLi91dGlsL2FzeW5jJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi4vdXRpbC9jb2Rlcyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL2xvY2FsLXN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBPQnJlYWRjcnVtYlNlcnZpY2UgfSBmcm9tICcuL28tYnJlYWRjcnVtYi5zZXJ2aWNlJztcblxuZXhwb3J0IHR5cGUgT05hdmlnYXRpb25Sb3V0ZXMgPSB7XG4gIG1haW5Gb3JtTGF5b3V0TWFuYWdlckNvbXBvbmVudD86IGJvb2xlYW47XG4gIGlzTWFpbk5hdmlnYXRpb25Db21wb25lbnQ/OiBib29sZWFuO1xuICBkZXRhaWxGb3JtUm91dGU6IHN0cmluZztcbiAgZWRpdEZvcm1Sb3V0ZTogc3RyaW5nO1xuICBpbnNlcnRGb3JtUm91dGU6IHN0cmluZztcbn07XG5cbmV4cG9ydCBjbGFzcyBPTmF2aWdhdGlvbkl0ZW0ge1xuICB1cmw6IHN0cmluZztcbiAgcXVlcnlQYXJhbXM6IG9iamVjdDtcbiAgYWN0aXZlRm9ybU1vZGU6IHN0cmluZztcbiAgZm9ybVJvdXRlczogT05hdmlnYXRpb25Sb3V0ZXM7XG4gIGZvcm1MYXlvdXRSb3V0ZXM6IE9OYXZpZ2F0aW9uUm91dGVzO1xuICBrZXlzVmFsdWVzOiBhbnk7XG4gIHF1ZXJ5Q29uZmlndXJhdGlvbjogYW55O1xuXG4gIGNvbnN0cnVjdG9yKHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzLnVybCA9IHZhbHVlLnVybCA/IHZhbHVlLnVybCA6ICcnO1xuICAgIHRoaXMucXVlcnlQYXJhbXMgPSB2YWx1ZVtDb2Rlcy5RVUVSWV9QQVJBTVNdID8gdmFsdWVbQ29kZXMuUVVFUllfUEFSQU1TXSA6IHt9O1xuICAgIHRoaXMuZm9ybVJvdXRlcyA9IHZhbHVlLmZvcm1Sb3V0ZXM7XG4gICAgdGhpcy5mb3JtTGF5b3V0Um91dGVzID0gdmFsdWUuZm9ybUxheW91dFJvdXRlcztcbiAgICB0aGlzLmFjdGl2ZUZvcm1Nb2RlID0gdmFsdWUuYWN0aXZlRm9ybU1vZGU7XG4gICAgdGhpcy5rZXlzVmFsdWVzID0gdmFsdWUua2V5c1ZhbHVlcztcbiAgICB0aGlzLnF1ZXJ5Q29uZmlndXJhdGlvbiA9IHZhbHVlLnF1ZXJ5Q29uZmlndXJhdGlvbjtcbiAgfVxuXG4gIGdldEFjdGl2ZU1vZGVQYXRoKCk6IHN0cmluZyB7XG4gICAgbGV0IHJlc3VsdDtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQodGhpcy5hY3RpdmVGb3JtTW9kZSkpIHtcbiAgICAgIHJlc3VsdCA9ICh0aGlzLmZvcm1Sb3V0ZXMgfHwge30pW3RoaXMuYWN0aXZlRm9ybU1vZGVdO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgaXNJbnNlcnRGb3JtUm91dGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlRm9ybU1vZGUgPT09ICdpbnNlcnRGb3JtUm91dGUnO1xuICB9XG5cbiAgZ2V0SW5zZXJ0Rm9ybVJvdXRlKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgcm91dGVzID0gdGhpcy5mb3JtUm91dGVzO1xuICAgIHJldHVybiByb3V0ZXMgPyAocm91dGVzLmluc2VydEZvcm1Sb3V0ZSB8fCBDb2Rlcy5ERUZBVUxUX0lOU0VSVF9ST1VURSkgOiBDb2Rlcy5ERUZBVUxUX0lOU0VSVF9ST1VURTtcbiAgfVxuXG4gIGdldEVkaXRGb3JtUm91dGUoKTogc3RyaW5nIHtcbiAgICBjb25zdCByb3V0ZXMgPSB0aGlzLmZvcm1Sb3V0ZXM7XG4gICAgcmV0dXJuIHJvdXRlcyA/IChyb3V0ZXMuZWRpdEZvcm1Sb3V0ZSB8fCBDb2Rlcy5ERUZBVUxUX0VESVRfUk9VVEUpIDogQ29kZXMuREVGQVVMVF9FRElUX1JPVVRFO1xuICB9XG5cbiAgZ2V0RGV0YWlsRm9ybVJvdXRlKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgcm91dGVzID0gdGhpcy5mb3JtUm91dGVzO1xuICAgIHJldHVybiByb3V0ZXMgPyAocm91dGVzLmRldGFpbEZvcm1Sb3V0ZSB8fCBDb2Rlcy5ERUZBVUxUX0RFVEFJTF9ST1VURSkgOiBDb2Rlcy5ERUZBVUxUX0RFVEFJTF9ST1VURTtcbiAgfVxuXG4gIGlzTWFpbkZvcm1MYXlvdXRNYW5hZ2VyQ29tcG9uZW50KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBVdGlsLmlzRGVmaW5lZCh0aGlzLmZvcm1MYXlvdXRSb3V0ZXMpO1xuICB9XG5cbiAgaXNNYWluTmF2aWdhdGlvbkNvbXBvbmVudCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gVXRpbC5pc0RlZmluZWQodGhpcy5mb3JtUm91dGVzKSAmJiB0aGlzLmZvcm1Sb3V0ZXMuaXNNYWluTmF2aWdhdGlvbkNvbXBvbmVudDtcbiAgfVxuXG4gIGdldEZvcm1Sb3V0ZXMoKTogT05hdmlnYXRpb25Sb3V0ZXMge1xuICAgIHJldHVybiB0aGlzLmZvcm1Sb3V0ZXM7XG4gIH1cblxuICBzZXRGb3JtUm91dGVzKGFyZzogT05hdmlnYXRpb25Sb3V0ZXMpIHtcbiAgICBpZiAoYXJnICYmIGFyZy5tYWluRm9ybUxheW91dE1hbmFnZXJDb21wb25lbnQpIHtcbiAgICAgIHRoaXMuZm9ybUxheW91dFJvdXRlcyA9IGFyZztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5mb3JtUm91dGVzID0gYXJnO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZUFjdGl2ZUZvcm1Nb2RlKCkge1xuICAgIHRoaXMuYWN0aXZlRm9ybU1vZGUgPSB1bmRlZmluZWQ7XG4gIH1cbn1cblxuY29uc3QgTUFYSU1JVU1fTkFWSUdBVElPTl9IRUFQX1NJWkUgPSAxNTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvblNlcnZpY2UgaW1wbGVtZW50cyBJTG9jYWxTdG9yYWdlQ29tcG9uZW50IHtcblxuICBwdWJsaWMgc3RhdGljIE5BVklHQVRJT05fU1RPUkFHRV9LRVk6IHN0cmluZyA9ICduYXZfc2VydmljZSc7XG5cbiAgcHVibGljIGN1cnJlbnRUaXRsZTogc3RyaW5nID0gbnVsbDtcbiAgcHVibGljIHZpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIHByb3RlY3RlZCBuYXZpZ2F0aW9uSXRlbXM6IEFycmF5PE9OYXZpZ2F0aW9uSXRlbT4gPSBbXTtcbiAgcHJvdGVjdGVkIGFsbE5hdmlnYXRpb25JdGVtczogT05hdmlnYXRpb25JdGVtW10gPSBbXTtcblxuICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXI7XG5cbiAgcHJvdGVjdGVkIG9CcmVhZGNydW1iU2VydmljZTogT0JyZWFkY3J1bWJTZXJ2aWNlO1xuICBwcm90ZWN0ZWQgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZTtcbiAgcHJvdGVjdGVkIGxvY2F0aW9uOiBMb2NhdGlvbjtcblxuICBwdWJsaWMgbmF2aWdhdGlvbkV2ZW50cyQ6IFJlcGxheVN1YmplY3Q8QXJyYXk8T05hdmlnYXRpb25JdGVtPj4gPSBuZXcgUmVwbGF5U3ViamVjdDxBcnJheTxPTmF2aWdhdGlvbkl0ZW0+PigxKTtcblxuICBwcml2YXRlIF90aXRsZUVtaXR0ZXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwcml2YXRlIF92aXNpYmxlRW1pdHRlcjogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuICBwcml2YXRlIF9zaWRlbmF2RW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3RvclxuICApIHtcbiAgICB0aGlzLnJvdXRlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJvdXRlcik7XG4gICAgdGhpcy5vQnJlYWRjcnVtYlNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChPQnJlYWRjcnVtYlNlcnZpY2UpO1xuICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsU3RvcmFnZVNlcnZpY2UpO1xuICAgIHRoaXMubG9jYXRpb24gPSB0aGlzLmluamVjdG9yLmdldChMb2NhdGlvbik7XG4gICAgdGhpcy5sb2NhdGlvbi5zdWJzY3JpYmUodmFsID0+IHtcbiAgICAgIGNvbnN0IHByZXZpb3VzUm91dGUgPSB0aGlzLmdldFByZXZpb3VzUm91dGVEYXRhKCk7XG4gICAgICBjb25zdCBxUGFyYW1zID0gT2JqZWN0LmtleXMocHJldmlvdXNSb3V0ZS5xdWVyeVBhcmFtcyk7XG4gICAgICBjb25zdCBhcnIgPSBbXTtcbiAgICAgIHFQYXJhbXMuZm9yRWFjaCgocCkgPT4ge1xuICAgICAgICBhcnIucHVzaChgJHtwfT0ke3ByZXZpb3VzUm91dGUucXVlcnlQYXJhbXNbcF19YCk7XG4gICAgICB9KTtcbiAgICAgIGxldCBmdWxsVXJsID0gYC8ke3ByZXZpb3VzUm91dGUudXJsfWA7XG4gICAgICBpZiAoYXJyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZnVsbFVybCA9IGAvJHtwcmV2aW91c1JvdXRlLnVybH0/JHthcnIuam9pbignJicpfWA7XG4gICAgICB9XG4gICAgICBpZiAoZnVsbFVybCA9PT0gdmFsLnVybCkge1xuICAgICAgICB0aGlzLm5hdmlnYXRpb25JdGVtcy5wb3AoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgdGhpcy5yb3V0ZXIuZXZlbnRzLnBpcGUoXG4gICAgICBmaWx0ZXIoZXZlbnQgPT4gZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSxcbiAgICAgIG1hcCgoKSA9PiB0aGlzLnJvdXRlci5yb3V0ZXJTdGF0ZS5yb290KSxcbiAgICAgIG1hcChyb3V0ZSA9PiB7XG4gICAgICAgIHdoaWxlIChyb3V0ZS5maXJzdENoaWxkKSB7XG4gICAgICAgICAgcm91dGUgPSByb3V0ZS5maXJzdENoaWxkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByb3V0ZTtcbiAgICAgIH0pLFxuICAgICAgZmlsdGVyKHJvdXRlID0+IHJvdXRlLm91dGxldCA9PT0gJ3ByaW1hcnknKVxuICAgICkuc3Vic2NyaWJlKHRoaXMucGFyc2VOYXZpZ2F0aW9uSXRlbXMuYmluZCh0aGlzKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYnVpbGRCcmVhZGNydW1ic0ZvclJvdXRlKGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KSB7XG4gICAgY29uc3QgYnJlYWRjcnVtYnM6IE9CcmVhZGNydW1iW10gPSBbXTtcbiAgICBsZXQgdXJsID0gJyc7XG4gICAgbGV0IHJvdXRlID0gYWN0aXZhdGVkUm91dGUuZmlyc3RDaGlsZDtcbiAgICB3aGlsZSAocm91dGUuZmlyc3RDaGlsZCkge1xuICAgICAgaWYgKHJvdXRlLnVybC5sZW5ndGgpIHtcbiAgICAgICAgY29uc3QgcFJvdXRlID0gdGhpcy5wYXJzZVJvdXRlKHVybCwgcm91dGUpO1xuICAgICAgICBicmVhZGNydW1icy5wdXNoKHBSb3V0ZSk7XG4gICAgICAgIHVybCA9IHBSb3V0ZS5yb3V0ZTtcbiAgICAgIH1cbiAgICAgIHJvdXRlID0gcm91dGUuZmlyc3RDaGlsZDtcbiAgICB9XG4gICAgY29uc3QgcGFyc2VkUm91dGUgPSB0aGlzLnBhcnNlUm91dGUodXJsLCByb3V0ZSk7XG4gICAgYnJlYWRjcnVtYnMucHVzaChwYXJzZWRSb3V0ZSk7XG5cbiAgICB0aGlzLm9CcmVhZGNydW1iU2VydmljZS5icmVhZGNydW1icyQubmV4dChicmVhZGNydW1icyk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VSb3V0ZShyb3V0ZTogc3RyaW5nLCBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE9CcmVhZGNydW1iIHtcbiAgICBsZXQgbGFiZWwgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gYWN0aXZhdGVkUm91dGUudXJsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjb25zdCBzZWdtZW50OiBVcmxTZWdtZW50ID0gYWN0aXZhdGVkUm91dGUudXJsW2ldO1xuICAgICAgaWYgKGxhYmVsLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBsYWJlbCA9IGxhYmVsLmxlbmd0aCA+IDAgPyAoJy8nICsgc2VnbWVudC5wYXRoKSA6IHNlZ21lbnQucGF0aDtcbiAgICAgICAgcm91dGUgKz0gJy8nICsgc2VnbWVudC5wYXRoO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4geyByb3V0ZSwgbGFiZWwsIHF1ZXJ5UGFyYW1zOiBhY3RpdmF0ZWRSb3V0ZS5xdWVyeVBhcmFtcyB9O1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlTmF2aWdhdGlvbkl0ZW1zKCkge1xuICAgIGNvbnN0IHN0b3JlZE5hdmlnYXRpb246IE9OYXZpZ2F0aW9uSXRlbVtdID0gdGhpcy5nZXRTdG9yZWREYXRhKCk7XG4gICAgY29uc3Qgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgPSB0aGlzLnJvdXRlci5yb3V0ZXJTdGF0ZS5yb290LnNuYXBzaG90O1xuICAgIGNvbnN0IHVybCA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnNuYXBzaG90LnVybC5zcGxpdCgnPycpWzBdO1xuICAgIHRoaXMuYnVpbGRCcmVhZGNydW1ic0ZvclJvdXRlKHJvdXRlKTtcbiAgICBjb25zdCBsYXN0U3RvcmVkOiBhbnkgPSBzdG9yZWROYXZpZ2F0aW9uW3N0b3JlZE5hdmlnYXRpb24ubGVuZ3RoIC0gMV07XG4gICAgaWYgKCFsYXN0U3RvcmVkIHx8IGxhc3RTdG9yZWQudXJsICE9PSB1cmwpIHtcbiAgICAgIGNvbnN0IG5hdmlnYXRpb25JdGVtID0gbmV3IE9OYXZpZ2F0aW9uSXRlbSh7IHVybCwgcXVlcnlQYXJhbXM6IHJvdXRlLnF1ZXJ5UGFyYW1zIH0pO1xuXG4gICAgICB0aGlzLm5hdmlnYXRpb25JdGVtcy5wdXNoKG5hdmlnYXRpb25JdGVtKTtcbiAgICAgIHRoaXMuc2V0TmF2aWdhdGlvbkl0ZW1zKHRoaXMubmF2aWdhdGlvbkl0ZW1zKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2V0TmF2aWdhdGlvbkl0ZW1zKG5hdmlnYXRpb25JdGVtczogT05hdmlnYXRpb25JdGVtW10pIHtcbiAgICB0aGlzLm5hdmlnYXRpb25JdGVtcyA9IG5hdmlnYXRpb25JdGVtcztcbiAgICB0aGlzLnN0b3JlTmF2aWdhdGlvbigpO1xuICAgIHRoaXMubmF2aWdhdGlvbkV2ZW50cyQubmV4dChuYXZpZ2F0aW9uSXRlbXMpO1xuICB9XG5cbiAgcHVibGljIGdldERhdGFUb1N0b3JlKCk6IG9iamVjdCB7XG4gICAgcmV0dXJuIHRoaXMubmF2aWdhdGlvbkl0ZW1zO1xuICB9XG5cbiAgcHVibGljIGdldENvbXBvbmVudEtleSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBOYXZpZ2F0aW9uU2VydmljZS5OQVZJR0FUSU9OX1NUT1JBR0VfS0VZO1xuICB9XG5cbiAgcHJvdGVjdGVkIHN0b3JlTmF2aWdhdGlvbigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UudXBkYXRlQ29tcG9uZW50U3RvcmFnZSh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2V0VGl0bGUodGl0bGU6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuY3VycmVudFRpdGxlID0gdGl0bGU7XG4gICAgdGhpcy5fZW1pdFRpdGxlQ2hhbmdlZCh0aGlzLmN1cnJlbnRUaXRsZSk7XG4gIH1cblxuICBwdWJsaWMgc2V0VmlzaWJsZSh2aXNpYmxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy52aXNpYmxlID0gdmlzaWJsZTtcbiAgICB0aGlzLl9lbWl0VmlzaWJsZUNoYW5nZWQodGhpcy52aXNpYmxlKTtcbiAgfVxuXG4gIHB1YmxpYyBvcGVuU2lkZW5hdigpIHtcbiAgICB0aGlzLl9lbWl0T3BlblNpZGVuYXYoKTtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZVNpZGVuYXYoKSB7XG4gICAgdGhpcy5fZW1pdENsb3NlU2lkZW5hdigpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSB0byB0aXRsZSB1cGRhdGVzXG4gICAqL1xuICBwdWJsaWMgb25UaXRsZUNoYW5nZShvbk5leHQ6ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogb2JqZWN0IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZVdyYXBwZXIuc3Vic2NyaWJlKHRoaXMuX3RpdGxlRW1pdHRlciwgb25OZXh0KTtcbiAgfVxuXG4gIHB1YmxpYyBvblZpc2libGVDaGFuZ2Uob25OZXh0OiAodmFsdWU6IGJvb2xlYW4pID0+IHZvaWQpOiBvYmplY3Qge1xuICAgIHJldHVybiBPYnNlcnZhYmxlV3JhcHBlci5zdWJzY3JpYmUodGhpcy5fdmlzaWJsZUVtaXR0ZXIsIG9uTmV4dCk7XG4gIH1cblxuICBwdWJsaWMgb25TaWRlbmF2Q2hhbmdlKG9uTmV4dDogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBvYmplY3Qge1xuICAgIHJldHVybiBPYnNlcnZhYmxlV3JhcHBlci5zdWJzY3JpYmUodGhpcy5fc2lkZW5hdkVtaXR0ZXIsIG9uTmV4dCk7XG4gIH1cblxuICBwcml2YXRlIF9lbWl0VGl0bGVDaGFuZ2VkKHRpdGxlKTogdm9pZCB7XG4gICAgT2JzZXJ2YWJsZVdyYXBwZXIuY2FsbEVtaXQodGhpcy5fdGl0bGVFbWl0dGVyLCB0aXRsZSk7XG4gIH1cblxuICBwcml2YXRlIF9lbWl0VmlzaWJsZUNoYW5nZWQodmlzaWJsZSk6IHZvaWQge1xuICAgIE9ic2VydmFibGVXcmFwcGVyLmNhbGxFbWl0KHRoaXMuX3Zpc2libGVFbWl0dGVyLCB2aXNpYmxlKTtcbiAgfVxuXG4gIHByaXZhdGUgX2VtaXRPcGVuU2lkZW5hdigpIHtcbiAgICBPYnNlcnZhYmxlV3JhcHBlci5jYWxsRW1pdCh0aGlzLl9zaWRlbmF2RW1pdHRlciwgJ29wZW4nKTtcbiAgfVxuXG4gIHByaXZhdGUgX2VtaXRDbG9zZVNpZGVuYXYoKSB7XG4gICAgT2JzZXJ2YWJsZVdyYXBwZXIuY2FsbEVtaXQodGhpcy5fc2lkZW5hdkVtaXR0ZXIsICdjbG9zZScpO1xuICB9XG5cbiAgc3RvcmVGb3JtUm91dGVzKHJvdXRlczogT05hdmlnYXRpb25Sb3V0ZXMsIGFjdGl2ZU1vZGU6IHN0cmluZywgcXVlcnlDb25mPzogYW55KSB7XG4gICAgaWYgKHRoaXMubmF2aWdhdGlvbkl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMubmF2aWdhdGlvbkl0ZW1zW3RoaXMubmF2aWdhdGlvbkl0ZW1zLmxlbmd0aCAtIDFdLnNldEZvcm1Sb3V0ZXMocm91dGVzKTtcbiAgICAgIHRoaXMubmF2aWdhdGlvbkl0ZW1zW3RoaXMubmF2aWdhdGlvbkl0ZW1zLmxlbmd0aCAtIDFdLmFjdGl2ZUZvcm1Nb2RlID0gYWN0aXZlTW9kZTtcbiAgICAgIGlmIChxdWVyeUNvbmYpIHtcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uSXRlbXNbdGhpcy5uYXZpZ2F0aW9uSXRlbXMubGVuZ3RoIC0gMV0ua2V5c1ZhbHVlcyA9IHF1ZXJ5Q29uZi5rZXlzVmFsdWVzO1xuICAgICAgICBkZWxldGUgcXVlcnlDb25mLmtleXNWYWx1ZXM7XG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkl0ZW1zW3RoaXMubmF2aWdhdGlvbkl0ZW1zLmxlbmd0aCAtIDFdLnF1ZXJ5Q29uZmlndXJhdGlvbiA9IE9iamVjdC5rZXlzKHF1ZXJ5Q29uZikubGVuZ3RoID4gMCA/IHF1ZXJ5Q29uZiA6IG51bGw7XG4gICAgICB9XG4gICAgICB0aGlzLnN0b3JlTmF2aWdhdGlvbigpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTdG9yZWREYXRhKCk6IGFueVtdIHtcbiAgICBjb25zdCBzdG9yYWdlRGF0YTogYW55ID0gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldENvbXBvbmVudFN0b3JhZ2UodGhpcyk7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgT2JqZWN0LmtleXMoc3RvcmFnZURhdGEpLmZvckVhY2goa2V5ID0+IHJlc3VsdC5wdXNoKG5ldyBPTmF2aWdhdGlvbkl0ZW0oc3RvcmFnZURhdGFba2V5XSkpKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgZ2V0UHJldmlvdXNSb3V0ZURhdGEoKTogT05hdmlnYXRpb25JdGVtIHtcbiAgICBsZXQgcmVzdWx0OiBPTmF2aWdhdGlvbkl0ZW07XG4gICAgY29uc3QgbGVuID0gdGhpcy5uYXZpZ2F0aW9uSXRlbXMubGVuZ3RoO1xuICAgIGlmIChsZW4gPj0gMikge1xuICAgICAgcmVzdWx0ID0gdGhpcy5uYXZpZ2F0aW9uSXRlbXNbbGVuIC0gMl07XG4gICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5mb3JtUm91dGVzICYmIHJlc3VsdC5mb3JtUm91dGVzLm1haW5Gb3JtTGF5b3V0TWFuYWdlckNvbXBvbmVudCAmJiB0aGlzLm5hdmlnYXRpb25JdGVtc1tsZW4gLSAzXSkge1xuICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLm5hdmlnYXRpb25JdGVtc1tsZW4gLSAzXTtcbiAgICAgICAgaWYgKHBhcmVudC5pc01haW5Gb3JtTGF5b3V0TWFuYWdlckNvbXBvbmVudCgpKSB7XG4gICAgICAgICAgcmVzdWx0ID0gcGFyZW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRoZSBtYWluIG5hdmlnYXRpb24gcm91dGUgZGF0YSB0aGF0IG1hdGNoZXMgdGhlIG1vc3Qgd2l0aCB0aGUgY3VycmVudCByb3V0ZVxuICAgKi9cbiAgZ2V0TGFzdE1haW5OYXZpZ2F0aW9uUm91dGVEYXRhKCk6IE9OYXZpZ2F0aW9uSXRlbSB7XG4gICAgY29uc3Qgcm91dGVNYXRjaGVzID0gW107XG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLm5hdmlnYXRpb25JdGVtcy5zbGljZSgpLnJldmVyc2UoKVxuICAgICAgLm1hcCgoaXRlbSwgaSkgPT4ge1xuICAgICAgICBsZXQgY3VycmVudExvY2F0aW9uID0gdGhpcy5sb2NhdGlvbi5wYXRoKCkuc3Vic3RyKDEpO1xuICAgICAgICBpZiAoY3VycmVudExvY2F0aW9uLmluY2x1ZGVzKCc/JykpIHtcbiAgICAgICAgICBjdXJyZW50TG9jYXRpb24gPSBjdXJyZW50TG9jYXRpb24uc3Vic3RyaW5nKDAsIGN1cnJlbnRMb2NhdGlvbi5pbmRleE9mKCc/JykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ29tcGFyZSBjdXJyZW50IHJvdXRlIHdpdGggaXRlbSByb3V0ZSBhbmQgY291bnQgc2VnbWVudCBtYXRjaGVzXG4gICAgICAgIGNvbnN0IGFycjEgPSBpdGVtLnVybC5zdWJzdHIoMSkuc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgYXJyMiA9IGN1cnJlbnRMb2NhdGlvbi5zcGxpdCgnLycpO1xuICAgICAgICBsZXQgcmVzdWx0ID0gMDtcbiAgICAgICAgbGV0IGluZGV4ID0gLTE7XG4gICAgICAgIHdoaWxlICgrK2luZGV4IDw9IGFycjEubGVuZ3RoICYmIGluZGV4IDw9IGFycjIubGVuZ3RoKSB7XG4gICAgICAgICAgcm91dGVNYXRjaGVzW2ldID0gKGFycjFbaW5kZXhdID09PSBhcnIyW2luZGV4XSkgPyByZXN1bHQrKyA6IHJlc3VsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSk7XG5cbiAgICBsZXQgbWF4TWF0Y2hlcyA9IHJvdXRlTWF0Y2hlcy5yZWR1Y2UoKGEsIGIpID0+IE1hdGgubWF4KGEsIGIpKTtcbiAgICBjb25zdCBsYXN0TmF2SXRlbSA9IHRoaXMubmF2aWdhdGlvbkl0ZW1zW3RoaXMubmF2aWdhdGlvbkl0ZW1zLmxlbmd0aCAtIDFdO1xuICAgIGlmICghbGFzdE5hdkl0ZW0uaXNNYWluTmF2aWdhdGlvbkNvbXBvbmVudCgpICYmICFsYXN0TmF2SXRlbS5pc01haW5Gb3JtTGF5b3V0TWFuYWdlckNvbXBvbmVudCgpKSB7XG4gICAgICBtYXhNYXRjaGVzLS07XG4gICAgfVxuICAgIGxldCBpdGVtUmVzdWx0ID0gdm9pZCAwO1xuICAgIHdoaWxlICghaXRlbVJlc3VsdCAmJiBtYXhNYXRjaGVzID49IDApIHtcbiAgICAgIGl0ZW1SZXN1bHQgPSBpdGVtcy5maW5kKChpdGVtLCBpKSA9PiAoaXRlbS5pc01haW5OYXZpZ2F0aW9uQ29tcG9uZW50KCkgfHwgaXRlbS5pc01haW5Gb3JtTGF5b3V0TWFuYWdlckNvbXBvbmVudCgpKSAmJiByb3V0ZU1hdGNoZXNbaV0gPT09IG1heE1hdGNoZXMpO1xuICAgICAgbWF4TWF0Y2hlcy0tO1xuICAgIH1cbiAgICByZXR1cm4gaXRlbVJlc3VsdDtcbiAgfVxuXG4gIHJlbW92ZUxhc3RJdGVtKCkge1xuICAgIHRoaXMubmF2aWdhdGlvbkl0ZW1zLnBvcCgpO1xuICAgIHRoaXMuc3RvcmVOYXZpZ2F0aW9uKCk7XG4gIH1cblxuICByZW1vdmVMYXN0SXRlbXNVbnRpbE1haW4oKSB7XG4gICAgY29uc3QgbGFzdE1haW4gPSB0aGlzLmdldExhc3RNYWluTmF2aWdhdGlvblJvdXRlRGF0YSgpO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQobGFzdE1haW4pKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5uYXZpZ2F0aW9uSXRlbXMuaW5kZXhPZihsYXN0TWFpbik7XG4gICAgdGhpcy5uYXZpZ2F0aW9uSXRlbXMgPSB0aGlzLm5hdmlnYXRpb25JdGVtcy5zbGljZSgwLCBpbmRleCArIDEpO1xuICAgIHRoaXMuc3RvcmVOYXZpZ2F0aW9uKCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc0N1cnJlbnRSb3V0ZShyb3V0ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgbGV0IGN1cnJlbnRSb3V0ZSA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnNuYXBzaG90LnVybDtcbiAgICBjdXJyZW50Um91dGUgPSBjdXJyZW50Um91dGUuc3BsaXQoJz8nKVswXTtcbiAgICByZXR1cm4gcm91dGUgPT09IGN1cnJlbnRSb3V0ZTtcbiAgfVxuXG4gIGdldExhc3RJdGVtKCk6IE9OYXZpZ2F0aW9uSXRlbSB7XG4gICAgbGV0IHJlc3VsdDtcbiAgICBpZiAodGhpcy5uYXZpZ2F0aW9uSXRlbXMubGVuZ3RoID4gMCkge1xuICAgICAgcmVzdWx0ID0gdGhpcy5uYXZpZ2F0aW9uSXRlbXNbdGhpcy5uYXZpZ2F0aW9uSXRlbXMubGVuZ3RoIC0gMV07XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBkZWxldGVBY3RpdmVGb3JtTW9kZShhcmc6IE9OYXZpZ2F0aW9uSXRlbSkge1xuICAgIGFyZy5kZWxldGVBY3RpdmVGb3JtTW9kZSgpO1xuICAgIHRoaXMuc3RvcmVOYXZpZ2F0aW9uKCk7XG4gIH1cblxufVxuIl19