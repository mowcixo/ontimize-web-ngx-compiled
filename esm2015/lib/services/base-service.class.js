import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Router } from '@angular/router';
import { Observable } from 'rxjs';
import { map, share } from 'rxjs/operators';
import { AppConfig } from '../config/app-config';
import { Codes } from '../util/codes';
import { LoginStorageService } from './login-storage.service';
import { OntimizeServiceResponseAdapter } from './ontimize/ontimize-service-response.adapter';
import { OntimizeServiceResponseParser } from './parser/o-service-response.parser';
export class BaseService {
    constructor(injector) {
        this.injector = injector;
        this.httpClient = this.injector.get(HttpClient);
        this.router = this.injector.get(Router);
        this._config = this.injector.get(AppConfig);
        this._appConfig = this._config.getConfiguration();
        this.responseParser = this.injector.get(OntimizeServiceResponseParser);
        this.loginStorageService = this.injector.get(LoginStorageService);
        this.configureAdapter();
    }
    configureAdapter() {
        this.adapter = this.injector.get(OntimizeServiceResponseAdapter);
    }
    configureService(config) {
        this._urlBase = config.urlBase ? config.urlBase : this._appConfig.apiEndpoint;
    }
    getDefaultServiceConfiguration(serviceName) {
        const configuration = this._config.getServiceConfiguration();
        let servConfig = {};
        if (serviceName && configuration.hasOwnProperty(serviceName)) {
            servConfig = configuration[serviceName];
        }
        servConfig[Codes.SESSION_KEY] = this.loginStorageService.getSessionInfo();
        return servConfig;
    }
    get urlBase() {
        return this._urlBase;
    }
    set urlBase(value) {
        this._urlBase = value;
    }
    doRequest(param) {
        const dataObservable = new Observable((observer) => {
            const options = param.options || {
                headers: this.buildHeaders()
            };
            options.observe = 'response';
            let requestObs;
            switch (param.method) {
                case 'GET':
                    requestObs = this.httpClient.get(param.url, options);
                    break;
                case 'PUT':
                    requestObs = this.httpClient.put(param.url, param.body, options);
                    break;
                case 'DELETE':
                    const deleteOptions = {
                        headers: options.headers,
                        body: param.body
                    };
                    deleteOptions.observe = 'response';
                    requestObs = this.httpClient.delete(param.url, deleteOptions);
                    break;
                case 'POST':
                default:
                    requestObs = this.httpClient.post(param.url, param.body, options);
                    break;
            }
            requestObs.pipe(map((data) => this.adapter.adapt(data))).subscribe(resp => {
                (param.successCallback || this.parseSuccessfulResponse).bind(this)(resp, observer);
            }, error => {
                (param.errorCallBack || this.parseUnsuccessfulResponse).bind(this)(error, observer);
            }, () => observer.complete());
        });
        return dataObservable.pipe(share());
    }
    buildHeaders() {
        return new HttpHeaders({
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json;charset=UTF-8'
        });
    }
    clientErrorFallback(errorCode) {
    }
    serverErrorFallback(errorCode) {
    }
    parseSuccessfulResponse(resp, observer) {
        this.responseParser.parseSuccessfulResponse(resp, observer, this);
    }
    parseSuccessfulQueryResponse(resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    }
    parseSuccessfulAdvancedQueryResponse(resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    }
    parseSuccessfulInsertResponse(resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    }
    parseSuccessfulUpdateResponse(resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    }
    parseSuccessfulDeleteResponse(resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    }
    parseUnsuccessfulResponse(error, observer) {
        this.responseParser.parseUnsuccessfulResponse(error, observer, this);
    }
    parseUnsuccessfulQueryResponse(resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    }
    parseUnsuccessfulAdvancedQueryResponse(resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    }
    parseUnsuccessfulInsertResponse(resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    }
    parseUnsuccessfulUpdateResponse(resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    }
    parseUnsuccessfulDeleteResponse(resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1zZXJ2aWNlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iYXNlLXNlcnZpY2UuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFVBQVUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQU1qRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXRDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQzlGLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBRW5GLE1BQU0sT0FBTyxXQUFXO0lBWXRCLFlBQXNCLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDdEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENB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LENBQUM7SUFFUywrQkFBK0IsQ0FBQyxJQUFxQixFQUFFLFFBQXFDO1FBQ3BHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUVGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7IFNlcnZpY2VSZXNwb25zZUFkYXB0ZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3NlcnZpY2UtcmVzcG9uc2UtYWRhcHRlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VydmljZVJlc3BvbnNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zZXJ2aWNlLXJlc3BvbnNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBIdHRwUmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuLi90eXBlcy9jb25maWcudHlwZSc7XG5pbXBvcnQgeyBTZXJ2aWNlUmVxdWVzdFBhcmFtIH0gZnJvbSAnLi4vdHlwZXMvc2VydmljZS1yZXF1ZXN0LXBhcmFtLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlUmVzcG9uc2UgfSBmcm9tICcuL2Jhc2Utc2VydmljZS1yZXNwb25zZS5jbGFzcyc7XG5pbXBvcnQgeyBMb2dpblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sb2dpbi1zdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgT250aW1pemVTZXJ2aWNlUmVzcG9uc2VBZGFwdGVyIH0gZnJvbSAnLi9vbnRpbWl6ZS9vbnRpbWl6ZS1zZXJ2aWNlLXJlc3BvbnNlLmFkYXB0ZXInO1xuaW1wb3J0IHsgT250aW1pemVTZXJ2aWNlUmVzcG9uc2VQYXJzZXIgfSBmcm9tICcuL3BhcnNlci9vLXNlcnZpY2UtcmVzcG9uc2UucGFyc2VyJztcblxuZXhwb3J0IGNsYXNzIEJhc2VTZXJ2aWNlIHtcblxuICBwcm90ZWN0ZWQgaHR0cENsaWVudDogSHR0cENsaWVudDtcbiAgcHJvdGVjdGVkIHJvdXRlcjogUm91dGVyO1xuXG4gIHByb3RlY3RlZCBfdXJsQmFzZTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX2FwcENvbmZpZzogQ29uZmlnO1xuICBwcm90ZWN0ZWQgX2NvbmZpZzogQXBwQ29uZmlnO1xuICBwcm90ZWN0ZWQgcmVzcG9uc2VQYXJzZXI6IE9udGltaXplU2VydmljZVJlc3BvbnNlUGFyc2VyO1xuICBwcm90ZWN0ZWQgbG9naW5TdG9yYWdlU2VydmljZTogTG9naW5TdG9yYWdlU2VydmljZTtcbiAgcHJvdGVjdGVkIGFkYXB0ZXI6IFNlcnZpY2VSZXNwb25zZUFkYXB0ZXI8QmFzZVNlcnZpY2VSZXNwb25zZT47XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMuaHR0cENsaWVudCA9IHRoaXMuaW5qZWN0b3IuZ2V0KEh0dHBDbGllbnQpO1xuICAgIHRoaXMucm91dGVyID0gdGhpcy5pbmplY3Rvci5nZXQoUm91dGVyKTtcbiAgICB0aGlzLl9jb25maWcgPSB0aGlzLmluamVjdG9yLmdldChBcHBDb25maWcpO1xuICAgIHRoaXMuX2FwcENvbmZpZyA9IHRoaXMuX2NvbmZpZy5nZXRDb25maWd1cmF0aW9uKCk7XG4gICAgdGhpcy5yZXNwb25zZVBhcnNlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KE9udGltaXplU2VydmljZVJlc3BvbnNlUGFyc2VyKTtcbiAgICB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2dpblN0b3JhZ2VTZXJ2aWNlKTtcbiAgICB0aGlzLmNvbmZpZ3VyZUFkYXB0ZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maWd1cmVBZGFwdGVyKCkge1xuICAgIHRoaXMuYWRhcHRlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KE9udGltaXplU2VydmljZVJlc3BvbnNlQWRhcHRlcik7XG4gIH1cblxuICBwdWJsaWMgY29uZmlndXJlU2VydmljZShjb25maWc6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuX3VybEJhc2UgPSBjb25maWcudXJsQmFzZSA/IGNvbmZpZy51cmxCYXNlIDogdGhpcy5fYXBwQ29uZmlnLmFwaUVuZHBvaW50O1xuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRTZXJ2aWNlQ29uZmlndXJhdGlvbihzZXJ2aWNlTmFtZT86IHN0cmluZyk6IGFueSB7XG4gICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHRoaXMuX2NvbmZpZy5nZXRTZXJ2aWNlQ29uZmlndXJhdGlvbigpO1xuICAgIGxldCBzZXJ2Q29uZmlnID0ge307XG4gICAgaWYgKHNlcnZpY2VOYW1lICYmIGNvbmZpZ3VyYXRpb24uaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7XG4gICAgICBzZXJ2Q29uZmlnID0gY29uZmlndXJhdGlvbltzZXJ2aWNlTmFtZV07XG4gICAgfVxuICAgIHNlcnZDb25maWdbQ29kZXMuU0VTU0lPTl9LRVldID0gdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlLmdldFNlc3Npb25JbmZvKCk7XG4gICAgcmV0dXJuIHNlcnZDb25maWc7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHVybEJhc2UoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fdXJsQmFzZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgdXJsQmFzZSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fdXJsQmFzZSA9IHZhbHVlO1xuICB9XG5cbiAgcHVibGljIGRvUmVxdWVzdChwYXJhbTogU2VydmljZVJlcXVlc3RQYXJhbSk6IE9ic2VydmFibGU8U2VydmljZVJlc3BvbnNlPiB7XG5cbiAgICBjb25zdCBkYXRhT2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxTZXJ2aWNlUmVzcG9uc2U+ID0gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pID0+IHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBwYXJhbS5vcHRpb25zIHx8IHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZEhlYWRlcnMoKVxuICAgICAgfTtcbiAgICAgIG9wdGlvbnMub2JzZXJ2ZSA9ICdyZXNwb25zZSc7XG4gICAgICBsZXQgcmVxdWVzdE9iczogT2JzZXJ2YWJsZTxTZXJ2aWNlUmVzcG9uc2U+O1xuICAgICAgc3dpdGNoIChwYXJhbS5tZXRob2QpIHtcbiAgICAgICAgY2FzZSAnR0VUJzpcbiAgICAgICAgICByZXF1ZXN0T2JzID0gdGhpcy5odHRwQ2xpZW50LmdldDxTZXJ2aWNlUmVzcG9uc2U+KHBhcmFtLnVybCwgb3B0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ1BVVCc6XG4gICAgICAgICAgcmVxdWVzdE9icyA9IHRoaXMuaHR0cENsaWVudC5wdXQ8U2VydmljZVJlc3BvbnNlPihwYXJhbS51cmwsIHBhcmFtLmJvZHksIG9wdGlvbnMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdERUxFVEUnOlxuICAgICAgICAgIGNvbnN0IGRlbGV0ZU9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgIGhlYWRlcnM6IG9wdGlvbnMuaGVhZGVycyxcbiAgICAgICAgICAgIGJvZHk6IHBhcmFtLmJvZHlcbiAgICAgICAgICB9O1xuICAgICAgICAgIGRlbGV0ZU9wdGlvbnMub2JzZXJ2ZSA9ICdyZXNwb25zZSc7XG4gICAgICAgICAgcmVxdWVzdE9icyA9IHRoaXMuaHR0cENsaWVudC5kZWxldGU8U2VydmljZVJlc3BvbnNlPihwYXJhbS51cmwsIGRlbGV0ZU9wdGlvbnMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdQT1NUJzpcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXF1ZXN0T2JzID0gdGhpcy5odHRwQ2xpZW50LnBvc3Q8U2VydmljZVJlc3BvbnNlPihwYXJhbS51cmwsIHBhcmFtLmJvZHksIG9wdGlvbnMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXF1ZXN0T2JzLnBpcGUoXG4gICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB0aGlzLmFkYXB0ZXIuYWRhcHQoZGF0YSkpXG4gICAgICApLnN1YnNjcmliZShyZXNwID0+IHtcbiAgICAgICAgKHBhcmFtLnN1Y2Nlc3NDYWxsYmFjayB8fCB0aGlzLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKS5iaW5kKHRoaXMpKHJlc3AsIG9ic2VydmVyKTtcbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgKHBhcmFtLmVycm9yQ2FsbEJhY2sgfHwgdGhpcy5wYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKS5iaW5kKHRoaXMpKGVycm9yLCBvYnNlcnZlcik7XG4gICAgICB9LCAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YU9ic2VydmFibGUucGlwZShzaGFyZSgpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEhlYWRlcnMoKTogSHR0cEhlYWRlcnMge1xuICAgIHJldHVybiBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04J1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGNsaWVudEVycm9yRmFsbGJhY2soZXJyb3JDb2RlOiBudW1iZXIpIHtcblxuICB9XG5cbiAgcHVibGljIHNlcnZlckVycm9yRmFsbGJhY2soZXJyb3JDb2RlOiBudW1iZXIpIHtcblxuICB9XG5cbiAgLypcbiAgICogU3VjY2Vzc2Z1bCByZXNwb25zZSBwYXJzZXJzLCB0aGVyZSBpcyBvbmUgcGFyc2VyIGZvciBlYWNoIENSVUQgbWV0aG9kIHdoaWNoIGNhbGxzIHRvIHRoZSBjb21tb24gcGFyc2VyLlxuICAgKiBVc2VyIGNhbiBvdmVyd3JpdGUgdGhlIGNob3NlbiBtZXRob2RzIHBhcnNlcnMgb3IgdGhlIGNvbW1vbiBwYXJzZXJcbiAgICovXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnJlc3BvbnNlUGFyc2VyLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyLCB0aGlzKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxRdWVyeVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bEFkdmFuY2VkUXVlcnlSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxJbnNlcnRSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxVcGRhdGVSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxEZWxldGVSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIC8qXG4gICAqIFVuc3VjY2Vzc2Z1bCByZXNwb25zZSBwYXJzZXJzLCB0aGVyZSBpcyBvbmUgcGFyc2VyIGZvciBlYWNoIENSVUQgbWV0aG9kIHdoaWNoIGNhbGxzIHRvIHRoZSBjb21tb24gcGFyc2VyLlxuICAgKiBVc2VyIGNhbiBvdmVyd3JpdGUgdGhlIGNob3NlbiBtZXRob2RzIHBhcnNlcnMgb3IgdGhlIGNvbW1vbiBwYXJzZXJcbiAgICovXG4gIHByb3RlY3RlZCBwYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKGVycm9yOiBhbnksIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnJlc3BvbnNlUGFyc2VyLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UoZXJyb3IsIG9ic2VydmVyLCB0aGlzKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVVuc3VjY2Vzc2Z1bFF1ZXJ5UmVzcG9uc2UocmVzcDogU2VydmljZVJlc3BvbnNlLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSB7XG4gICAgdGhpcy5wYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVVuc3VjY2Vzc2Z1bEFkdmFuY2VkUXVlcnlSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlVW5zdWNjZXNzZnVsSW5zZXJ0UmVzcG9uc2UocmVzcDogU2VydmljZVJlc3BvbnNlLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSB7XG4gICAgdGhpcy5wYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVVuc3VjY2Vzc2Z1bFVwZGF0ZVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VVbnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCBvYnNlcnZlcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VVbnN1Y2Nlc3NmdWxEZWxldGVSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbn1cbiJdfQ==