import { OFormValue } from '../components/form/OFormValue';
import { Codes } from './codes';
import { SQLTypes } from './sqltypes';
import { Util } from './util';
export class ServiceUtils {
    static getParentKeysFromForm(parentKeysObject, form) {
        const result = {};
        const ownKeys = Object.keys(parentKeysObject || {});
        const formComponents = form ? form.getComponents() : {};
        const existsComponents = Object.keys(formComponents).length > 0;
        const formDataProperties = form ? form.getDataValues() : {};
        const existsProperties = Object.keys(formDataProperties).length > 0;
        const urlData = form ? form.getFormNavigation().getFilterFromUrlParams() : {};
        const existsUrlData = Object.keys(urlData).length > 0;
        if (existsUrlData) {
            form.keysArray.forEach((key, i) => {
                if (urlData.hasOwnProperty(key)) {
                    urlData[key] = SQLTypes.parseUsingSQLType(urlData[key], form.keysSqlTypesArray[i]);
                }
            });
        }
        if (existsComponents || existsProperties || existsUrlData) {
            ownKeys.forEach(ownKey => {
                const keyValue = parentKeysObject[ownKey];
                const isEquivObject = Util.isObject(keyValue);
                const formFieldAttr = isEquivObject ? Object.keys(keyValue)[0] : keyValue;
                let currentData;
                if (formComponents.hasOwnProperty(formFieldAttr)) {
                    const component = formComponents[formFieldAttr];
                    if ('getSelectedRecord' in component && isEquivObject) {
                        currentData = (component.getSelectedRecord() || {})[keyValue[formFieldAttr]];
                    }
                    else {
                        currentData = component.getValue();
                    }
                }
                else if (formDataProperties.hasOwnProperty(formFieldAttr)) {
                    const formPropValue = formDataProperties[formFieldAttr];
                    currentData = formPropValue instanceof OFormValue ? formPropValue.value : formPropValue;
                }
                else if (urlData.hasOwnProperty(formFieldAttr)) {
                    currentData = urlData[formFieldAttr];
                }
                if (Util.isDefined(currentData)) {
                    switch (typeof (currentData)) {
                        case 'string':
                            if (currentData.trim().length > 0) {
                                result[ownKey] = currentData.trim();
                            }
                            break;
                        case 'number':
                            if (!isNaN(currentData)) {
                                result[ownKey] = currentData;
                            }
                            break;
                    }
                }
            });
        }
        return result;
    }
    static filterContainsAllParentKeys(parentKeysFilter, parentKeys) {
        const pkKeys = Object.keys(parentKeys);
        if ((pkKeys.length > 0) && Util.isDefined(parentKeysFilter)) {
            const parentKeysFilterKeys = Object.keys(parentKeysFilter);
            return pkKeys.every(a => parentKeysFilterKeys.indexOf(a) !== -1);
        }
        return true;
    }
    static getFilterUsingParentKeys(parentItem, parentKeysObject) {
        const filter = {};
        const ownKeys = Object.keys(parentKeysObject);
        if (ownKeys.length > 0 && Util.isDefined(parentItem)) {
            ownKeys.forEach(ownKey => {
                const parentKey = parentKeysObject[ownKey];
                if (parentItem.hasOwnProperty(parentKey)) {
                    let currentData = parentItem[parentKey];
                    if (currentData instanceof OFormValue) {
                        currentData = currentData.value;
                    }
                    filter[ownKey] = currentData;
                }
            });
        }
        return filter;
    }
    static getArrayProperties(array, properties) {
        const result = array.map(item => {
            return ServiceUtils.getObjectProperties(item, properties);
        });
        return result;
    }
    static getObjectProperties(object, properties) {
        const objectProperties = {};
        properties.forEach(key => {
            objectProperties[key] = object[key];
        });
        return objectProperties;
    }
    static parseSortColumns(sortColumns) {
        const sortColArray = [];
        if (sortColumns) {
            const cols = Util.parseArray(sortColumns);
            cols.forEach(col => {
                const colDef = col.split(Codes.TYPE_SEPARATOR);
                if (colDef.length > 0) {
                    const colName = colDef[0];
                    const colSort = colDef[1] || Codes.ASC_SORT;
                    sortColArray.push({
                        columnName: colName,
                        ascendent: colSort === Codes.ASC_SORT
                    });
                }
            });
        }
        return sortColArray;
    }
    static redirectLogin(router, sessionExpired = false) {
        const arg = {};
        arg[Codes.SESSION_EXPIRED_KEY] = sessionExpired;
        const extras = {};
        extras[Codes.QUERY_PARAMS] = arg;
        router.navigate([Codes.LOGIN_ROUTE], extras);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS51dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvdXRpbC9zZXJ2aWNlLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUU5QixNQUFNLE9BQU8sWUFBWTtJQUV2QixNQUFNLENBQUMscUJBQXFCLENBQUMsZ0JBQXdCLEVBQUUsSUFBb0I7UUFDekUsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLElBQUksRUFBRSxDQUFDLENBQUM7UUFFcEQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUN4RCxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoRSxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDNUQsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVwRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLHNCQUFzQixFQUFFLENBQUMsQ0FBQyxDQUFDLEVB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dEMsQ0FBQyxDQUFDO2lCQUNKO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRCxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQWMsRUFBRSxpQkFBMEIsS0FBSztRQUNsRSxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixHQUFHLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsY0FBYyxDQUFDO1FBQ2hELE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNqQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQy9DLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IE9Gb3JtQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtL28tZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHsgT0Zvcm1WYWx1ZSB9IGZyb20gJy4uL2NvbXBvbmVudHMvZm9ybS9PRm9ybVZhbHVlJztcbmltcG9ydCB7IFNRTE9yZGVyIH0gZnJvbSAnLi4vdHlwZXMvc3FsLW9yZGVyLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuL2NvZGVzJztcbmltcG9ydCB7IFNRTFR5cGVzIH0gZnJvbSAnLi9zcWx0eXBlcyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IGNsYXNzIFNlcnZpY2VVdGlscyB7XG5cbiAgc3RhdGljIGdldFBhcmVudEtleXNGcm9tRm9ybShwYXJlbnRLZXlzT2JqZWN0OiBvYmplY3QsIGZvcm06IE9Gb3JtQ29tcG9uZW50KSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgb3duS2V5cyA9IE9iamVjdC5rZXlzKHBhcmVudEtleXNPYmplY3QgfHwge30pO1xuXG4gICAgY29uc3QgZm9ybUNvbXBvbmVudHMgPSBmb3JtID8gZm9ybS5nZXRDb21wb25lbnRzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNDb21wb25lbnRzID0gT2JqZWN0LmtleXMoZm9ybUNvbXBvbmVudHMpLmxlbmd0aCA+IDA7XG5cbiAgICBjb25zdCBmb3JtRGF0YVByb3BlcnRpZXMgPSBmb3JtID8gZm9ybS5nZXREYXRhVmFsdWVzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNQcm9wZXJ0aWVzID0gT2JqZWN0LmtleXMoZm9ybURhdGFQcm9wZXJ0aWVzKS5sZW5ndGggPiAwO1xuXG4gICAgY29uc3QgdXJsRGF0YSA9IGZvcm0gPyBmb3JtLmdldEZvcm1OYXZpZ2F0aW9uKCkuZ2V0RmlsdGVyRnJvbVVybFBhcmFtcygpIDoge307XG4gICAgY29uc3QgZXhpc3RzVXJsRGF0YSA9IE9iamVjdC5rZXlzKHVybERhdGEpLmxlbmd0aCA+IDA7XG4gICAgaWYgKGV4aXN0c1VybERhdGEpIHtcbiAgICAgIGZvcm0ua2V5c0FycmF5LmZvckVhY2goKGtleTogc3RyaW5nLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIHVybERhdGFba2V5XSA9IFNRTFR5cGVzLnBhcnNlVXNpbmdTUUxUeXBlKHVybERhdGFba2V5XSwgZm9ybS5rZXlzU3FsVHlwZXNBcnJheVtpXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChleGlzdHNDb21wb25lbnRzIHx8IGV4aXN0c1Byb3BlcnRpZXMgfHwgZXhpc3RzVXJsRGF0YSkge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICAvLyBQYXJlbnQga2V5IGVxdWl2YWxlbmNlIG1heSBiZSBhbiBvYmplY3RcbiAgICAgICAgY29uc3QgaXNFcXVpdk9iamVjdCA9IFV0aWwuaXNPYmplY3Qoa2V5VmFsdWUpO1xuICAgICAgICBjb25zdCBmb3JtRmllbGRBdHRyID0gaXNFcXVpdk9iamVjdCA/IE9iamVjdC5rZXlzKGtleVZhbHVlKVswXSA6IGtleVZhbHVlO1xuICAgICAgICBsZXQgY3VycmVudERhdGE7XG4gICAgICAgIGlmIChmb3JtQ29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGZvcm1Db21wb25lbnRzW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICAgIC8vIElzIHNlcnZpY2UgY29tcG9uZW50IChjb21ibywgbGlzdHBpY2tlciwgcmFkaW8pXG4gICAgICAgICAgaWYgKCdnZXRTZWxlY3RlZFJlY29yZCcgaW4gY29tcG9uZW50ICYmIGlzRXF1aXZPYmplY3QpIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gKChjb21wb25lbnQgYXMgYW55KS5nZXRTZWxlY3RlZFJlY29yZCgpIHx8IHt9KVtrZXlWYWx1ZVtmb3JtRmllbGRBdHRyXV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gY29tcG9uZW50LmdldFZhbHVlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGZvcm1EYXRhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGZvcm1Qcm9wVmFsdWUgPSBmb3JtRGF0YVByb3BlcnRpZXNbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgICAgY3VycmVudERhdGEgPSBmb3JtUHJvcFZhbHVlIGluc3RhbmNlb2YgT0Zvcm1WYWx1ZSA/IGZvcm1Qcm9wVmFsdWUudmFsdWUgOiBmb3JtUHJvcFZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjdXJyZW50RGF0YSA9IHVybERhdGFbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFV0aWwuaXNEZWZpbmVkKGN1cnJlbnREYXRhKSkge1xuICAgICAgICAgIHN3aXRjaCAodHlwZW9mIChjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICAgIGlmIChjdXJyZW50RGF0YS50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdFtvd25LZXldID0gY3VycmVudERhdGEudHJpbSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgICAgaWYgKCFpc05hTihjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRbb3duS2V5XSA9IGN1cnJlbnREYXRhO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgZmlsdGVyQ29udGFpbnNBbGxQYXJlbnRLZXlzKHBhcmVudEtleXNGaWx0ZXIsIHBhcmVudEtleXMpOiBib29sZWFuIHtcbiAgICBjb25zdCBwa0tleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzKTtcbiAgICBpZiAoKHBrS2V5cy5sZW5ndGggPiAwKSAmJiBVdGlsLmlzRGVmaW5lZChwYXJlbnRLZXlzRmlsdGVyKSkge1xuICAgICAgY29uc3QgcGFyZW50S2V5c0ZpbHRlcktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzRmlsdGVyKTtcbiAgICAgIHJldHVybiBwa0tleXMuZXZlcnkoYSA9PiBwYXJlbnRLZXlzRmlsdGVyS2V5cy5pbmRleE9mKGEpICE9PSAtMSk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgc3RhdGljIGdldEZpbHRlclVzaW5nUGFyZW50S2V5cyhwYXJlbnRJdGVtOiBhbnksIHBhcmVudEtleXNPYmplY3Q6IG9iamVjdCkge1xuICAgIGNvbnN0IGZpbHRlciA9IHt9O1xuICAgIGNvbnN0IG93bktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzT2JqZWN0KTtcbiAgICBpZiAob3duS2V5cy5sZW5ndGggPiAwICYmIFV0aWwuaXNEZWZpbmVkKHBhcmVudEl0ZW0pKSB7XG4gICAgICBvd25LZXlzLmZvckVhY2gob3duS2V5ID0+IHtcbiAgICAgICAgY29uc3QgcGFyZW50S2V5ID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICBpZiAocGFyZW50SXRlbS5oYXNPd25Qcm9wZXJ0eShwYXJlbnRLZXkpKSB7XG4gICAgICAgICAgbGV0IGN1cnJlbnREYXRhID0gcGFyZW50SXRlbVtwYXJlbnRLZXldO1xuICAgICAgICAgIGlmIChjdXJyZW50RGF0YSBpbnN0YW5jZW9mIE9Gb3JtVmFsdWUpIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gY3VycmVudERhdGEudmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZpbHRlcltvd25LZXldID0gY3VycmVudERhdGE7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZmlsdGVyO1xuICB9XG5cbiAgc3RhdGljIGdldEFycmF5UHJvcGVydGllcyhhcnJheTogYW55W10sIHByb3BlcnRpZXM6IGFueVtdKTogYW55W10ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGFycmF5Lm1hcChpdGVtID0+IHtcbiAgICAgIHJldHVybiBTZXJ2aWNlVXRpbHMuZ2V0T2JqZWN0UHJvcGVydGllcyhpdGVtLCBwcm9wZXJ0aWVzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIGdldE9iamVjdFByb3BlcnRpZXMob2JqZWN0OiBhbnksIHByb3BlcnRpZXM6IGFueVtdKTogYW55IHtcbiAgICBjb25zdCBvYmplY3RQcm9wZXJ0aWVzID0ge307XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBvYmplY3RQcm9wZXJ0aWVzW2tleV0gPSBvYmplY3Rba2V5XTtcbiAgICB9KTtcbiAgICByZXR1cm4gb2JqZWN0UHJvcGVydGllcztcbiAgfVxuXG4gIHN0YXRpYyBwYXJzZVNvcnRDb2x1bW5zKHNvcnRDb2x1bW5zOiBzdHJpbmcpOiBBcnJheTxTUUxPcmRlcj4ge1xuICAgIGNvbnN0IHNvcnRDb2xBcnJheSA9IFtdO1xuICAgIGlmIChzb3J0Q29sdW1ucykge1xuICAgICAgY29uc3QgY29scyA9IFV0aWwucGFyc2VBcnJheShzb3J0Q29sdW1ucyk7XG4gICAgICBjb2xzLmZvckVhY2goY29sID0+IHtcbiAgICAgICAgY29uc3QgY29sRGVmID0gY29sLnNwbGl0KENvZGVzLlRZUEVfU0VQQVJBVE9SKTtcbiAgICAgICAgaWYgKGNvbERlZi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgY29sTmFtZSA9IGNvbERlZlswXTtcbiAgICAgICAgICBjb25zdCBjb2xTb3J0ID0gY29sRGVmWzFdIHx8IENvZGVzLkFTQ19TT1JUO1xuICAgICAgICAgIHNvcnRDb2xBcnJheS5wdXNoKHtcbiAgICAgICAgICAgIGNvbHVtbk5hbWU6IGNvbE5hbWUsXG4gICAgICAgICAgICBhc2NlbmRlbnQ6IGNvbFNvcnQgPT09IENvZGVzLkFTQ19TT1JUXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc29ydENvbEFycmF5O1xuICB9XG5cbiAgc3RhdGljIHJlZGlyZWN0TG9naW4ocm91dGVyOiBSb3V0ZXIsIHNlc3Npb25FeHBpcmVkOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBjb25zdCBhcmcgPSB7fTtcbiAgICBhcmdbQ29kZXMuU0VTU0lPTl9FWFBJUkVEX0tFWV0gPSBzZXNzaW9uRXhwaXJlZDtcbiAgICBjb25zdCBleHRyYXMgPSB7fTtcbiAgICBleHRyYXNbQ29kZXMuUVVFUllfUEFSQU1TXSA9IGFyZztcbiAgICByb3V0ZXIubmF2aWdhdGUoW0NvZGVzLkxPR0lOX1JPVVRFXSwgZXh0cmFzKTtcbiAgfVxuXG59XG4iXX0=